# 接口设计专题

> 本文档深入探讨 RESTful API 设计的核心原则和最佳实践。

## 接口设计流程

```mermaid
%%{init: {'theme': 'base', 'themeVariables': {
  'primaryColor': '#EFF6FF',
  'primaryTextColor': '#1e3a8a',
  'primaryBorderColor': '#3B82F6',
  'lineColor': '#6B7280'
}}}%%
flowchart TB
    Start([需求分析]) ==> Analyze[🔍 分析资源]
    Analyze ==> Identify[识别实体和关系]

    Identify ==> Design[📝 设计URI]
    Design ==> D1[资源命名]
    Design ==> D2[层级结构]

    D1 --> Method[🔧 选择HTTP方法]
    Method --> M1[GET 查询]
    Method --> M2[POST 创建]
    Method --> M3[PUT 更新]
    Method --> M4[DELETE 删除]

    M1 --> Params[⚙️ 设计参数]
    M2 --> Params
    M3 --> Params
    M4 --> Params

    Params --> P1[路径参数]
    Params --> P2[查询参数]
    Params --> P3[请求体]

    P1 --> Response[📤 设计响应]
    P2 --> Response
    P3 --> Response

    Response --> R1[成功响应]
    Response --> R2[错误响应]

    R1 --> Document[📚 编写文档]
    R2 --> Document

    Document --> Complete([完成设计])

    classDef startEnd fill:#3B82F6,stroke:#2563EB,color:#fff,stroke-width:2px
    classDef phase fill:#D1FAE5,stroke:#10B981,stroke-width:2px,color:#065f46
    classDef task fill:#fff,stroke:#60A5FA,stroke-width:1px,color:#1e3a8a
    classDef method fill:#FEF3C7,stroke:#F59E0B,stroke-width:2px,color:#92400e

    class Start,Complete startEnd
    class Analyze,Identify,Design,Params,Response,Document phase
    class D1,D2,P1,P2,P3,R1,R2 task
    class Method,M1,M2,M3,M4 method
```

## 接口调用时序

```mermaid
sequenceDiagram
    autonumber
    participant Client as 🎨 客户端
    participant Router as 🔀 路由层
    participant Controller as 🎮 控制器
    participant Service as ⚙️ 服务层
    participant DAO as 💾 数据访问层
    participant DB as 🗄️ 数据库

    Client->>Router: HTTP请求
    Note over Client,Router: GET /api/users/1

    Router->>Controller: 路由匹配
    Note over Router,Controller: 提取路径参数 user_id=1

    Controller->>Controller: 参数验证
    Note over Controller: Pydantic验证

    Controller->>Service: 调用业务逻辑
    Service->>DAO: 查询数据
    DAO->>DB: SQL查询
    DB-->>DAO: 返回数据
    DAO-->>Service: DO对象
    Service-->>Controller: VO对象

    Controller->>Controller: 数据序列化
    Note over Controller: 转换为JSON

    Controller-->>Client: HTTP响应
    Note over Controller,Client: {code:200, msg:"success", data:{...}}
```

## URI 层级结构 

```mermaid
graph TB
    subgraph API[API根路径]
        direction TB
        V1[版本 v1]
        V2[版本 v2]

        subgraph V1_Resource[v1 资源]
            Users[users 用户]
            Orders[orders 订单]
            Products[products 商品]
        end

        subgraph V2_Resource[v2 资源]
            Users2[users 用户]
            Orders2[orders 订单]
            Products2[products 商品]
        end

        Users --> U1[用户ID详情]
        Users --> U2[用户订单列表]
        Users --> U3[用户资料]

        Orders --> O1[订单ID详情]
        Orders --> O2[订单商品列表]
        Orders --> O3[待处理订单]

        Products --> P1[商品ID详情]
        Products --> P2[商品评论]
        Products --> P3[分类商品]
    end

    API --> V1
    API --> V2
    V1 --> V1_Resource
    V2 --> V2_Resource
```

## RESTful 设计规范

### HTTP 方法语义

| 方法 | 语义 | 是否幂等 | 示例 |
|-----|------|---------|------|
| GET | 获取资源 | 是 | GET /users |
| POST | 创建资源 | 否 | POST /users |
| PUT | 完整更新资源 | 是 | PUT /users/1 |
| PATCH | 部分更新资源 | 否 | PATCH /users/1 |
| DELETE | 删除资源 | 是 | DELETE /users/1 |

### URI 设计原则

```mermaid
mindmap
  root((URI设计原则))
    资源命名
      使用名词
      复数形式
      小写字母
      连字符分隔
    层级结构
      从属关系
        /users/1/orders
      嵌套层级≤3
      避免深层嵌套
    特殊操作
      使用查询参数
        /users?status=active
      使用动词子资源
        /users/1/activate
      避免动词在路径中
    版本管理
      URL版本
        /api/v1/users
      Header版本
        Accept: application/vnd.api.v1+json
      向后兼容
```

## 统一响应格式

```mermaid
graph TB
    subgraph 成功响应[成功响应 200]
        S1[code: 200]
        S2[msg: success]
        S3[data: 数据对象]
        S4[timestamp: 时间戳]
    end

    subgraph 错误响应[错误响应 4xx/5xx]
        E1[code: 400/500]
        E2[msg: 错误描述]
        E3[data: null]
        E4[timestamp: 时间戳]
    end

    subgraph 分页响应[分页响应]
        P1[code: 200]
        P2[msg: success]
        P3[rows: 数据列表]
        P4[total: 总数]
    end
```

### 响应格式示例

#### 成功响应
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com"
  },
  "timestamp": 1234567890
}
```

#### 错误响应
```json
{
  "code": 400,
  "msg": "参数验证失败",
  "data": null,
  "timestamp": 1234567890
}
```

#### 分页响应
```json
{
  "code": 200,
  "msg": "success",
  "rows": [
    {"id": 1, "name": "商品1"},
    {"id": 2, "name": "商品2"}
  ],
  "total": 100
}
```

## 接口设计模式

### 1. CRUD 标准模式

```mermaid
flowchart LR
    Resource[资源: users] --> Create[POST /users<br/>创建]
    Resource --> Read[GET /users<br/>列表]
    Resource --> ReadOne[GET /users/:id<br/>详情]
    Resource --> Update[PUT /users/:id<br/>更新]
    Resource --> Delete[DELETE /users/:id<br/>删除]
```

### 2. 分页模式

```mermaid
flowchart LR
    Request[请求] --> Params[参数]
    Params --> Page[page: 页码]
    Params --> Size[size: 每页数量]
    Params --> Sort[sort: 排序]
    Params --> Filter[filter: 过滤]

    Page --> Response[响应]
    Size --> Response
    Sort --> Response
    Filter --> Response

    Response --> Rows[rows: 数据列表]
    Response --> Total[total: 总数]
    Response --> Page2[page: 当前页]
    Response --> PageSize[pageSize: 每页数量]

```

### 3. 批量操作模式 

```mermaid
flowchart TB
    Batch[批量操作] --> BatchCreate[批量创建]
    Batch --> BatchUpdate[批量更新]
    Batch --> BatchDelete[批量删除]

    BatchCreate --> BC[POST /users/batch<br/>body: 对象数组]
    BatchUpdate --> BU[PUT /users/batch<br/>body: 更新对象数组]
    BatchDelete --> BD[DELETE /users/batch<br/>body: ID数组]

    BC --> Result[响应: 包含成功和失败列表]
    BU --> Result
    BD --> Result
```

### 4. 树形结构模式

```mermaid
graph TB
    Root[根节点 /tree] --> Option1[查询参数 strategy]
    Option1 --> S1[adjacency 邻接表]
    Option1 --> S2[path 物化路径]
    Option1 --> S3[nested_set 嵌套集]

    S1 --> R1[返回平面结构<br/>前端组装树]
    S2 --> R2[返回带路径的节点]
    S3 --> R3[返回左右值编码]

```

## 接口版本管理

```mermaid
flowchart TB
    Client[客户端] --> Choice{选择版本}

    Choice -->|V1| V1[API V1<br/>api/v1/users]
    Choice -->|V2| V2[API V2<br/>api/v2/users]

    V1 --> Old[旧接口<br/>保持兼容]
    V2 --> New[新接口<br/>新功能]

    Old --> Deprecate[标记废弃]
    Deprecate --> Notice[通知客户端]
    Notice --> Remove[一段时间后移除]
```

### 版本管理策略

| 策略 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| URL 版本 `/api/v1/` | 简单直观 | URL 变化 | 广泛使用 |
| Header 版本 `Accept: ...` | URL 不变 | 客户端需配置 | 内部 API |
| 参数版本 `?version=1` | 兼容性好 | 不够优雅 | 过渡期使用 |

## 接口安全设计

### 认证流程
1. 用户提交登录凭据
2. 验证身份生成 JWT Token
3. 后续请求携带 Token
4. 服务端验证 Token 并提取用户信息

### 2. 权限控制层次

```mermaid
graph TB
    subgraph 权限控制[三层权限控制]
        P1[接口权限<br/>Endpoint Permission]
        P2[数据权限<br/>Data Permission]
        P3[字段权限<br/>Field Permission]
    end

    P1 --> EP[能否访问接口]
    P2 --> DP[能访问哪些数据]
    P3 --> FP[能看见哪些字段]

    EP --> Check[综合判断]
    DP --> Check
    FP --> Check

    Check --> Result[允许/拒绝]
```

## 错误处理设计

```mermaid
mindmap
  root((错误处理))
    客户端错误 4xx
      400 Bad Request
        参数验证失败
        请求格式错误
      401 Unauthorized
        未认证
        Token过期
      403 Forbidden
        无权限
        资源不可访问
      404 Not Found
        资源不存在
      409 Conflict
        资源冲突
        违反约束
      422 Unprocessable Entity
        语义错误
        业务规则失败
    服务端错误 5xx
      500 Internal Server Error
        未知错误
      503 Service Unavailable
        服务不可用
    错误响应格式
      code
        业务错误码
      msg
        错误描述
      errors
        详细错误列表
      timestamp
        时间戳
```

## 接口设计检查清单

### URI 设计

- [ ] 使用名词表示资源
- [ ] 使用复数形式
- [ ] 使用小写字母和连字符
- [ ] 嵌套层级不超过 3 层
- [ ] 避免在 URI 中使用动词

### HTTP 方法

- [ ] GET 用于查询，幂等安全
- [ ] POST 用于创建，非幂等
- [ ] PUT 用于完整更新，幂等
- [ ] PATCH 用于部分更新，非幂等
- [ ] DELETE 用于删除，幂等

### 参数设计

- [ ] 路径参数用于资源标识
- [ ] 查询参数用于过滤、排序、分页
- [ ] 请求体用于创建/更新数据
- [ ] 参数命名使用小写和下划线

### 响应设计

- [ ] 使用统一的响应格式
- [ ] 成功响应包含 code、msg、data
- [ ] 错误响应包含 code、msg、错误详情
- [ ] 分页响应包含 rows、total

### 安全性

- [ ] 敏感接口需要认证
- [ ] 实施权限控制
- [ ] 输入参数验证
- [ ] 响应数据脱敏
- [ ] 防止 SQL 注入

### 文档

- [ ] 提供 API 文档
- [ ] 包含请求示例
- [ ] 包含响应示例
- [ ] 标注错误码
- [ ] 说明认证方式

## 实战案例：用户管理接口

### 完整接口列表

| 接口 | 方法 | URI | 说明 |
|-----|------|-----|------|
| 用户列表 | GET | /api/v1/users | 分页查询用户 |
| 用户详情 | GET | /api/v1/users/:id | 获取单个用户 |
| 创建用户 | POST | /api/v1/users | 创建新用户 |
| 更新用户 | PUT | /api/v1/users/:id | 完整更新用户 |
| 部分更新 | PATCH | /api/v1/users/:id | 部分更新用户 |
| 删除用户 | DELETE | /api/v1/users/:id | 删除用户 |
| 用户订单 | GET | /api/v1/users/:id/orders | 获取用户的订单 |
| 批量删除 | DELETE | /api/v1/users/batch | 批量删除用户 |

### 请求示例

```http
GET /api/v1/users?page=1&size=10&status=active
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 响应示例

```json
{
  "code": 200,
  "msg": "success",
  "rows": [
    {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "status": "active",
      "createTime": "2024-01-01T00:00:00Z"
    }
  ],
  "total": 100
}
```

## 相关文档

- [03-后端思维培养/02-接口设计思维.md](../03-后端思维培养/02-接口设计思维.md) - 接口设计思维
- [05-前端开发者的后端入门/03-接口设计-函数即路由.md](../05-前端开发者的后端入门/03-接口设计-函数即路由.md) - FastAPI 接口实现
- [06-前端后端对照.md](./06-前端后端对照.md) - 前后端概念对照
