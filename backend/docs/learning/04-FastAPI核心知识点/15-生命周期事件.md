# ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

## å­¦ä¹ ç›®æ ‡

- æŒæ¡ lifespan ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- å­¦ä¹ å¯åŠ¨äº‹ä»¶å¤„ç†
- ç†è§£å…³é—­äº‹ä»¶å¤„ç†
- æŒæ¡èµ„æºåˆå§‹åŒ–ä¸æ¸…ç†
- ç†è§£ä¼˜é›…å…³é—­æœºåˆ¶

## 1. åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

### 1.1 lifespan ä¸Šä¸‹æ–‡ç®¡ç†å™¨

FastAPI ä½¿ç”¨ `lifespan` ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥ç®¡ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

**æ–‡ä»¶ï¼š** `server.py:1-60`

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from config.get_redis import RedisUtil
from config.database import async_engine


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

    åœ¨åº”ç”¨å¯åŠ¨å’Œå…³é—­æ—¶æ‰§è¡Œç›¸åº”çš„æ“ä½œ
    """
    # ==================== å¯åŠ¨æ—¶æ‰§è¡Œ ====================
    print('===============================================')
    print('*                                             *')
    print('*                                             *')
    print('*          RuoYi-Vue3-FastAPI å·²å¯åŠ¨           *')
    print('*                                             *')
    print('*                                             *')
    print('===============================================')

    # åˆå§‹åŒ– Redis è¿æ¥
    redis_pool = await RedisUtil.create_redis_pool()
    app.state.redis = redis_pool

    # åˆå§‹åŒ–ç³»ç»Ÿå­—å…¸åˆ°ç¼“å­˜
    await RedisUtil.init_sys_dict(app.state.redis)

    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–åˆå§‹åŒ–æ“ä½œ
    # - è¿æ¥æ•°æ®åº“
    # - åŠ è½½é…ç½®
    # - åˆå§‹åŒ–ç¼“å­˜
    # - å¯åŠ¨åå°ä»»åŠ¡

    yield  # åº”ç”¨è¿è¡ŒæœŸé—´ï¼Œä»£ç åœ¨è¿™é‡Œæš‚åœ

    # ==================== å…³é—­æ—¶æ‰§è¡Œ ====================
    print('===============================================')
    print('*                                             *')
    print('*                                             *')
    print('*          RuoYi-Vue3-FastAPI å·²å…³é—­           *')
    print('*                                             *')
    print('*                                             *')
    print('===============================================')

    # å…³é—­ Redis è¿æ¥
    await RedisUtil.close_redis_pool(app.state.redis)

    # å…³é—­æ•°æ®åº“è¿æ¥
    await async_engine.dispose()

    # å…¶ä»–æ¸…ç†æ“ä½œ
    # - å…³é—­æ–‡ä»¶
    # - é‡Šæ”¾èµ„æº
    # - ä¿å­˜çŠ¶æ€


# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
app = FastAPI(
    title='RuoYi-Vue3-FastAPI',
    description='RuoYi-Vue3-FastAPI åå°æ¥å£ç³»ç»Ÿ',
    version='1.0.0',
    lifespan=lifespan  # æ³¨å†Œç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨
)
```

### 1.2 ç”Ÿå‘½å‘¨æœŸæµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Server as æœåŠ¡å™¨
    participant App as FastAPI åº”ç”¨
    participant Startup as å¯åŠ¨äº‹ä»¶
    participant Runtime as è¿è¡Œæ—¶
    participant Shutdown as å…³é—­äº‹ä»¶

    Note over Server,Shutdown: FastAPI åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

    Server->>App: å¯åŠ¨åº”ç”¨
    App->>Startup: æ‰§è¡Œå¯åŠ¨äº‹ä»¶
    Startup->>Startup: åˆå§‹åŒ– Redis
    Startup->>Startup: åŠ è½½ç³»ç»Ÿå­—å…¸
    Startup->>Startup: åˆå§‹åŒ–å…¶ä»–èµ„æº
    Startup-->>App: å¯åŠ¨å®Œæˆ

    App->>Runtime: å¤„ç†è¯·æ±‚
    Runtime-->>App: è¿”å›å“åº”
    Note over App,Runtime: åº”ç”¨è¿è¡ŒæœŸé—´

    Server->>App: å…³é—­ä¿¡å·
    App->>Shutdown: æ‰§è¡Œå…³é—­äº‹ä»¶
    Shutdown->>Shutdown: å…³é—­ Redis
    Shutdown->>Shutdown: å…³é—­æ•°æ®åº“
    Shutdown->>Shutdown: é‡Šæ”¾èµ„æº
    Shutdown-->>App: å…³é—­å®Œæˆ
    App-->>Server: åº”ç”¨é€€å‡º
```

## 2. å¯åŠ¨äº‹ä»¶

### 2.1 èµ„æºåˆå§‹åŒ–

**æ–‡ä»¶ï¼š** `config/get_redis.py:296-314`

```python
class RedisUtil:
    """Redis å·¥å…·ç±»"""

    @staticmethod
    async def init_sys_dict(redis):
        """åˆå§‹åŒ–ç³»ç»Ÿå­—å…¸åˆ°ç¼“å­˜"""
        # æŸ¥è¯¢æ‰€æœ‰å­—å…¸
        from sqlalchemy import select
        from config.database import get_db
        from module_admin.model.sys_dict_model import SysDict

        async with get_db() as db:
            stmt = select(SysDict)
            result = await db.execute(stmt)
            dict_list = result.scalars().all()

        # å†™å…¥ Redis
        for dict_item in dict_list:
            await redis.hset(
                f'sys:dict:{dict_item.dict_code}',
                mapping={
                    'dict_code': dict_item.dict_code,
                    'dict_label': dict_item.dict_label,
                    'dict_type': dict_item.dict_type,
                    'is_default': dict_item.is_default,
                    'status': dict_item.status
                }
            )

        logger.info('ç³»ç»Ÿå­—å…¸å·²åŠ è½½åˆ° Redis')
```

### 2.2 æ•°æ®åº“è¿æ¥åˆå§‹åŒ–

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨æ—¶
    print('æ­£åœ¨è¿æ¥æ•°æ®åº“...')

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    from config.database import AsyncSessionLocal
    from sqlalchemy import text

    async with AsyncSessionLocal() as db:
        await db.execute(text('SELECT 1'))
        print('æ•°æ®åº“è¿æ¥æˆåŠŸ')

    # åˆå§‹åŒ–è¿æ¥æ± 
    print(f'æ•°æ®åº“è¿æ¥æ± å·²åˆå§‹åŒ–')

    yield

    # å…³é—­æ—¶
    print('æ­£åœ¨å…³é—­æ•°æ®åº“è¿æ¥...')
    await async_engine.dispose()
    print('æ•°æ®åº“è¿æ¥å·²å…³é—­')
```

### 2.3 ç¼“å­˜é¢„çƒ­

```python
async def warm_up_cache():
    """ç¼“å­˜é¢„çƒ­ - åŠ è½½çƒ­ç‚¹æ•°æ®"""

    redis = await get_redis_connection()

    # é¢„åŠ è½½ç³»ç»Ÿé…ç½®
    configs = await load_system_configs()
    for config in configs:
        await redis.hset(
            f'sys:config:{config.config_key}',
            mapping=config.__dict__
        )

    # é¢„åŠ è½½å­—å…¸æ•°æ®
    dicts = await load_system_dicts()
    for dict_item in dicts:
        await redis.hset(
            f'sys:dict:{dict_item.dict_code}',
            mapping=dict_item.__dict__
        )

    # é¢„åŠ è½½èœå•æ•°æ®
    menus = await load_system_menus()
    await redis.setex(
        'sys:menu:all',
        3600,
        json.dumps([m.__dict__ for m in menus])
    )

    print('ç¼“å­˜é¢„çƒ­å®Œæˆ')


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜
    await warm_up_cache()

    yield
```

### 2.4 å®šæ—¶ä»»åŠ¡å¯åŠ¨

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler


scheduler = AsyncIOScheduler()


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨å®šæ—¶ä»»åŠ¡
    from module_admin.tasks import scheduled_tasks

    # æ·»åŠ å®šæ—¶ä»»åŠ¡
    scheduler.add_job(
        scheduled_tasks.cleanup_temp_files,
        'cron',
        hour=2,  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
        minute=0
    )

    scheduler.add_job(
        scheduled_tasks.sync_user_data,
        'interval',
        hours=6  # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡
    )

    scheduler.start()
    print('å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨')

    yield

    # å…³é—­å®šæ—¶ä»»åŠ¡
    scheduler.shutdown()
    print('å®šæ—¶ä»»åŠ¡å·²å…³é—­')
```

## 3. å…³é—­äº‹ä»¶

### 3.1 èµ„æºæ¸…ç†

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    yield

    # ==================== å…³é—­æ—¶æ¸…ç† ====================

    # 1. å…³é—­ Redis è¿æ¥
    if hasattr(app.state, 'redis'):
        await app.state.redis.close()
        print('Redis è¿æ¥å·²å…³é—­')

    # 2. å…³é—­æ•°æ®åº“è¿æ¥æ± 
    await async_engine.dispose()
    print('æ•°æ®åº“è¿æ¥æ± å·²å…³é—­')

    # 3. å…³é—­å…¶ä»–è¿æ¥
    # - å…³é—­æ–‡ä»¶å¥æŸ„
    # - å…³é—­ç½‘ç»œè¿æ¥
    # - é‡Šæ”¾å†…å­˜
```

### 3.2 ä¼˜é›…å…³é—­

```python
import signal


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # è®¾ç½®ä¿¡å·å¤„ç†å™¨
    def handle_shutdown(signum, frame):
        print(f'æ”¶åˆ°å…³é—­ä¿¡å·: {signum}')
        # æ‰§è¡Œæ¸…ç†æ“ä½œ

    signal.signal(signal.SIGINT, handle_shutdown)
    signal.signal(signal.SIGTERM, handle_shutdown)

    yield

    # ç¡®ä¿æ‰€æœ‰è¯·æ±‚å®Œæˆ
    print('ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆ...')
    await asyncio.sleep(2)  # ç­‰å¾… 2 ç§’

    # å…³é—­èµ„æº
    print('æ­£åœ¨å…³é—­èµ„æº...')
    await cleanup_resources()
```

### 3.3 çŠ¶æ€ä¿å­˜

```python
async def save_application_state():
    """ä¿å­˜åº”ç”¨çŠ¶æ€"""

    # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
    stats = {
        'total_requests': request_count,
        'active_users': len(active_users),
        'uptime': uptime_seconds
    }

    # ä¿å­˜åˆ°æ–‡ä»¶
    with open('app_state.json', 'w') as f:
        json.dump(stats, f)

    # æˆ–ä¿å­˜åˆ°æ•°æ®åº“
    await save_stats_to_db(stats)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨æ—¶æ¢å¤çŠ¶æ€
    if os.path.exists('app_state.json'):
        with open('app_state.json', 'r') as f:
            state = json.load(f)
            print(f'æ¢å¤çŠ¶æ€: {state}')

    yield

    # å…³é—­æ—¶ä¿å­˜çŠ¶æ€
    await save_application_state()
    print('åº”ç”¨çŠ¶æ€å·²ä¿å­˜')
```

## 4. åº”ç”¨çŠ¶æ€ç®¡ç†

### 4.1 app.state ä½¿ç”¨

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨æ—¶å­˜å‚¨çŠ¶æ€
    app.state.redis = await create_redis_pool()
    app.state.db_engine = async_engine
    app.state.scheduler = scheduler
    app.state.config = load_config()
    app.state.start_time = datetime.now()

    yield

    # å…³é—­æ—¶æ¸…ç†
    await app.state.redis.close()
    await app.state.db_engine.dispose()
    app.state.scheduler.shutdown()


# åœ¨è·¯ç”±ä¸­ä½¿ç”¨çŠ¶æ€
@app.get('/admin/status')
async def get_status(request: Request):
    """è·å–åº”ç”¨çŠ¶æ€"""
    app = request.app

    return {
        'redis_connected': app.state.redis is not None,
        'uptime': (datetime.now() - app.state.start_time).total_seconds(),
        'config': {
            'app_name': app.state.config.app_name,
            'environment': app.state.config.environment
        }
    }
```

### 4.2 å…±äº«èµ„æºç®¡ç†

```python
class ResourceManager:
    """èµ„æºç®¡ç†å™¨"""

    def __init__(self):
        self.resources = {}

    async def init_resource(self, name: str, resource):
        """åˆå§‹åŒ–èµ„æº"""
        self.resources[name] = resource
        print(f'èµ„æº {name} å·²åˆå§‹åŒ–')

    async def get_resource(self, name: str):
        """è·å–èµ„æº"""
        return self.resources.get(name)

    async def cleanup_all(self):
        """æ¸…ç†æ‰€æœ‰èµ„æº"""
        for name, resource in self.resources.items():
            if hasattr(resource, 'close'):
                await resource.close()
            print(f'èµ„æº {name} å·²æ¸…ç†')


# ä½¿ç”¨
resource_manager = ResourceManager()


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # åˆå§‹åŒ–èµ„æº
    await resource_manager.init_resource('redis', await create_redis())
    await resource_manager.init_resource('db', await create_db())

    # å­˜å‚¨åˆ° app.state
    app.state.resources = resource_manager

    yield

    # æ¸…ç†æ‰€æœ‰èµ„æº
    await resource_manager.cleanup_all()
```

## 5. é”™è¯¯å¤„ç†

### 5.1 å¯åŠ¨å¤±è´¥å¤„ç†

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    try:
        # å°è¯•è¿æ¥æ•°æ®åº“
        await init_database()
        print('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')

        # å°è¯•è¿æ¥ Redis
        await init_redis()
        print('Redis åˆå§‹åŒ–æˆåŠŸ')

    except Exception as e:
        print(f'å¯åŠ¨å¤±è´¥: {e}')
        # è®°å½•é”™è¯¯æ—¥å¿—
        logger.error(f'åº”ç”¨å¯åŠ¨å¤±è´¥: {e}')
        # é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢åº”ç”¨å¯åŠ¨
        raise

    yield
```

### 5.2 å…³é—­å¤±è´¥å¤„ç†

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    yield

    # å…³é—­æ—¶å¤„ç†é”™è¯¯
    errors = []

    try:
        await close_redis()
    except Exception as e:
        errors.append(f'Redis å…³é—­å¤±è´¥: {e}')
        logger.error(f'Redis å…³é—­å¤±è´¥: {e}')

    try:
        await close_database()
    except Exception as e:
        errors.append(f'æ•°æ®åº“å…³é—­å¤±è´¥: {e}')
        logger.error(f'æ•°æ®åº“å…³é—­å¤±è´¥: {e}')

    if errors:
        print('å…³é—­æ—¶å‘ç”Ÿé”™è¯¯:')
        for error in errors:
            print(f'  - {error}')
```

## 6. å¤šå®ä¾‹ç®¡ç†

### 6.1 å®ä¾‹å¥åº·æ£€æŸ¥

```python
import uuid


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # ç”Ÿæˆå®ä¾‹ ID
    instance_id = str(uuid.uuid4())
    app.state.instance_id = instance_id

    # æ³¨å†Œå®ä¾‹
    await register_instance(instance_id)
    print(f'å®ä¾‹ {instance_id} å·²å¯åŠ¨')

    # å¯åŠ¨å¥åº·æ£€æŸ¥
    async def health_check():
        while True:
            await update_heartbeat(instance_id)
            await asyncio.sleep(30)

    health_task = asyncio.create_task(health_check())

    yield

    # å–æ¶ˆå¥åº·æ£€æŸ¥
    health_task.cancel()

    # æ³¨é”€å®ä¾‹
    await unregister_instance(instance_id)
    print(f'å®ä¾‹ {instance_id} å·²å…³é—­')
```

### 6.2 åˆ†å¸ƒå¼é”

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # è·å–å¯åŠ¨é”ï¼ˆé˜²æ­¢å¤šå®ä¾‹åŒæ—¶åˆå§‹åŒ–ï¼‰
    lock_name = 'app:startup:lock'

    acquired, lock_value = await acquire_lock(lock_name, timeout=60)

    if not acquired:
        print('å¦ä¸€ä¸ªå®ä¾‹æ­£åœ¨åˆå§‹åŒ–ï¼Œç­‰å¾…...')
        # ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        await wait_for_initialization()
    else:
        try:
            # æ‰§è¡Œåˆå§‹åŒ–
            await initialize_resources()
            # æ ‡è®°åˆå§‹åŒ–å®Œæˆ
            await mark_initialization_complete()
        finally:
            # é‡Šæ”¾é”
            await release_lock(lock_name, lock_value)

    yield
```

## 7. ç›‘æ§ä¸æ—¥å¿—

### 7.1 å¯åŠ¨æ—¥å¿—

```python
import logging

logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # è®°å½•å¯åŠ¨ä¿¡æ¯
    logger.info('=' * 50)
    logger.info('åº”ç”¨å¯åŠ¨ä¸­...')
    logger.info(f'ç‰ˆæœ¬: {app.version}')
    logger.info(f'ç¯å¢ƒ: {os.getenv("APP_ENV", "development")}')
    logger.info('=' * 50)

    # è®°å½•é…ç½®
    logger.info(f'æ•°æ®åº“: {db_host}:{db_port}')
    logger.info(f'Redis: {redis_host}:{redis_port}')
    logger.info(f'è°ƒè¯•æ¨¡å¼: {debug}')

    # è®°å½•å¯åŠ¨æ—¶é—´
    start_time = time.time()
    app.state.start_time = start_time

    yield

    # è®°å½•å…³é—­ä¿¡æ¯
    uptime = time.time() - start_time
    logger.info('=' * 50)
    logger.info('åº”ç”¨å…³é—­')
    logger.info(f'è¿è¡Œæ—¶é—´: {uptime:.2f} ç§’')
    logger.info('=' * 50)
```

### 7.2 æ€§èƒ½ç›‘æ§

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸ"""

    # å¯åŠ¨æ€§èƒ½ç›‘æ§
    from prometheus_client import Counter, Histogram

    request_count = Counter('http_requests_total', 'Total requests')
    request_duration = Histogram('http_request_duration_seconds', 'Request duration')

    app.state.metrics = {
        'request_count': request_count,
        'request_duration': request_duration
    }

    # å¯åŠ¨ç›‘æ§æœåŠ¡å™¨
    start_prometheus_server()

    yield

    # ä¿å­˜ç›‘æ§æ•°æ®
    await save_metrics()
```

## 8. æ€»ç»“

### 8.1 ç”Ÿå‘½å‘¨æœŸæœ€ä½³å®è·µ

| å®è·µ | è¯´æ˜ |
|------|------|
| **èµ„æºåˆå§‹åŒ–** | åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰éœ€è¦çš„èµ„æº |
| **èµ„æºæ¸…ç†** | åœ¨å…³é—­æ—¶æ­£ç¡®é‡Šæ”¾æ‰€æœ‰èµ„æº |
| **é”™è¯¯å¤„ç†** | å¦¥å–„å¤„ç†å¯åŠ¨å’Œå…³é—­æ—¶çš„é”™è¯¯ |
| **çŠ¶æ€ç®¡ç†** | ä½¿ç”¨ app.state å­˜å‚¨åº”ç”¨çŠ¶æ€ |
| **æ—¥å¿—è®°å½•** | è®°å½•é‡è¦çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ |
| **ä¼˜é›…å…³é—­** | ç¡®ä¿æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆåå†å…³é—­ |

### 8.2 ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥æ¸…å•

```python
# âœ… å¯åŠ¨æ£€æŸ¥æ¸…å•
- [ ] æ•°æ®åº“è¿æ¥å·²å»ºç«‹
- [ ] Redis è¿æ¥å·²å»ºç«‹
- [ ] ç¼“å­˜å·²é¢„çƒ­
- [ ] é…ç½®å·²åŠ è½½
- [ ] å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨
- [ ] æ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ–

# âœ… å…³é—­æ£€æŸ¥æ¸…å•
- [ ] æ‰€æœ‰è¯·æ±‚å·²å®Œæˆ
- [ ] æ•°æ®åº“è¿æ¥å·²å…³é—­
- [ ] Redis è¿æ¥å·²å…³é—­
- [ ] æ–‡ä»¶å¥æŸ„å·²é‡Šæ”¾
- [ ] å®šæ—¶ä»»åŠ¡å·²åœæ­¢
- [ ] çŠ¶æ€å·²ä¿å­˜
```

### 8.3 å®Œæ•´ç¤ºä¾‹

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
import logging

logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"""

    # ==================== å¯åŠ¨ ====================
    logger.info('åº”ç”¨æ­£åœ¨å¯åŠ¨...')

    try:
        # 1. åˆå§‹åŒ–é…ç½®
        config = load_config()
        app.state.config = config
        logger.info('é…ç½®å·²åŠ è½½')

        # 2. åˆå§‹åŒ–æ•°æ®åº“
        db_engine = await init_database(config)
        app.state.db = db_engine
        logger.info('æ•°æ®åº“å·²è¿æ¥')

        # 3. åˆå§‹åŒ– Redis
        redis = await init_redis(config)
        app.state.redis = redis
        logger.info('Redis å·²è¿æ¥')

        # 4. é¢„çƒ­ç¼“å­˜
        await warm_up_cache(redis)
        logger.info('ç¼“å­˜å·²é¢„çƒ­')

        # 5. å¯åŠ¨å®šæ—¶ä»»åŠ¡
        scheduler = start_scheduler()
        app.state.scheduler = scheduler
        logger.info('å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨')

        logger.info('åº”ç”¨å¯åŠ¨æˆåŠŸ')

    except Exception as e:
        logger.error(f'åº”ç”¨å¯åŠ¨å¤±è´¥: {e}')
        raise

    yield

    # ==================== å…³é—­ ====================
    logger.info('åº”ç”¨æ­£åœ¨å…³é—­...')

    try:
        # 1. åœæ­¢å®šæ—¶ä»»åŠ¡
        if hasattr(app.state, 'scheduler'):
            app.state.scheduler.shutdown()
            logger.info('å®šæ—¶ä»»åŠ¡å·²åœæ­¢')

        # 2. å…³é—­ Redis
        if hasattr(app.state, 'redis'):
            await app.state.redis.close()
            logger.info('Redis å·²å…³é—­')

        # 3. å…³é—­æ•°æ®åº“
        if hasattr(app.state, 'db'):
            await app.state.db.dispose()
            logger.info('æ•°æ®åº“å·²å…³é—­')

        # 4. ä¿å­˜çŠ¶æ€
        await save_state()
        logger.info('çŠ¶æ€å·²ä¿å­˜')

        logger.info('åº”ç”¨å…³é—­æˆåŠŸ')

    except Exception as e:
        logger.error(f'åº”ç”¨å…³é—­æ—¶å‘ç”Ÿé”™è¯¯: {e}')


# åˆ›å»ºåº”ç”¨
app = FastAPI(
    title='RuoYi-Vue3-FastAPI',
    lifespan=lifespan
)
```

## 9. ç»ƒä¹ 

1. å®ç°ä¸€ä¸ªå®Œæ•´çš„ lifespan ç®¡ç†å™¨
2. æ·»åŠ åº”ç”¨å¯åŠ¨æ—¶çš„å¥åº·æ£€æŸ¥
3. å®ç°èµ„æºæ¸…ç†å’ŒçŠ¶æ€ä¿å­˜
4. æ·»åŠ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„è¯¦ç»†æ—¥å¿—
5. å®ç°ä¼˜é›…å…³é—­æœºåˆ¶

## 10. æ€»ç»“

å®Œæˆæœ¬èŠ‚å­¦ä¹ åï¼Œä½ å·²ç»æŒæ¡äº†ï¼š

- **lifespan ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼šç®¡ç†åº”ç”¨å¯åŠ¨å’Œå…³é—­
- **èµ„æºåˆå§‹åŒ–**ï¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“ã€Redis ç­‰èµ„æº
- **èµ„æºæ¸…ç†**ï¼šåœ¨å…³é—­æ—¶æ­£ç¡®é‡Šæ”¾èµ„æº
- **ä¼˜é›…å…³é—­**ï¼šç¡®ä¿è¯·æ±‚å®Œæˆåå†å…³é—­åº”ç”¨
- **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ app.state å­˜å‚¨åº”ç”¨çŠ¶æ€
- **é”™è¯¯å¤„ç†**ï¼šå¦¥å–„å¤„ç†ç”Ÿå‘½å‘¨æœŸä¸­çš„é”™è¯¯

## 11. åç»­å­¦ä¹ 

ç°åœ¨ä½ å·²ç»å®Œæˆäº† FastAPI æ ¸å¿ƒçŸ¥è¯†ç‚¹çš„å­¦ä¹ ï¼ç»§ç»­æ¢ç´¢ï¼š

- **é¡¹ç›®å®æˆ˜**ï¼šé˜…è¯»é¡¹ç›®æºä»£ç ï¼Œç†è§£å®é™…åº”ç”¨
- **é«˜çº§ç‰¹æ€§**ï¼šå­¦ä¹  WebSocketã€åå°ä»»åŠ¡ç­‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¹ ç¼“å­˜ã€è¿æ¥æ± ä¼˜åŒ–
- **éƒ¨ç½²è¿ç»´**ï¼šå­¦ä¹  Dockerã€Kubernetes éƒ¨ç½²

æ­å–œä½ å®Œæˆ FastAPI æ ¸å¿ƒçŸ¥è¯†å­¦ä¹ ï¼ğŸ‰
