# 配置管理

## 学习目标

- 掌握环境变量配置
- 学习 Pydantic Settings 使用
- 理解多环境配置管理
- 掌握配置文件组织
- 理解配置验证机制

## 1. 环境变量配置

### 1.1 .env 文件

**文件：** `.env.dev`

```bash
# 应用配置
APP_NAME=RuoYi-FastAPI
APP_ENV=development
APP_PORT=9099
APP_DEBUG=True

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=ruoyi_fastapi
DB_USERNAME=root
DB_PASSWORD=your_password

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# JWT 配置
JWT_SECRET_KEY=your-secret-key-here
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=30

# 文件上传配置
UPLOAD_PATH=uploads
MAX_UPLOAD_SIZE=10485760
```

### 1.2 配置加载

**文件：** `config/env.py:1-45`

```python
from pydantic_settings import BaseSettings
from functools import lru_cache


class DataBaseConfig(BaseSettings):
    """数据库配置类"""

    # 从环境变量读取配置
    db_username: str = 'root'
    db_password: str = ''
    db_host: str = '127.0.0.1'
    db_port: int = 3306
    db_database: str = 'ry-vue3'
    db_echo: bool = False

    # 连接池配置
    db_pool_size: int = 5
    db_max_overflow: int = 10
    db_pool_timeout: int = 30
    db_pool_recycle: int = 3600

    class Config:
        # 配置文件前缀
        env_prefix = 'DB_'
        # 从 .env 文件读取
        env_file = '.env.dev'
        # 忽略大小写
        case_sensitive = False


class AppConfig(BaseSettings):
    """应用配置类"""

    app_name: str = 'RuoYi-FastAPI'
    app_env: str = 'development'
    app_port: int = 9099
    app_debug: bool = True

    # 跨域配置
    cors_origins: list = ['*']
    cors_credentials: bool = True
    cors_methods: list = ['*']
    cors_headers: list = ['*']

    class Config:
        env_prefix = 'APP_'
        env_file = '.env.dev'
```

## 2. Pydantic Settings

### 2.1 基础配置类

```python
from pydantic import Field, validator
from typing import List


class Settings(BaseSettings):
    """应用设置"""

    # 基本配置
    app_name: str = Field(default='FastAPI App', description='应用名称')
    app_version: str = Field(default='1.0.0', description='应用版本')
    debug: bool = Field(default=False, description='调试模式')

    # 服务器配置
    host: str = Field(default='127.0.0.1', description='服务器地址')
    port: int = Field(default=8000, description='服务器端口')

    # 数据库配置
    database_url: str = Field(..., description='数据库连接')

    # 安全配置
    secret_key: str = Field(..., description='密钥')
    algorithm: str = Field(default='HS256', description='加密算法')

    class Config:
        env_file = '.env'
        case_sensitive = False

    @validator('port')
    def validate_port(cls, v):
        """验证端口号"""
        if not 1 <= v <= 65535:
            raise ValueError('端口号必须在 1-65535 之间')
        return v
```

### 2.2 嵌套配置

```python
from pydantic import BaseSettings


class DatabaseSettings(BaseSettings):
    """数据库配置"""

    host: str = 'localhost'
    port: int = 3306
    username: str = 'root'
    password: str = ''
    database: str = 'mydb'

    class Config:
        env_prefix = 'DB_'


class RedisSettings(BaseSettings):
    """Redis 配置"""

    host: str = 'localhost'
    port: int = 6379
    db: int = 0
    password: str = ''

    class Config:
        env_prefix = 'REDIS_'


class AppSettings(BaseSettings):
    """应用配置（嵌套）"""

    app_name: str = 'MyApp'
    debug: bool = False

    # 嵌套配置
    database: DatabaseSettings = DatabaseSettings()
    redis: RedisSettings = RedisSettings()

    class Config:
        env_file = '.env'
```

### 2.3 配置缓存

**文件：** `config/env.py:48-65`

```python
from functools import lru_cache


class AppConfig(BaseSettings):
    """应用配置"""

    # ... 配置字段 ...

    class Config:
        env_file = '.env.dev'


@lru_cache()
def get_app_config():
    """
    获取应用配置（单例模式）

    使用 lru_cache 确保配置只加载一次
    """
    return AppConfig()


# 使用
config = get_app_config()
print(config.app_name)
```

## 3. 多环境配置

### 3.1 环境文件结构

```
ruoyi-fastapi-backend/
├── .env.dev          # 开发环境
├── .env.test         # 测试环境
├── .env.prod         # 生产环境
└── .env.example      # 配置示例
```

### 3.2 环境切换

```python
import os
from pathlib import Path


class Settings(BaseSettings):
    """设置类"""

    # 自动检测环境
    environment: str = Field(
        default='development',
        description='运行环境'
    )

    def get_env_file(self) -> Path:
        """获取环境文件路径"""
        env = os.getenv('APP_ENV', 'development')

        env_files = {
            'development': '.env.dev',
            'test': '.env.test',
            'production': '.env.prod'
        }

        return Path(env_files.get(env, '.env.dev'))

    class Config:
        # 动态环境文件
        env_file = get_env_file(None)


# 使用
# 命令行: APP_ENV=production python app.py
settings = Settings()
print(f'运行环境: {settings.environment}')
```

### 3.3 配置差异示例

**开发环境 (`.env.dev`)**:
```bash
APP_ENV=development
APP_DEBUG=True
APP_PORT=9099

DB_HOST=localhost
DB_DATABASE=ry_dev

LOG_LEVEL=DEBUG
```

**生产环境 (`.env.prod`)**:
```bash
APP_ENV=production
APP_DEBUG=False
APP_PORT=80

DB_HOST=prod-db.example.com
DB_DATABASE=ry_prod

LOG_LEVEL=INFO

# 生产环境额外配置
ENABLE_CORS=False
ENABLE_HTTPS=True
```

## 4. 配置验证

### 4.1 类型验证

```python
from pydantic import BaseModel, validator, Field


class ConfigModel(BaseModel):
    """配置模型"""

    # 自动类型转换
    port: int = Field(default=8000)
    debug: bool = Field(default=False)
    hosts: list = Field(default=['localhost'])

    # 必填字段
    secret_key: str = Field(..., min_length=32)

    @validator('port')
    def validate_port(cls, v):
        """验证端口"""
        if v < 1 or v > 65535:
            raise ValueError('无效的端口号')
        return v

    @validator('secret_key')
    def validate_secret_key(cls, v):
        """验证密钥强度"""
        if len(v) < 32:
            raise ValueError('密钥长度至少 32 位')
        return v
```

### 4.2 环境变量验证

```python
import os


def validate_environment():
    """验证环境配置"""

    required_vars = [
        'DB_USERNAME',
        'DB_PASSWORD',
        'DB_DATABASE',
        'JWT_SECRET_KEY'
    ]

    missing = []

    for var in required_vars:
        if not os.getenv(var):
            missing.append(var)

    if missing:
        raise ValueError(
            f'缺少必要的环境变量: {", ".join(missing)}'
        )


# 应用启动时验证
@app.on_event("startup")
async def startup_event():
    """启动时验证配置"""
    validate_environment()
    logger.info('环境配置验证通过')
```

## 5. 配置组织最佳实践

### 5.1 分层配置

```python
# config/base.py - 基础配置
class BaseConfig(BaseSettings):
    """基础配置"""
    app_name: str = 'RuoYi-FastAPI'
    app_version: str = '1.0.0'


# config/database.py - 数据库配置
class DatabaseConfig(BaseSettings):
    """数据库配置"""
    db_host: str
    db_port: int = 3306
    # ...


# config/redis.py - Redis 配置
class RedisConfig(BaseSettings):
    """Redis 配置"""
    redis_host: str
    redis_port: int = 6379
    # ...


# config/settings.py - 总配置
class Settings(BaseConfig, DatabaseConfig, RedisConfig):
    """总配置（继承所有配置）"""
    pass
```

### 5.2 配置文件管理

```python
from pathlib import Path
from typing import Dict
import json


class ConfigManager:
    """配置管理器"""

    def __init__(self, config_dir: Path):
        self.config_dir = config_dir
        self.configs = {}

    def load_json_config(self, filename: str) -> Dict:
        """加载 JSON 配置"""
        config_path = self.config_dir / filename

        with open(config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)

        self.configs.update(config)
        return config

    def get(self, key: str, default=None):
        """获取配置项"""
        return self.configs.get(key, default)


# 使用
config_manager = ConfigManager(Path('config'))
config_manager.load_json_config('database.json')
config_manager.load_json_config('redis.json')

db_host = config_manager.get('db_host')
```

### 5.3 敏感配置处理

```python
from cryptography.fernet import Fernet
import os


class SecureConfig:
    """安全配置"""

    def __init__(self, encryption_key: str):
        self.cipher = Fernet(encryption_key.encode())

    def encrypt_password(self, password: str) -> str:
        """加密密码"""
        encrypted = self.cipher.encrypt(password.encode())
        return encrypted.decode()

    def decrypt_password(self, encrypted: str) -> str:
        """解密密码"""
        decrypted = self.cipher.decrypt(encrypted.encode())
        return decrypted.decode()


# 使用
# 在配置文件中存储加密后的密码
# ENCRYPTED_PASSWORD=encrypted_value_here

# 运行时解密
secure_config = SecureConfig(os.getenv('ENCRYPTION_KEY'))
db_password = secure_config.decrypt_password(
    os.getenv('ENCRYPTED_PASSWORD')
)
```

## 6. 动态配置

### 6.1 运行时配置更新

```python
from fastapi import FastAPI
from typing import Dict


app = FastAPI()

# 运行时配置存储
runtime_config: Dict = {}


@app.post('/admin/config')
async def update_config(key: str, value: str):
    """更新运行时配置"""
    runtime_config[key] = value
    return {'message': '配置已更新'}


@app.get('/admin/config')
async def get_config(key: str = None):
    """获取运行时配置"""
    if key:
        return runtime_config.get(key)
    return runtime_config
```

### 6.2 配置热更新

```python
import asyncio
from watchfiles import awatch


class ConfigWatcher:
    """配置文件监控器"""

    def __init__(self, config_path: Path):
        self.config_path = config_path
        self.config = self.load_config()

    def load_config(self):
        """加载配置"""
        # 加载逻辑
        pass

    async def watch(self):
        """监控配置文件变化"""
        async for changes in awatch(self.config_path):
            for change in changes:
                print(f'配置文件变化: {change}')
                self.config = self.load_config()
                print('配置已重新加载')


# 启动时开始监控
@app.on_event('startup')
async def start_config_watcher():
    """启动配置监控"""
    watcher = ConfigWatcher(Path('.env.dev'))
    asyncio.create_task(watcher.watch())
```

## 7. 配置文档

### 7.1 配置说明文档

**文件：** `docs/configuration.md`

```markdown
# 配置说明

## 环境变量

| 变量名 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `APP_NAME` | 应用名称 | RuoYi-FastAPI | 否 |
| `APP_PORT` | 服务端口 | 9099 | 否 |
| `DB_HOST` | 数据库地址 | localhost | 是 |
| `DB_PORT` | 数据库端口 | 3306 | 否 |
| `DB_USERNAME` | 数据库用户 | - | 是 |
| `DB_PASSWORD` | 数据库密码 | - | 是 |

## 配置示例

参考 `.env.example` 文件获取完整配置示例。
```

### 7.2 配置检查命令

```python
@app.get('/admin/config/check')
async def check_config():
    """检查配置完整性"""
    issues = []

    # 检查数据库连接
    try:
        await check_database_connection()
    except Exception as e:
        issues.append(f'数据库连接失败: {e}')

    # 检查 Redis 连接
    try:
        await check_redis_connection()
    except Exception as e:
        issues.append(f'Redis 连接失败: {e}')

    # 检查必要配置
    if not os.getenv('JWT_SECRET_KEY'):
        issues.append('缺少 JWT_SECRET_KEY')

    return {
        'status': 'ok' if not issues else 'error',
        'issues': issues
    }
```

## 8. 总结

### 8.1 配置管理最佳实践

| 实践 | 说明 |
|------|------|
| **环境隔离** | 不同环境使用不同配置文件 |
| **敏感信息** | 使用环境变量存储敏感配置 |
| **配置验证** | 启动时验证配置完整性 |
| **默认值** | 为可选配置提供合理默认值 |
| **文档化** | 维护配置文档和示例 |
| **版本控制** | .env.example 纳入版本控制 |

### 8.2 配置安全

```python
# ✅ 好的做法
SECRET_KEY = os.getenv('JWT_SECRET_KEY')  # 从环境变量读取

# ❌ 不好的做法
SECRET_KEY = "my-secret-key-123"  # 硬编码在代码中

# ✅ 好的做法
db_password = os.getenv('DB_PASSWORD', '')  # 提供默认值

# ❌ 不好的做法
# 将 .env 文件提交到版本控制
```

## 9. 练习

1. 创建一个新的配置类，添加验证逻辑
2. 实现配置文件热更新功能
3. 编写配置验证函数
4. 创建多环境配置文件
5. 实现敏感配置加密存储

## 10. 下一步

完成本节学习后，继续学习：
- **[15-生命周期事件](./15-生命周期事件.md)** - 学习应用生命周期管理
