# 数据库集成

## 学习目标

- 掌握 SQLAlchemy 配置
- 学习 ORM 模型定义
- 理解 CRUD 操作
- 掌握事务管理
- 理解连接池原理

## 1. 数据库配置

### 1.1 异步引擎配置

**文件：** `config/database.py:24-37`

```python
from sqlalchemy.ext.asyncio import create_async_engine
from config.env import DataBaseConfig

# 构建连接 URL
ASYNC_SQLALCHEMY_DATABASE_URL = (
    f'mysql+asyncmy://{DataBaseConfig.db_username}:'
    f'{quote_plus(DataBaseConfig.db_password)}@'
    f'{DataBaseConfig.db_host}:{DataBaseConfig.db_port}/'
    f'{DataBaseConfig.db_database}'
)

# 创建异步引擎
async_engine = create_async_engine(
    ASYNC_SQLALCHEMY_DATABASE_URL,
    echo=DataBaseConfig.db_echo,      # 打印 SQL
    pool_size=DataBaseConfig.db_pool_size,          # 连接池大小
    max_overflow=DataBaseConfig.db_max_overflow,    # 最大溢出
    pool_timeout=DataBaseConfig.db_pool_timeout,    # 超时时间
    pool_recycle=DataBaseConfig.db_pool_recycle,    # 回收时间
)

# 创建会话工厂
AsyncSessionLocal = async_sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=async_engine,
    expire_on_commit=False
)
```

### 1.2 基类定义

```python
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.ext.asyncio import AsyncAttrs

class Base(AsyncAttrs, DeclarativeBase):
    """所有 ORM 模型的基类"""
    pass
```

## 2. ORM 模型定义

### 2.1 基本模型

**文件：** `module_admin/model/user_model.py`

```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.sql import func
from config.database import Base

class SysUser(Base):
    """用户表模型"""

    __tablename__ = 'sys_user'

    # 主键
    user_id: int = Column(Integer, primary_key=True, autoincrement=True)

    # 基本字段
    dept_id: int = Column(Integer, comment='部门ID')
    user_name: str = Column(String(30), nullable=False, unique=True)
    nick_name: str = Column(String(30), comment='用户昵称')
    user_type: str = Column(String(2), default='00')
    email: str = Column(String(50), comment='用户邮箱')
    phonenumber: str = Column(String(11), comment='手机号码')

    # 状态字段
    sex: str = Column(String(1), default='0')
    avatar: str = Column(String(100), comment='头像地址')
    password: str = Column(String(100), comment='密码')
    status: str = Column(String(1), default='0', comment='帐号状态（0正常 1停用）')

    # 时间戳
    del_flag: str = Column(String(1), default='0', comment='删除标志（0代表存在 2代表删除）')
    login_ip: str = Column(String(128), comment='最后登录IP')
    login_date: Column(DateTime, comment='最后登录时间')
    create_by: str = Column(String(64, comment='创建者')
    create_time: Column(DateTime, default=func.now(), comment='创建时间')
    update_by: str = Column(String(64), comment='更新者')
    update_time: Column(DateTime, default=func.now(), onupdate=func.now())

    # 关系
    dept = relationship('Dept', foreign_keys=[dept_id])
```

### 2.2 关系定义

```python
from sqlalchemy import relationship
from typing import List

class SysUser(Base):
    """用户表"""

    # 一对多：一个用户属于一个部门
    dept = relationship('Dept', back_populates='users')

class Dept(Base):
    """部门表"""
    __tablename__ = 'sys_dept'

    dept_id: int = Column(Integer, primary_key=True)

    # 一对多：一个部门有多个用户
    users = relationship('SysUser', back_populates='dept')

class Role(Base):
    """角色表"""
    __tablename__ = 'sys_role'

    role_id: int = Column(Integer, primary_key=True)

    # 多对多：角色与用户关联
    users = relationship('User', secondary='sys_user_role', back_populates='roles')
```

## 3. CRUD 操作

### 3.1 创建操作

```python
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

async def create_user(db: AsyncSession, user_data: dict):
    """创建用户"""
    # 创建模型实例
    db_user = SysUser(**user_data)

    # 添加到会话
    db.add(db_user)

    # 提交（事务）
    await db.commit()

    # 刷新以获取生成的ID
    await db.refresh(db_user)

    return db_user
```

### 3.2 查询操作

```python
async def get_user(db: AsyncSession, user_id: int):
    """查询单个用户"""
    stmt = select(SysUser).where(SysUser.user_id == user_id)

    # 执行查询
    result = await db.execute(stmt)

    # 获取结果
    return result.scalar_one_or_none()

async def get_users(db: AsyncSession, page: int = 1, size: int = 10):
    """查询用户列表"""
    # 计算偏移量
    offset = (page - 1) * size

    # 构建查询
    stmt = select(SysUser).offset(offset).limit(size)

    # 执行查询
    result = await db.execute(stmt)

    # 返回结果
    return result.scalars().all()
```

### 3.3 更新操作

```python
from sqlalchemy import update

async def update_user(
    db: AsyncSession,
    user_id: int,
    update_data: dict
):
    """更新用户"""
    # 构建更新语句
    stmt = (
        update(SysUser)
        .where(SysUser.user_id == user_id)
        .values(**update_data)
    )

    # 执行更新
    await db.execute(stmt)

    # 提交事务
    await db.commit()
```

### 3.4 删除操作

```python
from sqlalchemy import update

async def delete_user(db: AsyncSession, user_id: int):
    """删除用户（软删除）"""
    # 设置删除标志
    stmt = (
        update(SyncUser)
        .where(SysUser.user_id == user_id)
        .values(del_flag='2')  # 标记为已删除
    )

    await db.execute(stmt)
    await db.commit()

# 硬删除
async def hard_delete_user(db: AsyncSession, user_id: int):
    """硬删除用户"""
    stmt = delete(SysUser).where(SysUser.user_id == user_id)

    await db.execute(stmt)
    await db.commit()
```

## 4. 事务管理

### 4.1 手动事务控制

```python
async def transfer_money(
    db: AsyncSession,
    from_user_id: int,
    to_user_id: int,
    amount: int
):
    """转账 - 需要事务"""

    try:
        # 开始事务
        async with db.begin():
            # 扣款
            await deduct_money(db, from_user_id, amount)

            # 入款
            await add_money(db, to_user_id, amount)

            # 如果到达这里，自动提交
            # 如果中间出错，自动回滚

    except Exception as e:
        # 事务自动回滚
        raise ServiceException(f'转账失败: {e}')
```

### 4.2 自动事务装饰器

```python
from functools import wraps

def transactional(func):
    """事务装饰器"""

    @wraps(func)
    async def wrapper(*args, **kwargs):
        async with get_db() as db:
            # 执行函数
            result = await func(db, *args, **kwargs)
            # 成功后自动提交
            return result

    return wrapper

@transactional
async def update_user_and_log(db: AsyncSession):
    """更新用户并记录日志"""
    # 更新用户
    await db.execute(update(SysUser).values(status='1'))

    # 记录日志
    await db.execute(insert(SysOperLog).values(...))
```

## 5. 连接池

### 5.1 连接池配置

```python
async_engine = create_async_engine(
    DATABASE_URL,
    # 连接池配置
    pool_size=10,              # 常驻连接数
    max_overflow=10,           # 额外连接数
    pool_timeout=30,           # 获取超时（秒）
    pool_recycle=3600,         # 连接回收时间（秒）
    pool_pre_ping=True,        # 连接前测试
)
```

### 5.2 连接池监控

```python
async def check_pool_status():
    """检查连接池状态"""
    pool = async_engine.pool

    return {
        'size': pool.size(),
        'checked_in': pool.checkedin(),
        'checked_out': pool.checkedout(),
        'overflow': pool.overflow(),
        'checkedout_connections': len(pool._checkedout_connections)
    }
```

## 6. 总结

### 6.1 ORM 优势

| 优势 | 说明 |
|------|------|
| **类型安全** | 编译时类型检查 |
| **数据库无关** | 支持多种数据库 |
| **易于维护** | Python 代码而非 SQL |
| **自动迁移** | Alembic 自动生成迁移 |

### 6.2 最佳实践

1. **使用异步**：所有数据库操作都应该是异步的
2. **合理使用关系**：正确定义外键关系
3. **索引优化**：为查询字段添加索引
4. **批量操作**：使用批量插入提高性能
5. **事务边界**：合理设置事务范围

## 7. 下一步

完成本节学习后，继续学习：
- **[12-Redis 缓存](./12-Redis缓存.md)** - 学习缓存使用
