# å®‰å…¨é˜²æŠ¤å®è·µ

> æ„å»ºå®‰å…¨çš„è®°è´¦ç³»ç»Ÿï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®ä¸å—å¨èƒ

## ğŸ“‹ æœ¬ç« ç›®æ ‡

- [ ] ç†è§£å¸¸è§ Web å®‰å…¨å¨èƒ
- [ ] å®ç°è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- [ ] æŒæ¡ API å®‰å…¨æœ€ä½³å®è·µ
- [ ] ä¿æŠ¤æ•æ„Ÿæ•°æ®

## ğŸ›¡ï¸ å¸¸è§å®‰å…¨å¨èƒ

```mermaid
mindmap
    root((å®‰å…¨å¨èƒ))
        æ³¨å…¥æ”»å‡»
            SQL æ³¨å…¥
            å‘½ä»¤æ³¨å…¥
            XSS
        è®¤è¯é—®é¢˜
            å¼±å¯†ç 
            ä¼šè¯åŠ«æŒ
            æš´åŠ›ç ´è§£
        æ•°æ®æ³„éœ²
            æ•æ„Ÿä¿¡æ¯æš´éœ²
            ä¸å®‰å…¨çš„å­˜å‚¨
        æƒé™é—®é¢˜
            è¶Šæƒè®¿é—®
            è·¯å¾„éå†
        å…¶ä»–
            CSRF
            SSRF
            DDoS
```

## ğŸ”’ SQL æ³¨å…¥é˜²æŠ¤

### æ”»å‡»åŸç†

```mermaid
flowchart LR
    subgraph Attack["âŒ SQL æ³¨å…¥æ”»å‡»"]
        Input1["è¾“å…¥: ' OR '1'='1"]
        Input1 --> SQL1["SELECT * WHERE username = '' OR '1'='1'"]
        SQL1 --> Result1["è¿”å›æ‰€æœ‰ç”¨æˆ·!"]
    end

    subgraph Safe["âœ… å‚æ•°åŒ–æŸ¥è¯¢"]
        Input2["è¾“å…¥: ' OR '1'='1"]
        Input2 --> SQL2["WHERE username = ?"]
        SQL2 --> Result2["å®‰å…¨å¤„ç†"]
    end

    style Attack fill:#ffcdd2
    style Safe fill:#c8e6c9
```

### SQLAlchemy é˜²æŠ¤

```python
# âœ… å®‰å…¨ï¼šSQLAlchemy è‡ªåŠ¨å‚æ•°åŒ–
stmt = select(User).where(User.username == username)
user = db.scalar(stmt)

# âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°ç»‘å®š
stmt = text("SELECT * FROM users WHERE username = :username")
result = db.execute(stmt, {"username": username})

# âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆä¸è¦è¿™æ ·åšï¼ï¼‰
# stmt = text(f"SELECT * FROM users WHERE username = '{username}'")
```

## ğŸš« XSS é˜²æŠ¤

### XSS æ”»å‡»ç±»å‹

```mermaid
flowchart TB
    subgraph Reflected["åå°„å‹ XSS"]
        R1["æ¶æ„é“¾æ¥"]
        R2["æœåŠ¡å™¨åå°„"]
        R3["ç”¨æˆ·æµè§ˆå™¨æ‰§è¡Œ"]
    end

    subgraph Stored["å­˜å‚¨å‹ XSS"]
        S1["æäº¤æ¶æ„å†…å®¹"]
        S2["å­˜å…¥æ•°æ®åº“"]
        S3["å…¶ä»–ç”¨æˆ·çœ‹åˆ°æ‰§è¡Œ"]
    end

    subgraph DOM["DOM å‹ XSS"]
        D1["å‰ç«¯å¤„ç†ç”¨æˆ·è¾“å…¥"]
        D2["åŠ¨æ€æ¸²æŸ“"]
        D3["è„šæœ¬æ‰§è¡Œ"]
    end

    style Stored fill:#ffcdd2
```

### é˜²æŠ¤æªæ–½

```python
# schemas/transaction.py
from pydantic import BaseModel, field_validator
import re
from html import escape

class TransactionCreate(BaseModel):
    note: str = ""

    @field_validator('note')
    @classmethod
    def sanitize_note(cls, v: str) -> str:
        """æ¸…ç†å¤‡æ³¨ä¸­çš„ HTML æ ‡ç­¾"""
        # ç§»é™¤ HTML æ ‡ç­¾
        v = re.sub(r'<[^>]+>', '', v)
        # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
        v = escape(v)
        return v

# ä¹Ÿå¯ä»¥åœ¨å‰ç«¯å±‚é¢åšå†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
# Content-Security-Policy: default-src 'self'
```

## ğŸ” æ•æ„Ÿæ•°æ®ä¿æŠ¤

### å¯†ç å­˜å‚¨

```mermaid
flowchart LR
    Password["ç”¨æˆ·å¯†ç "] --> Hash["bcrypt å“ˆå¸Œ"]
    Hash --> Salt["åŠ ç›"]
    Salt --> Store["å­˜å‚¨å“ˆå¸Œå€¼"]

    Verify["éªŒè¯"] --> Input["è¾“å…¥å¯†ç "]
    Input --> Hash2["è®¡ç®—å“ˆå¸Œ"]
    Hash2 --> Compare["æ¯”è¾ƒå“ˆå¸Œ"]

    style Store fill:#c8e6c9
```

```python
# core/security.py
from passlib.context import CryptContext

pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto",
    bcrypt__rounds=12  # å¢åŠ è®¡ç®—æˆæœ¬
)

def get_password_hash(password: str) -> str:
    """ç”Ÿæˆå¯†ç å“ˆå¸Œ"""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)
```

### æ•æ„Ÿé…ç½®ä¿æŠ¤

```python
# config.py
from pydantic_settings import BaseSettings
from functools import lru_cache

class Settings(BaseSettings):
    """åº”ç”¨é…ç½®"""

    # ä»ç¯å¢ƒå˜é‡è¯»å–æ•æ„Ÿä¿¡æ¯
    SECRET_KEY: str
    DATABASE_URL: str
    REDIS_URL: str

    # éæ•æ„Ÿé…ç½®
    APP_NAME: str = "è®°è´¦ç³»ç»Ÿ"
    DEBUG: bool = False

    class Config:
        env_file = ".env"
        case_sensitive = True

@lru_cache()
def get_settings() -> Settings:
    return Settings()
```

## ğŸ›¡ï¸ API å®‰å…¨

### é€Ÿç‡é™åˆ¶

```mermaid
flowchart LR
    Request["è¯·æ±‚"] --> Counter["è®¡æ•°å™¨ +1"]
    Counter --> Check{"è¶…è¿‡é™åˆ¶?"}
    Check --> |"æ˜¯"| Block["429 Too Many Requests"]
    Check --> |"å¦"| Process["å¤„ç†è¯·æ±‚"]
    Process --> Response["è¿”å›å“åº”"]

    style Block fill:#ffcdd2
    style Process fill:#c8e6c9
```

```python
# middleware/rate_limit.py
from fastapi import Request, HTTPException, status
from fastapi.responses import JSONResponse
from collections import defaultdict
import time

class RateLimiter:
    """ç®€å•çš„é€Ÿç‡é™åˆ¶å™¨"""

    def __init__(self, requests_per_minute: int = 60):
        self.requests_per_minute = requests_per_minute
        self.requests = defaultdict(list)

    def is_allowed(self, client_id: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚"""
        now = time.time()
        minute_ago = now - 60

        # æ¸…ç†è¿‡æœŸè®°å½•
        self.requests[client_id] = [
            t for t in self.requests[client_id] if t > minute_ago
        ]

        # æ£€æŸ¥æ•°é‡
        if len(self.requests[client_id]) >= self.requests_per_minute:
            return False

        self.requests[client_id].append(now)
        return True

rate_limiter = RateLimiter(requests_per_minute=60)

async def rate_limit_middleware(request: Request, call_next):
    """é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶"""
    # è·å–å®¢æˆ·ç«¯æ ‡è¯†ï¼ˆIP æˆ–ç”¨æˆ· IDï¼‰
    client_id = request.client.host
    if hasattr(request.state, 'user'):
        client_id = str(request.state.user.id)

    if not rate_limiter.is_allowed(client_id):
        return JSONResponse(
            status_code=status.HTTP_429_TOO_MANY_REQUESTS,
            content={"detail": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"}
        )

    return await call_next(request)
```

### è¾“å…¥éªŒè¯

```python
# schemas/user.py
from pydantic import BaseModel, Field, field_validator
import re

class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=20)
    password: str = Field(..., min_length=8, max_length=100)
    email: str = Field(..., max_length=100)

    @field_validator('username')
    @classmethod
    def validate_username(cls, v: str) -> str:
        """éªŒè¯ç”¨æˆ·åæ ¼å¼"""
        if not re.match(r'^[a-zA-Z0-9_]+$', v):
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿')
        return v.lower()

    @field_validator('password')
    @classmethod
    def validate_password(cls, v: str) -> str:
        """éªŒè¯å¯†ç å¼ºåº¦"""
        if not re.search(r'[A-Z]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯')
        if not re.search(r'[a-z]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯')
        if not re.search(r'\d', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        return v

    @field_validator('email')
    @classmethod
    def validate_email(cls, v: str) -> str:
        """éªŒè¯é‚®ç®±æ ¼å¼"""
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(pattern, v):
            raise ValueError('æ— æ•ˆçš„é‚®ç®±æ ¼å¼')
        return v.lower()
```

## ğŸ”’ HTTPS å’Œå®‰å…¨å¤´

### å®‰å…¨å“åº”å¤´

```python
# middleware/security_headers.py
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware

class SecurityHeadersMiddleware(BaseHTTPMiddleware):
    """å®‰å…¨å“åº”å¤´ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        response = await call_next(request)

        # é˜²æ­¢ MIME ç±»å‹å—…æ¢
        response.headers["X-Content-Type-Options"] = "nosniff"

        # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
        response.headers["X-Frame-Options"] = "DENY"

        # XSS ä¿æŠ¤
        response.headers["X-XSS-Protection"] = "1; mode=block"

        # å†…å®¹å®‰å…¨ç­–ç•¥
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data:; "
            "font-src 'self';"
        )

        # HSTSï¼ˆä»… HTTPSï¼‰
        response.headers["Strict-Transport-Security"] = (
            "max-age=31536000; includeSubDomains"
        )

        return response
```

## ğŸ“ ç»ƒä¹ ä»»åŠ¡

1. **å®ç°å¯†ç å¼ºåº¦æ£€æŸ¥** - æ·»åŠ å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
2. **æ·»åŠ ç™»å½•å¤±è´¥é”å®š** - å¤šæ¬¡å¤±è´¥åé”å®šè´¦æˆ·
3. **å®ç°å®¡è®¡æ—¥å¿—** - è®°å½•æ•æ„Ÿæ“ä½œ

## âœ… æ£€æŸ¥ç‚¹

- [ ] ç†è§£å¸¸è§ Web å®‰å…¨å¨èƒ
- [ ] å®ç°è¾“å…¥éªŒè¯
- [ ] ä¿æŠ¤æ•æ„Ÿæ•°æ®
- [ ] å®ç°é€Ÿç‡é™åˆ¶
- [ ] é…ç½®å®‰å…¨å“åº”å¤´

---

**ä¸‹ä¸€ç« **ï¼š[04-ä»£ç é‡æ„ä¸å¯ç»´æŠ¤æ€§.md](./04-ä»£ç é‡æ„ä¸å¯ç»´æŠ¤æ€§.md)
