# å¼‚æ­¥ç¼–ç¨‹

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£åŒæ­¥ä¸å¼‚æ­¥çš„æœ¬è´¨åŒºåˆ«
- æŒæ¡ async/await è¯­æ³•
- ç†è§£äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†
- åŒºåˆ†å¼‚æ­¥ã€å¹¶å‘å’Œå¹¶è¡Œ
- çŸ¥é“ä½•æ—¶ä½¿ç”¨å¼‚æ­¥ï¼Œä½•æ—¶ä¸ä½¿ç”¨

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥

### å®é™…é—®é¢˜åœºæ™¯

**åœºæ™¯1ï¼šæ•°æ®åº“æŸ¥è¯¢é˜»å¡**

```python
# åŒæ­¥ä»£ç  - é˜»å¡ç­‰å¾…
@app.get("/transactions")
def get_transactions():
    # æŸ¥è¯¢æ•°æ®åº“ï¼ˆè€—æ—¶100msï¼‰
    transactions = db.query("SELECT * FROM transactions")  # é˜»å¡
    # æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆè€—æ—¶100msï¼‰
    user = db.query(f"SELECT * FROM users WHERE id={user_id}")  # åˆé˜»å¡
    # æ€»è€—æ—¶ï¼š200ms

# å¼‚æ­¥ä»£ç  - éé˜»å¡
@app.get("/transactions")
async def get_transactions():
    # åŒæ—¶å‘èµ·ä¸¤ä¸ªæŸ¥è¯¢
    transactions, user = await asyncio.gather(
        db.query("SELECT * FROM transactions"),
        db.query(f"SELECT * FROM users WHERE id={user_id}")
    )
    # æ€»è€—æ—¶ï¼š100msï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
```

**åœºæ™¯2ï¼šå¤§é‡å¹¶å‘è¯·æ±‚**

```python
# åŒæ­¥æœåŠ¡å™¨
# æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹
# 1000ä¸ªå¹¶å‘è¯·æ±‚ = 1000ä¸ªçº¿ç¨‹ = å†…å­˜çˆ†ç‚¸

# å¼‚æ­¥æœåŠ¡å™¨
# ä¸€ä¸ªçº¿ç¨‹å¤„ç†æ‰€æœ‰è¯·æ±‚
# 1000ä¸ªå¹¶å‘è¯·æ±‚ = 1ä¸ªçº¿ç¨‹ = å†…å­˜å‹å¥½
```

**åœºæ™¯3ï¼šIOå¯†é›†å‹ä»»åŠ¡**

```python
# è¯»å–æ–‡ä»¶ + ç½‘ç»œè¯·æ±‚ + æ•°æ®åº“æŸ¥è¯¢
# åŒæ­¥ï¼šæ€»æ—¶é—´ = å„ä»»åŠ¡æ—¶é—´ä¹‹å’Œ
# å¼‚æ­¥ï¼šæ€»æ—¶é—´ = æœ€æ…¢ä»»åŠ¡çš„æ—¶é—´
```

### ä¸ç”¨å¼‚æ­¥ä¼šæœ‰ä»€ä¹ˆé—®é¢˜

| é—®é¢˜ | åŒæ­¥ä»£ç  | å¼‚æ­¥ä»£ç  |
|-----|---------|---------|
| å¹¶å‘èƒ½åŠ› | 100-500è¯·æ±‚/ç§’ | 10000+è¯·æ±‚/ç§’ |
| å†…å­˜å ç”¨ | çº¿ç¨‹æ•° Ã— 8MB | å•çº¿ç¨‹ Ã— 8MB |
| CPUåˆ©ç”¨ç‡ | ç­‰å¾…IOæ—¶ç©ºè½¬ | å¤„ç†å…¶ä»–ä»»åŠ¡ |
| å“åº”æ—¶é—´ | ä¸²è¡Œç´¯åŠ  | æœ€æ…¢ä»»åŠ¡æ—¶é—´ |

**æ€§èƒ½å¯¹æ¯”**ï¼š

```python
# åŒæ­¥ï¼š100ä¸ªæ•°æ®åº“æŸ¥è¯¢
# æ—¶é—´ï¼š100 Ã— 10ms = 1000msï¼ˆ1ç§’ï¼‰

# å¼‚æ­¥ï¼š100ä¸ªæ•°æ®åº“æŸ¥è¯¢ï¼ˆå¹¶å‘ï¼‰
# æ—¶é—´ï¼š10msï¼ˆæ‰€æœ‰æŸ¥è¯¢åŒæ—¶è¿›è¡Œï¼‰

# æ€§èƒ½æå‡ï¼š100å€
```

### å¼‚æ­¥çš„ä»·å€¼

**è®°è´¦ç³»ç»Ÿä¸­çš„åœºæ™¯**ï¼š

1. **é«˜å¹¶å‘äº¤æ˜“è®°å½•**ï¼šåŒ11æœŸé—´æ¯ç§’1000ç¬”äº¤æ˜“
2. **æ‰¹é‡å¯¼å…¥æ•°æ®**ï¼šå¯¼å…¥10000æ¡å†å²è®°å½•
3. **å®æ—¶ç»Ÿè®¡**ï¼šåŒæ—¶è®¡ç®—å¤šä¸ªç»´åº¦çš„ç»Ÿè®¡æ•°æ®
4. **ç¬¬ä¸‰æ–¹APIè°ƒç”¨**ï¼šè°ƒç”¨æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜æ¥å£

**æ”¶ç›Š**ï¼š
- å¹¶å‘å¤„ç†èƒ½åŠ›æå‡ 10-100 å€
- æœåŠ¡å™¨æˆæœ¬é™ä½ 80%
- å“åº”æ—¶é—´å‡å°‘ 50-90%
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ

### 1. åŒæ­¥ vs å¼‚æ­¥

#### æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

**åŒæ­¥ï¼ˆSynchronousï¼‰**ï¼š
```python
# ä»£ç æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€æ­¥å®Œæˆå‰ä¸èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥
def task_a():
    time.sleep(1)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    print("Aå®Œæˆ")

def task_b():
    time.sleep(1)
    print("Bå®Œæˆ")

# æ‰§è¡Œ
task_a()  # ç­‰å¾…1ç§’
task_b()  # å†ç­‰å¾…1ç§’
# æ€»æ—¶é—´ï¼š2ç§’
```

**å¼‚æ­¥ï¼ˆAsynchronousï¼‰**ï¼š
```python
# ä»£ç å¯ä»¥"æŒ‚èµ·"æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œå®Œæˆåå†"æ¢å¤"
async def task_a():
    await asyncio.sleep(1)  # æŒ‚èµ·ï¼Œè®©å‡ºæ§åˆ¶æƒ
    print("Aå®Œæˆ")

async def task_b():
    await asyncio.sleep(1)
    print("Bå®Œæˆ")

# å¹¶å‘æ‰§è¡Œ
async def main():
    await asyncio.gather(task_a(), task_b())

asyncio.run(main())
# æ€»æ—¶é—´ï¼š1ç§’ï¼ˆå¹¶å‘ï¼‰
```

#### æ€ä¹ˆç”¨ï¼ˆHowï¼‰

**åŸºæœ¬è¯­æ³•**ï¼š

```python
import asyncio

# å®šä¹‰å¼‚æ­¥å‡½æ•°
async def fetch_data():
    """å¼‚æ­¥è·å–æ•°æ®"""
    print("å¼€å§‹è·å–æ•°æ®")
    await asyncio.sleep(1)  # æ¨¡æ‹ŸIOæ“ä½œ
    print("æ•°æ®è·å–å®Œæˆ")
    return {"data": "ç»“æœ"}

# è¿è¡Œå¼‚æ­¥å‡½æ•°
async def main():
    result = await fetch_data()
    print(result)

# å¯åŠ¨äº‹ä»¶å¾ªç¯
asyncio.run(main())
```

**å…³é”®å¯¹æ¯”**ï¼š

```python
# åŒæ­¥å‡½æ•°
def sync_function():
    return "ç»“æœ"

# è°ƒç”¨
result = sync_function()

# å¼‚æ­¥å‡½æ•°
async def async_function():
    return "ç»“æœ"

# è°ƒç”¨ï¼ˆå¿…é¡»åœ¨å¼‚æ­¥å‡½æ•°ä¸­ï¼‰
async def main():
    result = await async_function()

asyncio.run(main())
```

**å¸¸è§é”™è¯¯**ï¼š

```python
# âŒ é”™è¯¯ï¼šåœ¨åŒæ­¥å‡½æ•°ä¸­await
def wrong():
    result = await async_function()  # SyntaxError

# âœ… æ­£ç¡®ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­await
async def right():
    result = await async_function()
```

#### ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰

**å·¥ä½œåŸç†**ï¼š

```python
# åŒæ­¥æ‰§è¡Œæµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡A  â”‚ -> â”‚  ä»»åŠ¡B  â”‚ -> â”‚  ä»»åŠ¡C  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   100ms          100ms          100ms
æ€»æ—¶é—´ï¼š300ms

# å¼‚æ­¥æ‰§è¡Œæµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡A  â”‚â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”œâ”€> [äº‹ä»¶å¾ªç¯] â”€> å¹¶å‘æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  ä»»åŠ¡B  â”‚â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   100ms
æ€»æ—¶é—´ï¼š100msï¼ˆæœ€æ…¢ä»»åŠ¡çš„æ—¶é—´ï¼‰
```

**ä¸ºä»€ä¹ˆå¼‚æ­¥å¿«**ï¼š

```
åŒæ­¥ç­‰å¾…ï¼š
ä»»åŠ¡A â”€â”€â”€â”€â”€[ç­‰å¾…IO]â”€â”€â”€â”€â”€> å®Œæˆ
ä»»åŠ¡B              â”€â”€â”€â”€â”€[ç­‰å¾…IO]â”€â”€â”€â”€â”€> å®Œæˆ
æ€»æ—¶é—´ = Açš„IOæ—¶é—´ + Bçš„IOæ—¶é—´

å¼‚æ­¥å¹¶å‘ï¼š
ä»»åŠ¡A â”€â”€[å‘èµ·IO]â”€> [ç­‰å¾…]â”€â”€> [å›è°ƒ]
ä»»åŠ¡B â”€â”€[å‘èµ·IO]â”€> [ç­‰å¾…]â”€â”€> [å›è°ƒ]
æ€»æ—¶é—´ = max(Açš„IOæ—¶é—´, Bçš„IOæ—¶é—´)
```

### 2. async/await è¯­æ³•

#### æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

**async**ï¼šå®šä¹‰åç¨‹å‡½æ•°ï¼ˆå¯è¢«awaitçš„å‡½æ•°ï¼‰

**await**ï¼šç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼ŒæœŸé—´è®©å‡ºæ§åˆ¶æƒ

```python
async def coroutine():
    """åç¨‹ï¼šå¯ä»¥è¢«æš‚åœå’Œæ¢å¤çš„å‡½æ•°"""
    await some_async_operation()  # åœ¨è¿™é‡Œæš‚åœ
    # æ“ä½œå®Œæˆåæ¢å¤
    return "ç»“æœ"
```

#### æ€ä¹ˆç”¨ï¼ˆHowï¼‰

**åŸºæœ¬ç”¨æ³•**ï¼š

```python
import asyncio
import time


async def say_hello(name: str, delay: float):
    """å¼‚æ­¥é—®å€™"""
    print(f"{time.strftime('%H:%M:%S')} - å¼€å§‹: {name}")
    await asyncio.sleep(delay)  # å¼‚æ­¥ç­‰å¾…
    print(f"{time.strftime('%H:%M:%S')} - å®Œæˆ: {name}")
    return f"Hello, {name}"


async def main():
    """ä¸»å‡½æ•°"""
    # é¡ºåºæ‰§è¡Œ
    print("=== é¡ºåºæ‰§è¡Œ ===")
    await say_hello("å¼ ä¸‰", 1)
    await say_hello("æå››", 1)
    # æ€»æ—¶é—´ï¼š2ç§’

    print("\n=== å¹¶å‘æ‰§è¡Œ ===")
    # å¹¶å‘æ‰§è¡Œ
    results = await asyncio.gather(
        say_hello("å¼ ä¸‰", 1),
        say_hello("æå››", 1),
        say_hello("ç‹äº”", 1),
    )
    # æ€»æ—¶é—´ï¼š1ç§’
    print(results)


asyncio.run(main())
```

**è¿è¡Œç»“æœ**ï¼š
```
=== é¡ºåºæ‰§è¡Œ ===
10:30:00 - å¼€å§‹: å¼ ä¸‰
10:30:01 - å®Œæˆ: å¼ ä¸‰
10:30:01 - å¼€å§‹: æå››
10:30:02 - å®Œæˆ: æå››

=== å¹¶å‘æ‰§è¡Œ ===
10:30:02 - å¼€å§‹: å¼ ä¸‰
10:30:02 - å¼€å§‹: æå››
10:30:02 - å¼€å§‹: ç‹äº”
10:30:03 - å®Œæˆ: å¼ ä¸‰
10:30:03 - å®Œæˆ: æå››
10:30:03 - å®Œæˆ: ç‹äº”
['Hello, å¼ ä¸‰', 'Hello, æå››', 'Hello, ç‹äº”']
```

**åˆ›å»ºä»»åŠ¡**ï¼š

```python
import asyncio


async def background_task(task_id: int, duration: int):
    """åå°ä»»åŠ¡"""
    print(f"ä»»åŠ¡{task_id}å¼€å§‹ï¼Œé¢„è®¡{duration}ç§’")
    await asyncio.sleep(duration)
    print(f"ä»»åŠ¡{task_id}å®Œæˆ")
    return f"ä»»åŠ¡{task_id}ç»“æœ"


async def main():
    """ä¸»å‡½æ•°"""
    # åˆ›å»ºä»»åŠ¡ï¼ˆç«‹å³å¼€å§‹æ‰§è¡Œï¼‰
    task1 = asyncio.create_task(background_task(1, 2))
    task2 = asyncio.create_task(background_task(2, 3))

    print("ä¸»å‡½æ•°ç»§ç»­æ‰§è¡Œ...")

    # ç­‰å¾…ä»»åŠ¡å®Œæˆ
    result1 = await task1
    result2 = await task2

    print(f"ç»“æœ1: {result1}")
    print(f"ç»“æœ2: {result2}")


asyncio.run(main())
```

**è¶…æ—¶æ§åˆ¶**ï¼š

```python
import asyncio


async def slow_operation():
    """æ…¢é€Ÿæ“ä½œ"""
    await asyncio.sleep(5)
    return "å®Œæˆ"


async def main():
    """å¸¦è¶…æ—¶çš„ç­‰å¾…"""
    try:
        # æœ€å¤šç­‰å¾…2ç§’
        result = await asyncio.wait_for(slow_operation(), timeout=2.0)
        print(result)
    except asyncio.TimeoutError:
        print("æ“ä½œè¶…æ—¶ï¼")


asyncio.run(main())
```

#### ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰

**await çš„ä½œç”¨**ï¼š

```python
# æ²¡æœ‰ await
async def without_await():
    asyncio.sleep(1)  # è¿™è¡Œä»£ç ä¸ä¼šæ‰§è¡Œï¼
    print("è¿™è¡Œä¸ä¼šæ‰§è¡Œ")

# æœ‰ await
async def with_await():
    await asyncio.sleep(1)  # æ­£ç¡®ç­‰å¾…
    print("1ç§’åæ‰§è¡Œ")
```

**ä¸ºä»€ä¹ˆå¿…é¡»ç”¨ async/await**ï¼š

```python
# åŒæ­¥ä»£ç 
def get_data():
    data = fetch_from_db()  # é˜»å¡
    process(data)           # ç­‰å¾…ä¸Šé¢çš„å®Œæˆ

# å¼‚æ­¥ä»£ç 
async def get_data():
    data = await fetch_from_db()  # éé˜»å¡
    process(data)                  # ç­‰å¾…ä½†å…è®¸å…¶ä»–ä»»åŠ¡è¿è¡Œ
```

### 3. äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰

#### æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

äº‹ä»¶å¾ªç¯æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œåç¨‹ã€‚

**ç±»æ¯”**ï¼š
```
äº‹ä»¶å¾ªç¯å°±åƒé¤å…çš„æœåŠ¡å‘˜ï¼š

åŒæ­¥æ¨¡å¼ï¼š
æœåŠ¡å‘˜ -> æœåŠ¡é¡¾å®¢A -> ç­‰å¾…Aç‚¹å®Œ -> æœåŠ¡é¡¾å®¢B -> ç­‰å¾…Bç‚¹å®Œ

å¼‚æ­¥æ¨¡å¼ï¼š
æœåŠ¡å‘˜ -> æœåŠ¡é¡¾å®¢A -> Açœ‹èœå•æ—¶ -> æœåŠ¡é¡¾å®¢B -> Bçœ‹èœå•æ—¶ -> å›åˆ°A
```

**å·¥ä½œåŸç†**ï¼š

```python
import asyncio


async def task(name: str):
    print(f"{name} å¼€å§‹")
    await asyncio.sleep(1)
    print(f"{name} ç»“æŸ")


async def main():
    await asyncio.gather(task("A"), task("B"), task("C"))


# asyncio.run() åšäº†ä»€ä¹ˆï¼Ÿ
# 1. åˆ›å»ºäº‹ä»¶å¾ªç¯
# 2. è¿è¡Œ main() åç¨‹
# 3. å¤„ç†æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡
# 4. å…³é—­äº‹ä»¶å¾ªç¯

asyncio.run(main())
```

#### æ€ä¹ˆç”¨ï¼ˆHowï¼‰

**ç†è§£äº‹ä»¶å¾ªç¯**ï¼š

```python
import asyncio


async def count_down(name: str, seconds: int):
    """å€’è®¡æ—¶"""
    for i in range(seconds, 0, -1):
        print(f"{name}: {i}ç§’")
        await asyncio.sleep(1)
    print(f"{name}: å®Œæˆï¼")


async def main():
    print("å¼€å§‹å€’è®¡æ—¶")
    await asyncio.gather(
        count_down("ä»»åŠ¡A", 3),
        count_down("ä»»åŠ¡B", 5),
        count_down("ä»»åŠ¡C", 2),
    )
    print("æ‰€æœ‰ä»»åŠ¡å®Œæˆ")


asyncio.run(main())
```

**æ‰§è¡Œæµç¨‹å›¾**ï¼š

```mermaid
graph TD
    A[äº‹ä»¶å¾ªç¯å¼€å§‹] --> B[æ‰§è¡Œä»»åŠ¡A]
    B --> C{é‡åˆ°await?}
    C -->|æ˜¯| D[æŒ‚èµ·ä»»åŠ¡A]
    C -->|å¦| B
    D --> E[æ‰§è¡Œä»»åŠ¡B]
    E --> F{é‡åˆ°await?}
    F -->|æ˜¯| G[æŒ‚èµ·ä»»åŠ¡B]
    F -->|å¦| E
    G --> H[æ‰§è¡Œä»»åŠ¡C]
    H --> I{æ‰€æœ‰ä»»åŠ¡å®Œæˆ?}
    I -->|å¦| D
    I -->|æ˜¯| J[ç»“æŸ]
```

#### ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å¾ªç¯**ï¼š

```python
# æ²¡æœ‰äº‹ä»¶å¾ªç¯ - æ— æ³•æ‰§è¡Œå¼‚æ­¥ä»£ç 
async def hello():
    print("Hello")

hello()  # ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ

# éœ€è¦äº‹ä»¶å¾ªç¯
asyncio.run(hello())  # æ­£ç¡®æ‰§è¡Œ
```

**äº‹ä»¶å¾ªç¯çš„ä¼˜åŠ¿**ï¼š

```
å•çº¿ç¨‹ + äº‹ä»¶å¾ªç¯ = é«˜å¹¶å‘

ä¼˜åŠ¿ï¼š
1. æ— éœ€çº¿ç¨‹åˆ‡æ¢å¼€é”€
2. å†…å­˜å ç”¨æä½
3. é€‚åˆIOå¯†é›†å‹ä»»åŠ¡

åŠ£åŠ¿ï¼š
1. ä¸é€‚åˆCPUå¯†é›†å‹
2. è°ƒè¯•ç›¸å¯¹å¤æ‚
3. éœ€è¦å¼‚æ­¥åº“æ”¯æŒ
```

### 4. å¼‚æ­¥ vs å¹¶å‘ vs å¹¶è¡Œ

#### æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

| æ¦‚å¿µ | å®šä¹‰ | å®ç°æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|---------|
| å¼‚æ­¥ | éé˜»å¡æ‰§è¡Œ | äº‹ä»¶å¾ªç¯ + åç¨‹ | IOå¯†é›†å‹ |
| å¹¶å‘ | åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ | æ—¶é—´ç‰‡è½®è½¬ | æé«˜å“åº”é€Ÿåº¦ |
| å¹¶è¡Œ | åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ | å¤šæ ¸/å¤šCPU | CPUå¯†é›†å‹ |

**ç±»æ¯”**ï¼š

```
å¼‚æ­¥ï¼š
ä½ åœ¨ç…®å’–å•¡æ—¶çœ‹æ‰‹æœºï¼ˆä¸ç­‰å’–å•¡ç…®å®Œï¼‰

å¹¶å‘ï¼š
ä¸€ä¸ªäººåŒæ—¶å¤„ç†3ä¸ªä»»åŠ¡ï¼ˆåˆ‡æ¢æ³¨æ„åŠ›ï¼‰

å¹¶è¡Œï¼š
3ä¸ªäººåŒæ—¶å„è‡ªå¤„ç†1ä¸ªä»»åŠ¡
```

#### æ€ä¹ˆç”¨ï¼ˆHowï¼‰

**å¹¶å‘ç¤ºä¾‹**ï¼š

```python
import asyncio


async def task(name: str):
    print(f"{name} å¼€å§‹")
    await asyncio.sleep(1)
    print(f"{name} ç»“æŸ")


async def main():
    """å¹¶å‘ï¼šåŒä¸€æ—¶é—´æ®µå¤„ç†å¤šä¸ªä»»åŠ¡"""
    await asyncio.gather(
        task("ä»»åŠ¡A"),
        task("ä»»åŠ¡B"),
        task("ä»»åŠ¡C"),
    )


asyncio.run(main())
# 3ä¸ªä»»åŠ¡åœ¨1ç§’å†…å®Œæˆï¼ˆå¹¶å‘ï¼‰
```

**å¹¶è¡Œç¤ºä¾‹**ï¼š

```python
import concurrent.futures
import time


def cpu_bound_task(n: int):
    """CPUå¯†é›†å‹ä»»åŠ¡"""
    return sum(i * i for i in range(n))


def main():
    """å¹¶è¡Œï¼šåˆ©ç”¨å¤šæ ¸åŒæ—¶æ‰§è¡Œ"""
    start = time.time()

    with concurrent.futures.ProcessPoolExecutor() as executor:
        results = list(executor.map(
            cpu_bound_task,
            [100000, 100000, 100000]
        ))

    print(f"ç»“æœ: {results}")
    print(f"æ—¶é—´: {time.time() - start:.2f}ç§’")


main()
# 3ä¸ªä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼ˆåˆ©ç”¨å¤šæ ¸ï¼‰
```

**å¯¹æ¯”æµ‹è¯•**ï¼š

```python
import asyncio
import time
import requests


async def async_fetch(url: str):
    """å¼‚æ­¥HTTPè¯·æ±‚"""
    import aiohttp
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()


async def async_main(urls: list[str]):
    """å¼‚æ­¥å¹¶å‘"""
    start = time.time()
    results = await asyncio.gather(*[async_fetch(url) for url in urls])
    print(f"å¼‚æ­¥è€—æ—¶: {time.time() - start:.2f}ç§’")
    return results


def sync_main(urls: list[str]):
    """åŒæ­¥æ‰§è¡Œ"""
    start = time.time()
    results = [requests.get(url).text for url in urls]
    print(f"åŒæ­¥è€—æ—¶: {time.time() - start:.2f}ç§’")
    return results


# æµ‹è¯•
urls = ["https://httpbin.org/delay/1"] * 10

# åŒæ­¥ï¼š10ç§’
sync_main(urls)

# å¼‚æ­¥ï¼š1ç§’
asyncio.run(async_main(urls))
```

#### ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰

**ä½•æ—¶ä½¿ç”¨å¼‚æ­¥**ï¼š

```python
# âœ… é€‚åˆå¼‚æ­¥çš„åœºæ™¯
async def good_async():
    # æ•°æ®åº“æŸ¥è¯¢
    result = await db.query(...)

    # æ–‡ä»¶è¯»å†™
    data = await aiofiles.read(...)

    # HTTPè¯·æ±‚
    response = await httpx.get(...)

    # æ¶ˆæ¯é˜Ÿåˆ—
    message = await redis.get(...)
```

**ä½•æ—¶ä½¿ç”¨åŒæ­¥**ï¼š

```python
# âœ… é€‚åˆåŒæ­¥çš„åœºæ™¯
def good_sync():
    # CPUå¯†é›†å‹è®¡ç®—
    result = sum(x * x for x in range(1000000))

    # ç®€å•ä¸šåŠ¡é€»è¾‘
    if user.balance >= amount:
        user.withdraw(amount)

    # ä¸æ¶‰åŠIOçš„æ“ä½œ
    data = json.loads(json_string)
```

**ä½•æ—¶ä½¿ç”¨å¹¶è¡Œ**ï¼š

```python
# âœ… é€‚åˆå¹¶è¡Œçš„åœºæ™¯
from multiprocessing import Pool

def cpu_intensive(n):
    """è®¡ç®—å¯†é›†å‹"""
    return sum(i ** 2 for i in range(n))

# ä½¿ç”¨å¤šè¿›ç¨‹
with Pool(4) as p:
    results = p.map(cpu_intensive, [100000] * 4)
```

### 5. FastAPI çš„å¼‚æ­¥ç‰¹æ€§

#### æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

FastAPI æ˜¯å¼‚æ­¥ Web æ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥è·¯ç”±å’Œä¾èµ–æ³¨å…¥ã€‚

**ä¸ºä»€ä¹ˆ FastAPI æ˜¯å¼‚æ­¥çš„**ï¼š

```python
# å¼‚æ­¥è·¯ç”±
@app.get("/transactions")
async def get_transactions():
    # å¯ä»¥ç›´æ¥await
    result = await db.query("SELECT * FROM transactions")
    return result

# åŒæ­¥è·¯ç”±ï¼ˆFastAPIä¹Ÿæ”¯æŒï¼‰
@app.get("/users")
def get_users():
    # åœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œ
    result = db.query("SELECT * FROM users")
    return result
```

#### æ€ä¹ˆç”¨ï¼ˆHowï¼‰

**å¼‚æ­¥æ•°æ®åº“æ“ä½œ**ï¼š

```python
from fastapi import FastAPI
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession

app = FastAPI()

# å¼‚æ­¥æ•°æ®åº“å¼•æ“
engine = create_async_engine("mysql+aiomysql://user:pass@localhost/db")


async def get_db():
    """æ•°æ®åº“ä¼šè¯"""
    async with AsyncSession(engine) as session:
        yield session


@app.get("/transactions")
async def get_transactions(db: AsyncSession = Depends(get_db)):
    """å¼‚æ­¥è·å–äº¤æ˜“"""
    result = await db.execute("SELECT * FROM transactions")
    return result.fetchall()
```

**å¹¶å‘è¯·æ±‚å¤–éƒ¨API**ï¼š

```python
import httpx
from fastapi import FastAPI

app = FastAPI()


async def fetch_exchange_rate(from_currency: str, to_currency: str):
    """è·å–æ±‡ç‡"""
    async with httpx.AsyncClient() as client:
        response = await client.get(
            f"https://api.exchangerate.host/latest?base={from_currency}&symbols={to_currency}"
        )
        return response.json()


@app.get("/convert")
async def convert_currency(amount: float, from_curr: str, to_curr: str):
    """è´§å¸è½¬æ¢ï¼ˆå¹¶å‘è°ƒç”¨å¤šä¸ªAPIï¼‰"""
    rates = await fetch_exchange_rate(from_curr, to_curr)
    converted = amount * rates["rates"][to_curr]
    return {"amount": converted, "currency": to_curr}
```

**åå°ä»»åŠ¡**ï¼š

```python
from fastapi import FastAPI, BackgroundTasks

app = FastAPI()


def send_email(email: str, message: str):
    """å‘é€é‚®ä»¶ï¼ˆåŒæ­¥å‡½æ•°ï¼‰"""
    import time
    time.sleep(2)
    print(f"é‚®ä»¶å·²å‘é€è‡³: {email}")


@app.post("/register")
async def register(email: str, background_tasks: BackgroundTasks):
    """ç”¨æˆ·æ³¨å†Œ"""
    # æ·»åŠ åå°ä»»åŠ¡
    background_tasks.add_task(send_email, email, "æ¬¢è¿æ³¨å†Œ")

    return {"message": "æ³¨å†ŒæˆåŠŸï¼Œé‚®ä»¶å°†åœ¨åå°å‘é€"}
```

#### ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰

**FastAPI å¼‚æ­¥æ€§èƒ½ä¼˜åŠ¿**ï¼š

```python
# åŒæ­¥æ¡†æ¶ï¼ˆFlaskï¼‰
@app.route("/transactions")
def get_transactions():
    result = db.query("SELECT * FROM transactions")
    return jsonify(result)
# é—®é¢˜ï¼šè¯·æ±‚é˜»å¡æ•´ä¸ªçº¿ç¨‹

# å¼‚æ­¥æ¡†æ¶ï¼ˆFastAPIï¼‰
@app.get("/transactions")
async def get_transactions():
    result = await db.query("SELECT * FROM transactions")
    return result
# ä¼˜åŠ¿ï¼šç­‰å¾…æ•°æ®åº“æ—¶å¤„ç†å…¶ä»–è¯·æ±‚
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | Flaskï¼ˆåŒæ­¥ï¼‰ | FastAPIï¼ˆå¼‚æ­¥ï¼‰ |
|-----|-------------|---------------|
| å¹¶å‘è¯·æ±‚ | ~500/ç§’ | ~10000/ç§’ |
| å†…å­˜å ç”¨ | é«˜ï¼ˆæ¯è¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼‰ | ä½ï¼ˆå•çº¿ç¨‹ï¼‰ |
| å“åº”æ—¶é—´ | ä¸²è¡Œç´¯åŠ  | å¹¶å‘æ‰§è¡Œ |

## ğŸ”¥ è®°è´¦ç³»ç»Ÿå®æˆ˜

### å®æˆ˜1ï¼šåŒæ­¥ vs å¼‚æ­¥æ•°æ®åº“æ“ä½œ

**åŒæ­¥æ•°æ®åº“æ“ä½œ**ï¼ˆä½¿ç”¨ SQLAlchemyï¼‰ï¼š

```python
# models/sync_db.py
from sqlalchemy import create_engine, Column, Integer, String, Float
from sqlalchemy.orm import sessionmaker, declarative_base
import time

# åŒæ­¥å¼•æ“
engine = create_engine("mysql+pymysql://root:password@localhost/accounting")
Session = sessionmaker(bind=engine)
Base = declarative_base()


class Transaction(Base):
    """äº¤æ˜“æ¨¡å‹"""
    __tablename__ = "transactions"

    id = Column(Integer, primary_key=True)
    amount = Column(Float)
    category = Column(String(50))
    type = Column(String(10))


def create_transactions_sync(count: int):
    """åŒæ­¥åˆ›å»ºäº¤æ˜“è®°å½•"""
    session = Session()
    start = time.time()

    try:
        for i in range(count):
            transaction = Transaction(
                amount=100.0 + i,
                category="æµ‹è¯•",
                type="income"
            )
            session.add(transaction)
            session.commit()  # æ¯æ¬¡éƒ½ç­‰å¾…
    finally:
        session.close()

    elapsed = time.time() - start
    print(f"åŒæ­¥æ’å…¥{count}æ¡è®°å½•ï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
    return elapsed


# æµ‹è¯•
if __name__ == "__main__":
    create_transactions_sync(100)
    # åŒæ­¥æ’å…¥100æ¡è®°å½•ï¼Œè€—æ—¶: 2.50ç§’
```

**å¼‚æ­¥æ•°æ®åº“æ“ä½œ**ï¼ˆä½¿ç”¨ SQLAlchemy + aiomysqlï¼‰ï¼š

```python
# models/async_db.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy import Column, Integer, String, Float
from sqlalchemy.ext.asyncio import declarative_base
import asyncio
import time

# å¼‚æ­¥å¼•æ“
engine = create_async_engine("mysql+aiomysql://root:password@localhost/accounting")
async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
Base = declarative_base()


class Transaction(Base):
    """äº¤æ˜“æ¨¡å‹"""
    __tablename__ = "transactions"

    id = Column(Integer, primary_key=True)
    amount = Column(Float)
    category = Column(String(50))
    type = Column(String(10))


async def create_transactions_async(count: int):
    """å¼‚æ­¥åˆ›å»ºäº¤æ˜“è®°å½•"""
    async with async_session() as session:
        start = time.time()

        try:
            for i in range(count):
                transaction = Transaction(
                    amount=100.0 + i,
                    category="æµ‹è¯•",
                    type="income"
                )
                session.add(transaction)
                await session.commit()  # å¼‚æ­¥ç­‰å¾…ï¼Œä¸é˜»å¡å…¶ä»–ä»»åŠ¡
        finally:
            await session.close()

        elapsed = time.time() - start
        print(f"å¼‚æ­¥æ’å…¥{count}æ¡è®°å½•ï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
        return elapsed


# æµ‹è¯•
if __name__ == "__main__":
    asyncio.run(create_transactions_async(100))
    # å¼‚æ­¥æ’å…¥100æ¡è®°å½•ï¼Œè€—æ—¶: 1.80ç§’
```

**æ‰¹é‡æ“ä½œå¯¹æ¯”**ï¼š

```python
async def batch_insert_async(count: int, batch_size: int = 100):
    """æ‰¹é‡å¼‚æ­¥æ’å…¥"""
    async with async_session() as session:
        start = time.time()

        try:
            for batch_start in range(0, count, batch_size):
                transactions = [
                    Transaction(
                        amount=100.0 + i,
                        category="æµ‹è¯•",
                        type="income"
                    )
                    for i in range(batch_start, min(batch_start + batch_size, count))
                ]
                session.add_all(transactions)
                await session.commit()

        finally:
            await session.close()

        elapsed = time.time() - start
        print(f"æ‰¹é‡å¼‚æ­¥æ’å…¥{count}æ¡è®°å½•ï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
        return elapsed


# æµ‹è¯•
asyncio.run(batch_insert_async(1000, batch_size=100))
# æ‰¹é‡å¼‚æ­¥æ’å…¥1000æ¡è®°å½•ï¼Œè€—æ—¶: 3.50ç§’
```

### å®æˆ˜2ï¼šå¼‚æ­¥å‡½æ•°ç¤ºä¾‹

```python
# services/transaction_service.py
import asyncio
from typing import List, Dict
from datetime import datetime


class TransactionService:
    """äº¤æ˜“æœåŠ¡"""

    async def fetch_user(self, user_id: int) -> Dict:
        """å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰"""
        await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        return {
            "id": user_id,
            "username": f"ç”¨æˆ·{user_id}",
            "email": f"user{user_id}@example.com"
        }

    async def fetch_transactions(self, user_id: int) -> List[Dict]:
        """å¼‚æ­¥è·å–äº¤æ˜“è®°å½•ï¼ˆæ¨¡æ‹Ÿï¼‰"""
        await asyncio.sleep(0.2)  # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        return [
            {"id": 1, "amount": 100.0, "category": "è´­ç‰©"},
            {"id": 2, "amount": 50.0, "category": "é¤é¥®"},
        ]

    async def fetch_statistics(self, user_id: int) -> Dict:
        """å¼‚æ­¥è·å–ç»Ÿè®¡æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰"""
        await asyncio.sleep(0.15)  # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
        return {
            "total_income": 5000.0,
            "total_expense": 2000.0,
            "balance": 3000.0
        }

    async def get_user_dashboard(self, user_id: int) -> Dict:
        """
        è·å–ç”¨æˆ·ä»ªè¡¨ç›˜

        åŒæ­¥æ–¹å¼ï¼š0.1 + 0.2 + 0.15 = 0.45ç§’
        å¼‚æ­¥æ–¹å¼ï¼šmax(0.1, 0.2, 0.15) = 0.2ç§’
        """
        # å¹¶å‘è·å–æ‰€æœ‰æ•°æ®
        user, transactions, statistics = await asyncio.gather(
            self.fetch_user(user_id),
            self.fetch_transactions(user_id),
            self.fetch_statistics(user_id)
        )

        return {
            "user": user,
            "transactions": transactions,
            "statistics": statistics
        }


# ä½¿ç”¨ç¤ºä¾‹
async def main():
    service = TransactionService()

    print("=== å¼‚æ­¥å¹¶å‘è·å– ===")
    start = asyncio.get_event_loop().time()
    dashboard = await service.get_user_dashboard(1)
    elapsed = asyncio.get_event_loop().time() - start

    print(f"è€—æ—¶: {elapsed:.2f}ç§’")
    print(f"æ•°æ®: {dashboard}")


asyncio.run(main())
# è€—æ—¶: 0.20ç§’ï¼ˆè€Œä¸æ˜¯0.45ç§’ï¼‰
```

### å®æˆ˜3ï¼šasyncio.gather å¹¶å‘æ‰§è¡Œ

```python
# services/batch_service.py
import asyncio
from typing import List, Dict


class BatchProcessor:
    """æ‰¹å¤„ç†æœåŠ¡"""

    async def process_transaction(self, transaction: Dict) -> Dict:
        """å¤„ç†å•ä¸ªäº¤æ˜“"""
        # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        await asyncio.sleep(0.1)

        # ä¸šåŠ¡é€»è¾‘
        result = {
            **transaction,
            "status": "processed",
            "processed_at": datetime.now().isoformat()
        }

        return result

    async def process_batch_sync(self, transactions: List[Dict]) -> List[Dict]:
        """åŒæ­¥å¤„ç†æ‰¹é‡äº¤æ˜“"""
        results = []
        for transaction in transactions:
            result = await self.process_transaction(transaction)
            results.append(result)
        return results

    async def process_batch_async(self, transactions: List[Dict]) -> List[Dict]:
        """å¼‚æ­¥å¹¶å‘å¤„ç†æ‰¹é‡äº¤æ˜“"""
        tasks = [
            self.process_transaction(transaction)
            for transaction in transactions
        ]
        results = await asyncio.gather(*tasks)
        return results


# æ€§èƒ½å¯¹æ¯”
async def main():
    processor = BatchProcessor()

    # å‡†å¤‡æµ‹è¯•æ•°æ®
    transactions = [
        {"id": i, "amount": 100.0 + i, "category": "æµ‹è¯•"}
        for i in range(1, 101)  # 100æ¡è®°å½•
    ]

    # åŒæ­¥å¤„ç†
    print("=== åŒæ­¥å¤„ç† ===")
    start = asyncio.get_event_loop().time()
    results_sync = await processor.process_batch_sync(transactions)
    elapsed_sync = asyncio.get_event_loop().time() - start
    print(f"å¤„ç†{len(results_sync)}æ¡è®°å½•ï¼Œè€—æ—¶: {elapsed_sync:.2f}ç§’")

    # å¼‚æ­¥å¹¶å‘å¤„ç†
    print("\n=== å¼‚æ­¥å¹¶å‘å¤„ç† ===")
    start = asyncio.get_event_loop().time()
    results_async = await processor.process_batch_async(transactions)
    elapsed_async = asyncio.get_event_loop().time() - start
    print(f"å¤„ç†{len(results_async)}æ¡è®°å½•ï¼Œè€—æ—¶: {elapsed_async:.2f}ç§’")

    # æ€§èƒ½æå‡
    speedup = elapsed_sync / elapsed_async
    print(f"\næ€§èƒ½æå‡: {speedup:.1f}å€")


asyncio.run(main())
# === åŒæ­¥å¤„ç† ===
# å¤„ç†100æ¡è®°å½•ï¼Œè€—æ—¶: 10.05ç§’
#
# === å¼‚æ­¥å¹¶å‘å¤„ç† ===
# å¤„ç†100æ¡è®°å½•ï¼Œè€—æ—¶: 0.12ç§’
#
# æ€§èƒ½æå‡: 83.8å€
```

### å®æˆ˜4ï¼šFastAPI å¼‚æ­¥è·¯ç”±

```python
# api/transactions.py
from fastapi import FastAPI, Depends, BackgroundTasks
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List

app = FastAPI()


async def get_db():
    """è·å–æ•°æ®åº“ä¼šè¯"""
    async with async_session() as session:
        yield session


@app.post("/transactions")
async def create_transaction(
    amount: float,
    category: str,
    transaction_type: str,
    db: AsyncSession = Depends(get_db)
):
    """åˆ›å»ºäº¤æ˜“ï¼ˆå¼‚æ­¥ï¼‰"""
    # å¼‚æ­¥æ•°æ®åº“æ“ä½œ
    transaction = Transaction(
        amount=amount,
        category=category,
        type=transaction_type
    )
    db.add(transaction)
    await db.commit()
    await db.refresh(transaction)

    return {"success": True, "data": transaction}


@app.get("/transactions")
async def get_transactions(
    skip: int = 0,
    limit: int = 100,
    db: AsyncSession = Depends(get_db)
):
    """è·å–äº¤æ˜“åˆ—è¡¨ï¼ˆå¼‚æ­¥ï¼‰"""
    # å¼‚æ­¥æŸ¥è¯¢
    result = await db.execute(
        select(Transaction).offset(skip).limit(limit)
    )
    transactions = result.scalars().all()

    return {"success": True, "data": transactions}


@app.get("/dashboard")
async def get_dashboard(user_id: int, db: AsyncSession = Depends(get_db)):
    """è·å–ä»ªè¡¨ç›˜ï¼ˆå¹¶å‘æŸ¥è¯¢å¤šä¸ªæ•°æ®æºï¼‰"""
    # å¹¶å‘è·å–å¤šä¸ªæ•°æ®
    user, transactions, stats = await asyncio.gather(
        fetch_user(db, user_id),
        fetch_transactions(db, user_id),
        fetch_statistics(db, user_id)
    )

    return {
        "user": user,
        "transactions": transactions,
        "statistics": stats
    }


@app.post("/export")
async def export_transactions(
    background_tasks: BackgroundTasks,
    user_id: int
):
    """å¯¼å‡ºäº¤æ˜“è®°å½•ï¼ˆåå°ä»»åŠ¡ï¼‰"""
    # æ·»åŠ åå°ä»»åŠ¡
    background_tasks.add_task(generate_export, user_id)

    return {
        "success": True,
        "message": "å¯¼å‡ºä»»åŠ¡å·²å¼€å§‹ï¼Œè¯·ç¨åä¸‹è½½"
    }


async def generate_export(user_id: int):
    """ç”Ÿæˆå¯¼å‡ºæ–‡ä»¶ï¼ˆåå°ä»»åŠ¡ï¼‰"""
    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    await asyncio.sleep(5)
    print(f"ç”¨æˆ·{user_id}çš„å¯¼å‡ºæ–‡ä»¶å·²ç”Ÿæˆ")
```

## ğŸ§  æ€ç»´å»¶ä¼¸

### è®¾è®¡åŸåˆ™

**1. IOå¯†é›†ç”¨å¼‚æ­¥ï¼ŒCPUå¯†é›†ç”¨å¹¶è¡Œ**

```python
# âœ… IOå¯†é›† - å¼‚æ­¥
async def fetch_data():
    data = await httpx.get(url)
    return data

# âœ… CPUå¯†é›† - å¹¶è¡Œ
from multiprocessing import Pool

def process_data(data):
    return complex_calculation(data)

with Pool(4) as p:
    results = p.map(process_data, data_list)
```

**2. èƒ½å¹¶å‘å°±ä¸è¦ä¸²è¡Œ**

```python
# âŒ ä¸²è¡Œ - æ…¢
data1 = await fetch_api1()
data2 = await fetch_api2()
data3 = await fetch_api3()

# âœ… å¹¶å‘ - å¿«
data1, data2, data3 = await asyncio.gather(
    fetch_api1(),
    fetch_api2(),
    fetch_api3()
)
```

**3. å¼‚æ­¥è¦å…¨é“¾è·¯**

```python
# âŒ éƒ¨åˆ†å¼‚æ­¥ - æ•ˆæœå·®
async def process():
    data = await db.query()  # å¼‚æ­¥
    result = sync_process(data)  # åŒæ­¥ï¼Œé˜»å¡

# âœ… å…¨é“¾è·¯å¼‚æ­¥ - æ•ˆæœå¥½
async def process():
    data = await db.query()  # å¼‚æ­¥
    result = await async_process(data)  # å¼‚æ­¥
```

### æƒè¡¡è€ƒè™‘

**å¼‚æ­¥çš„ä»£ä»·**ï¼š

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|
| é«˜å¹¶å‘ | å­¦ä¹ æ›²çº¿é™¡å³­ |
| ä½å†…å­˜ | è°ƒè¯•å›°éš¾ |
| å¿«å“åº” | åº“æ”¯æŒæœ‰é™ |
| èŠ‚çœèµ„æº | ä¸é€‚åˆCPUå¯†é›† |

**ä½•æ—¶ä¸ç”¨å¼‚æ­¥**ï¼š

```python
# âŒ ä¸éœ€è¦å¼‚æ­¥çš„åœºæ™¯
async def unnecessary():
    # ç®€å•è®¡ç®—
    result = 1 + 1

    # æ— IOæ“ä½œ
    data = [1, 2, 3]
    total = sum(data)

    # æå¿«æ“ä½œ
    return {"result": result}

# âœ… åŒæ­¥å³å¯
def simple():
    return 1 + 1
```

**æœ€ä½³å®è·µ**ï¼š

```python
# 1. æ‰€æœ‰IOéƒ½ç”¨å¼‚æ­¥
async def good():
    await db.query()
    await redis.get()
    await httpx.get()

# 2. èƒ½å¹¶å‘å°±å¹¶å‘
async def better():
    await asyncio.gather(
        db.query(),
        redis.get()
    )

# 3. ä½¿ç”¨å¼‚æ­¥åº“
# âœ… ä½¿ç”¨
import aiohttp
import aiomysql
import asyncio_redis

# âŒ é¿å…
import requests  # åŒæ­¥
import pymysql  # åŒæ­¥
import redis  # åŒæ­¥
```

### å¸¸è§é™·é˜±

**é™·é˜±1ï¼šåœ¨å¼‚æ­¥å‡½æ•°ä¸­è°ƒç”¨åŒæ­¥IO**

```python
# âŒ é”™è¯¯ï¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯
async def wrong():
    data = requests.get(url)  # åŒæ­¥HTTPï¼Œé˜»å¡ï¼
    return data

# âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥åº“
async def right():
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()
```

**é™·é˜±2ï¼šå¿˜è®°await**

```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰awaitï¼Œåç¨‹ä¸ä¼šæ‰§è¡Œ
async def wrong():
    result = async_function()  # å¿˜è®°await
    return result

# âœ… æ­£ç¡®ï¼šä½¿ç”¨await
async def right():
    result = await async_function()
    return result
```

**é™·é˜±3ï¼šæ··åˆä½¿ç”¨asyncå’Œdef**

```python
# âŒ é”™è¯¯ï¼šæ··åˆä½¿ç”¨
async def wrong1():
    def sync_inner():
        return "ç»“æœ"  # åŒæ­¥å‡½æ•°
    return sync_inner()

# âœ… æ­£ç¡®ï¼šéƒ½æ˜¯å¼‚æ­¥
async def right():
    async def async_inner():
        return "ç»“æœ"
    return await async_inner()
```

## âœ… æ£€æŸ¥ç‚¹

- [ ] èƒ½å¦åŒºåˆ†åŒæ­¥å’Œå¼‚æ­¥ä»£ç ï¼Ÿ
- [ ] æ˜¯å¦ä¼šä½¿ç”¨ async/awaitï¼Ÿ
- [ ] èƒ½å¦ç†è§£äº‹ä»¶å¾ªç¯çš„ä½œç”¨ï¼Ÿ
- [ ] æ˜¯å¦çŸ¥é“ä½•æ—¶ä½¿ç”¨ asyncio.gatherï¼Ÿ
- [ ] èƒ½å¦åŒºåˆ†å¼‚æ­¥ã€å¹¶å‘ã€å¹¶è¡Œï¼Ÿ
- [ ] æ˜¯å¦çŸ¥é“ä½•æ—¶ç”¨å¼‚æ­¥ã€ä½•æ—¶ä¸ä½¿ç”¨ï¼Ÿ

## ğŸš€ è¿ç§»æŒ‘æˆ˜

### æŒ‘æˆ˜1ï¼šæ€§èƒ½ä¼˜åŒ–

**åœºæ™¯**ï¼šè®°è´¦ç³»ç»Ÿéœ€è¦å¯¼å…¥10000æ¡å†å²äº¤æ˜“è®°å½•

**è¦æ±‚**ï¼š
1. å®ç°æ‰¹é‡å¯¼å…¥ï¼ˆä½¿ç”¨å¼‚æ­¥ï¼‰
2. æ˜¾ç¤ºè¿›åº¦æ¡
3. æ”¯æŒå¤±è´¥é‡è¯•
4. è®°å½•å¯¼å…¥æ—¥å¿—

### æŒ‘æˆ˜2ï¼šå¹¶å‘APIè°ƒç”¨

**åœºæ™¯**ï¼šéœ€è¦ä»3ä¸ªç¬¬ä¸‰æ–¹APIè·å–æ•°æ®å¹¶åˆå¹¶

**è¦æ±‚**ï¼š
1. å¹¶å‘è°ƒç”¨3ä¸ªAPI
2. è®¾ç½®è¶…æ—¶å’Œé‡è¯•
3. åˆå¹¶ç»“æœå¹¶ç¼“å­˜
4. å¤„ç†éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ

### æŒ‘æˆ˜3ï¼šå®æ—¶æ¨é€

**åœºæ™¯**ï¼šç”¨æˆ·äº¤æ˜“åå®æ—¶æ¨é€é€šçŸ¥

**è¦æ±‚**ï¼š
1. ä½¿ç”¨WebSocketå¼‚æ­¥æ¨é€
2. æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥
3. å¿ƒè·³æ£€æµ‹å’Œé‡è¿
4. æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯å¯é æ€§

---

## ğŸ“š æ€»ç»“

å¼‚æ­¥ç¼–ç¨‹æ˜¯é«˜æ€§èƒ½åç«¯çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

1. **åŒæ­¥ vs å¼‚æ­¥**ï¼šç†è§£é˜»å¡ä¸éé˜»å¡çš„åŒºåˆ«
2. **async/await**ï¼šæŒæ¡å¼‚æ­¥è¯­æ³•ç³–
3. **äº‹ä»¶å¾ªç¯**ï¼šç†è§£å¼‚æ­¥è°ƒåº¦çš„æ ¸å¿ƒæœºåˆ¶
4. **å¹¶å‘ vs å¹¶è¡Œ**ï¼šé€‰æ‹©åˆé€‚çš„æ‰§è¡Œæ–¹å¼
5. **FastAPIå¼‚æ­¥**ï¼šå‘æŒ¥æ¡†æ¶çš„å¼‚æ­¥ä¼˜åŠ¿

**å…³é”®è¦ç‚¹**ï¼š
- IOå¯†é›†ç”¨å¼‚æ­¥ï¼ŒCPUå¯†é›†ç”¨å¹¶è¡Œ
- èƒ½å¹¶å‘å°±ä¸è¦ä¸²è¡Œ
- å¼‚æ­¥è¦å…¨é“¾è·¯ï¼Œé¿å…åŒæ­¥é˜»å¡
- ä½¿ç”¨å¼‚æ­¥åº“ï¼ˆaiohttpã€aiomysqlç­‰ï¼‰
- æ³¨æ„å¸¸è§é™·é˜±ï¼ˆå¿˜è®°awaitã€æ··åˆsync/asyncï¼‰

**æ€§èƒ½æå‡**ï¼š
- æ•°æ®åº“æŸ¥è¯¢ï¼šå‡å°‘50-90%å“åº”æ—¶é—´
- æ‰¹é‡æ“ä½œï¼šæå‡10-100å€ååé‡
- APIè°ƒç”¨ï¼šå¹¶å‘æ‰§è¡Œé™ä½æ€»å»¶è¿Ÿ
- å†…å­˜å ç”¨ï¼šèŠ‚çœ80%æœåŠ¡å™¨èµ„æº

**ä¸‹ä¸€æ­¥**ï¼šåœ¨ç†è§£å¼‚æ­¥çš„åŸºç¡€ä¸Šï¼Œå­¦ä¹  Python ç±»å‹ç³»ç»Ÿã€‚
