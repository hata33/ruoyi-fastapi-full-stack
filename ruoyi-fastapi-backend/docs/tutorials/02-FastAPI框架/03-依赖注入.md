# ä¾èµ–æ³¨å…¥

> æŒæ¡ FastAPI ä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼Œå­¦ä¼šä¼˜é›…åœ°ç®¡ç†èµ„æºå’Œå…±äº«é€»è¾‘

## ğŸ“‹ æœ¬ç« ç›®æ ‡

- [ ] ç†è§£ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µå’Œä»·å€¼
- [ ] æŒæ¡ `Depends` çš„åŸºæœ¬ç”¨æ³•
- [ ] å­¦ä¼šåˆ›å»ºå¯å¤ç”¨çš„ä¾èµ–é¡¹
- [ ] åº”ç”¨ä¾èµ–æ³¨å…¥è§£å†³å®é™…é—®é¢˜

## ğŸ¯ ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥

### æ¦‚å¿µè§£é‡Š

ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼ŒDIï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†ç»„ä»¶çš„ä¾èµ–å…³ç³»ä»ç»„ä»¶å†…éƒ¨ç§»åˆ°å¤–éƒ¨è¿›è¡Œç®¡ç†ã€‚

### ç°å®ç±»æ¯”

```mermaid
flowchart LR
    subgraph WithoutDI["âŒ æ²¡æœ‰ä¾èµ–æ³¨å…¥"]
        direction TB
        Chef1[å¨å¸ˆ] --> Knife1[è‡ªå·±ä¹°èœåˆ€]
        Chef1 --> Stove1[è‡ªå·±åšç‚‰ç¶]
        Chef1 --> Ingredients1[è‡ªå·±æ‰¾é£Ÿæ]
    end

    subgraph WithDI["âœ… æœ‰ä¾èµ–æ³¨å…¥"]
        direction TB
        Provider[å¨æˆ¿ç»ç†] --> Knife2[èœåˆ€]
        Provider --> Stove2[ç‚‰ç¶]
        Provider --> Ingredients2[é£Ÿæ]

        Knife2 -.->|æ³¨å…¥| Chef2[å¨å¸ˆ]
        Stove2 -.->|æ³¨å…¥| Chef2
        Ingredients2 -.->|æ³¨å…¥| Chef2
    end

    style WithoutDI fill:#ffcdd2
    style WithDI fill:#c8e6c9
```

### ä»£ç å¯¹æ¯”

```python
# âŒ æ²¡æœ‰ä¾èµ–æ³¨å…¥ï¼šåœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºä¾èµ–
def get_user(user_id: int):
    db = Database()  # æ¯æ¬¡éƒ½åˆ›å»ºæ–°è¿æ¥
    user = db.query(User).get(user_id)
    db.close()
    return user

# âœ… æœ‰ä¾èµ–æ³¨å…¥ï¼šä¾èµ–ä»å¤–éƒ¨æ³¨å…¥
def get_db():
    """æ•°æ®åº“è¿æ¥ä¾èµ–"""
    db = Database()
    try:
        yield db
    finally:
        db.close()

def get_user(user_id: int, db: Database = Depends(get_db)):
    # db ç”± FastAPI è‡ªåŠ¨æ³¨å…¥
    return db.query(User).get(user_id)
```

## ğŸ—ï¸ FastAPI ä¾èµ–æ³¨å…¥æ¶æ„

### ä¾èµ–æ³¨å…¥æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant FastAPI as FastAPI
    participant Deps as ä¾èµ–ç³»ç»Ÿ
    participant DB as æ•°æ®åº“è¿æ¥
    participant Handler as å¤„ç†å‡½æ•°

    Client->>FastAPI: è¯·æ±‚
    FastAPI->>Deps: æ£€æµ‹ä¾èµ–é¡¹
    Deps->>DB: è°ƒç”¨ get_db()
    DB-->>Deps: è¿”å›è¿æ¥
    Deps->>Handler: æ³¨å…¥ä¾èµ–
    Handler->>DB: ä½¿ç”¨è¿æ¥
    Handler-->>FastAPI: è¿”å›ç»“æœ
    FastAPI->>DB: æ¸…ç†èµ„æº
    FastAPI-->>Client: å“åº”
```

### ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒç»„ä»¶

```mermaid
graph TB
    subgraph FastAPI["FastAPI ä¾èµ–ç³»ç»Ÿ"]
        Depends["Depends()"]
        Registry["ä¾èµ–æ³¨å†Œè¡¨"]
        Resolver["ä¾èµ–è§£æå™¨"]
        Cache["ä¾èµ–ç¼“å­˜"]
    end

    subgraph Dependencies["å¸¸è§ä¾èµ–"]
        DB["æ•°æ®åº“è¿æ¥"]
        Auth["è®¤è¯ä¿¡æ¯"]
        Config["é…ç½®ä¿¡æ¯"]
        Service["ä¸šåŠ¡æœåŠ¡"]
    end

    subgraph Handlers["å¤„ç†å‡½æ•°"]
        H1["create_user"]
        H2["get_transactions"]
        H3["update_settings"]
    end

    Depends --> Registry --> Resolver --> Cache

    DB --> Depends
    Auth --> Depends
    Config --> Depends
    Service --> Depends

    Cache --> H1
    Cache --> H2
    Cache --> H3

    style FastAPI fill:#e3f2fd
    style Dependencies fill:#c8e6c9
    style Handlers fill:#fff3e0
```

## ğŸ”§ åŸºæœ¬ç”¨æ³•

### ç®€å•ä¾èµ–

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# å®šä¹‰ä¾èµ–é¡¹
def common_parameters(q: str = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

# ä½¿ç”¨ä¾èµ–é¡¹
@app.get("/items")
def read_items(commons: dict = Depends(common_parameters)):
    # commons åŒ…å« q, skip, limit
    return commons

@app.get("/users")
def read_users(commons: dict = Depends(common_parameters)):
    # å¤ç”¨ç›¸åŒçš„ä¾èµ–
    return commons
```

### ä¾èµ–æ³¨å…¥æµç¨‹å›¾

```mermaid
flowchart LR
    Request["GET /items?q=test"] --> Parse["è§£æå‚æ•°"]
    Parse --> Call["è°ƒç”¨ä¾èµ–å‡½æ•°"]
    Call --> Inject["æ³¨å…¥å‚æ•°"]
    Inject --> Handler["æ‰§è¡Œå¤„ç†å‡½æ•°"]

    style Request fill:#e3f2fd
    style Handler fill:#c8e6c9
```

### ç±»ä½œä¸ºä¾èµ–

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# ä½¿ç”¨ç±»å®šä¹‰ä¾èµ–
class CommonParams:
    def __init__(self, q: str = None, skip: int = 0, limit: int = 100):
        self.q = q
        self.skip = skip
        self.limit = limit

# FastAPI ä¼šè‡ªåŠ¨å®ä¾‹åŒ–è¿™ä¸ªç±»
@app.get("/items")
def read_items(commons: CommonParams = Depends()):
    return {
        "q": commons.q,
        "skip": commons.skip,
        "limit": commons.limit
    }
```

## ğŸ—ƒï¸ å®æˆ˜ï¼šæ•°æ®åº“ä¾èµ–

### æ•°æ®åº“è¿æ¥ä¾èµ–

```mermaid
flowchart LR
    subgraph Lifecycle["è¿æ¥ç”Ÿå‘½å‘¨æœŸ"]
        direction LR
        Request["è¯·æ±‚"] --> Create["åˆ›å»ºè¿æ¥"]
        Create --> Use["ä½¿ç”¨"]
        Use --> Close["å…³é—­"]
        Close --> Response["å“åº”"]
    end

    subgraph Yield["yield è¯­æ³•"]
        Setup["yieldå‰è®¾ç½®"] --> Y["yieldèµ„æº"]
        Y --> Cleanup["yieldåæ¸…ç†"]
    end

    style Request fill:#e3f2fd
    style Response fill:#c8e6c9
```

```python
from fastapi import FastAPI, Depends
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session

app = FastAPI()

# æ•°æ®åº“é…ç½®
engine = create_engine("sqlite:///./test.db")
SessionLocal = sessionmaker(bind=engine)

# æ•°æ®åº“ä¾èµ–
def get_db():
    """
    æ•°æ®åº“ä¼šè¯ä¾èµ–

    ä½¿ç”¨ yield ç¡®ä¿æ¯ä¸ªè¯·æ±‚ç»“æŸåè‡ªåŠ¨å…³é—­è¿æ¥
    """
    db = SessionLocal()
    try:
        yield db  # æä¾›ç»™å¤„ç†å‡½æ•°ä½¿ç”¨
    finally:
        db.close()  # è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…ç†

# ä½¿ç”¨æ•°æ®åº“ä¾èµ–
@app.get("/users/{user_id}")
def get_user(user_id: int, db: Session = Depends(get_db)):
    # db å·²ç»æ˜¯æœ‰æ•ˆçš„æ•°æ®åº“ä¼šè¯
    user = db.query(User).filter(User.id == user_id).first()
    return user
```

### å¤šä¸ªæ•°æ®åº“ä¾èµ–

```mermaid
flowchart LR
    Request["è¯·æ±‚"] --> MainDB["ä¸»æ•°æ®åº“<br/>è¯»å†™"]
    Request --> ReadDB["åªè¯»å‰¯æœ¬<br/>æŸ¥è¯¢"]
    Request --> Cache["ç¼“å­˜<br/>Redis"]

    MainDB --> Handler["å¤„ç†å‡½æ•°"]
    ReadDB --> Handler
    Cache --> Handler

    style Handler fill:#c8e6c9
```

```python
from fastapi import FastAPI, Depends
from redis import Redis

app = FastAPI()

# ä¸»æ•°æ®åº“
def get_main_db():
    db = MainSessionLocal()
    try:
        yield db
    finally:
        db.close()

# åªè¯»å‰¯æœ¬
def get_read_db():
    db = ReadSessionLocal()
    try:
        yield db
    finally:
        db.close()

# Redis ç¼“å­˜
def get_redis():
    redis = Redis(host='localhost', port=6379)
    try:
        yield redis
    finally:
        redis.close()

# åŒæ—¶ä½¿ç”¨å¤šä¸ªä¾èµ–
@app.get("/users/{user_id}")
def get_user(
    user_id: int,
    main_db: Session = Depends(get_main_db),
    read_db: Session = Depends(get_read_db),
    cache: Redis = Depends(get_redis)
):
    # å…ˆæŸ¥ç¼“å­˜
    cached = cache.get(f"user:{user_id}")
    if cached:
        return cached

    # æŸ¥åªè¯»åº“
    user = read_db.query(User).get(user_id)

    # å†™å…¥ç¼“å­˜
    cache.set(f"user:{user_id}", user)

    return user
```

## ğŸ” å®æˆ˜ï¼šè®¤è¯ä¾èµ–

### JWT è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as FastAPI
    participant Auth as è®¤è¯ä¾èµ–
    participant JWT as JWT éªŒè¯
    participant DB as æ•°æ®åº“
    participant Handler as å¤„ç†å‡½æ•°

    Client->>API: è¯·æ±‚ + Token
    API->>Auth: æ£€æŸ¥è®¤è¯ä¾èµ–
    Auth->>JWT: éªŒè¯ Token
    alt Token æœ‰æ•ˆ
        JWT->>DB: è·å–ç”¨æˆ·ä¿¡æ¯
        DB-->>Auth: ç”¨æˆ·æ•°æ®
        Auth->>Handler: æ³¨å…¥å½“å‰ç”¨æˆ·
        Handler-->>Client: æ­£å¸¸å“åº”
    else Token æ— æ•ˆ
        Auth-->>Client: 401 Unauthorized
    end
```

### è®¤è¯ä¾èµ–å®ç°

```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import JWTError, jwt
from pydantic import BaseModel

app = FastAPI()
security = HTTPBearer()

# ç”¨æˆ·æ¨¡å‹
class User(BaseModel):
    id: int
    username: str
    email: str

# è®¤è¯ä¾èµ–
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> User:
    """
    è·å–å½“å‰ç™»å½•ç”¨æˆ·

    1. ä»è¯·æ±‚å¤´æå– Bearer Token
    2. éªŒè¯ JWT æœ‰æ•ˆæ€§
    3. è¿”å›ç”¨æˆ·ä¿¡æ¯
    """
    token = credentials.credentials

    try:
        # è§£ç  JWT
        payload = jwt.decode(
            token,
            SECRET_KEY,
            algorithms=[ALGORITHM]
        )
        user_id: int = payload.get("sub")

        if user_id is None:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="æ— æ•ˆçš„è®¤è¯å‡­è¯"
            )

    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æ— æ³•éªŒè¯å‡­è¯"
        )

    # ä»æ•°æ®åº“è·å–ç”¨æˆ·
    user = get_user_from_db(user_id)
    if user is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )

    return user

# å¯é€‰è®¤è¯ï¼ˆå…è®¸åŒ¿åè®¿é—®ï¼‰
def get_current_user_optional(
    credentials: HTTPAuthorizationCredentials = Depends(HTTPBearer(auto_error=False))
) -> User | None:
    if credentials is None:
        return None
    return get_current_user(credentials)

# ä½¿ç”¨è®¤è¯ä¾èµ–
@app.get("/users/me")
def read_users_me(current_user: User = Depends(get_current_user)):
    """è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç™»å½•ï¼‰"""
    return current_user

@app.get("/public")
def public_content(user: User = Depends(get_current_user_optional)):
    """å…¬å…±å†…å®¹ï¼ˆå¯é€‰ç™»å½•ï¼‰"""
    if user:
        return {"message": f"æ¬¢è¿å›æ¥, {user.username}!"}
    return {"message": "æ¬¢è¿è®¿å®¢!"}
```

### æƒé™éªŒè¯ä¾èµ–

```mermaid
flowchart LR
    Request["è¯·æ±‚"] --> Auth["è®¤è¯æ£€æŸ¥"]
    Auth --> |"é€šè¿‡"| RoleCheck["è§’è‰²æ£€æŸ¥"]
    Auth --> |"å¤±è´¥"| Unauthorized["401"]

    RoleCheck --> |"admin"| Admin["ç®¡ç†å‘˜"]
    RoleCheck --> |"user"| User["æ™®é€šç”¨æˆ·"]
    RoleCheck --> |"æ— "| Forbidden["403"]

    Admin --> Handler["å¤„ç†å‡½æ•°"]
    User --> Handler

    style Unauthorized fill:#ffcdd2
    style Forbidden fill:#ffcdd2
    style Handler fill:#c8e6c9
```

```python
from fastapi import Depends, HTTPException, status
from typing import List

def require_roles(required_roles: List[str]):
    """
    è§’è‰²éªŒè¯ä¾èµ–å·¥å‚

    è¿”å›ä¸€ä¸ªä¾èµ–å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰€éœ€è§’è‰²
    """
    def role_checker(current_user: User = Depends(get_current_user)):
        if current_user.role not in required_roles:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="æƒé™ä¸è¶³"
            )
        return current_user
    return role_checker

# ä½¿ç”¨è§’è‰²éªŒè¯
@app.get("/admin/users")
def list_all_users(
    admin: User = Depends(require_roles(["admin"]))
):
    """ç®¡ç†å‘˜ï¼šæŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·"""
    return {"users": get_all_users()}

@app.get("/transactions")
def list_transactions(
    user: User = Depends(require_roles(["user", "admin"]))
):
    """ç”¨æˆ·/ç®¡ç†å‘˜ï¼šæŸ¥çœ‹äº¤æ˜“è®°å½•"""
    return {"transactions": get_user_transactions(user.id)}
```

## ğŸ”„ ä¾èµ–åµŒå¥—ä¸ç»„åˆ

### ä¾èµ–åµŒå¥—

```mermaid
flowchart LR
    subgraph Nested["ä¾èµ–åµŒå¥—ç»“æ„"]
        D2["get_db"] --> D3["get_user_service"]
        D1["get_current_user"] --> D3
    end

    D3 --> Handler["å¤„ç†å‡½æ•°"]

    style Nested fill:#e3f2fd
    style Handler fill:#c8e6c9
```

```python
from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session

app = FastAPI()

# åŸºç¡€ä¾èµ–ï¼šæ•°æ®åº“
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# åŸºç¡€ä¾èµ–ï¼šè®¤è¯
def get_current_user(
    db: Session = Depends(get_db),
    token: str = Depends(oauth2_scheme)
):
    # ä¾èµ– get_db
    user = verify_token(db, token)
    return user

# ç»„åˆä¾èµ–ï¼šç”¨æˆ·æœåŠ¡
def get_user_service(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # åŒæ—¶ä¾èµ–æ•°æ®åº“å’Œå½“å‰ç”¨æˆ·
    return UserService(db, current_user)

# ä½¿ç”¨ç»„åˆä¾èµ–
@app.get("/my-transactions")
def get_my_transactions(
    service: UserService = Depends(get_user_service)
):
    # service å·²ç»åŒ…å« db å’Œ current_user
    return service.get_transactions()
```

### ä¾èµ–å›¾ç¤ºä¾‹

```mermaid
graph TB
    subgraph Handlers["API ç«¯ç‚¹"]
        H1["/transactions"]
        H2["/users/me"]
        H3["/admin/settings"]
    end

    subgraph Services["æœåŠ¡å±‚"]
        S1["TransactionService"]
        S2["UserService"]
    end

    subgraph Core["æ ¸å¿ƒä¾èµ–"]
        DB["Database"]
        Auth["Auth"]
        Cache["Redis"]
    end

    H1 --> S1
    H2 --> S2
    H3 --> S2

    S1 --> DB
    S1 --> Auth
    S1 --> Cache

    S2 --> DB
    S2 --> Auth

    style Handlers fill:#fff3e0
    style Services fill:#c8e6c9
    style Core fill:#e3f2fd
```

## ğŸ›ï¸ ä¾èµ–ç¼“å­˜ä¸ä½œç”¨åŸŸ

### ä¾èµ–ç¼“å­˜æœºåˆ¶

```mermaid
flowchart LR
    subgraph Request["å•æ¬¡è¯·æ±‚"]
        D1["ä¾èµ–è°ƒç”¨"] --> Cache{"ç¼“å­˜?"}
        Cache --> |"æ˜¯"| Return["è¿”å›ç¼“å­˜"]
        Cache --> |"å¦"| Execute["æ‰§è¡Œ"]
        Execute --> Store["å­˜ç¼“å­˜"]
        Store --> Return
    end

    subgraph SameRequest["å¤šæ¬¡ä½¿ç”¨"]
        Use1["ä½¿ç”¨1"] -.->|"é¦–æ¬¡"| D1
        Use2["ä½¿ç”¨2"] -.->|"å‘½ä¸­"| Return
        Use3["ä½¿ç”¨3"] -.->|"å‘½ä¸­"| Return
    end

    style Cache fill:#fff3e0
    style Return fill:#c8e6c9
```

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€è¯·æ±‚ä¸­ä¾èµ–ä¼šè¢«ç¼“å­˜
def expensive_operation():
    print("æ‰§è¡Œè€—æ—¶æ“ä½œ...")  # æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡
    return {"result": "data"}

@app.get("/cached")
def use_cached(
    data1: dict = Depends(expensive_operation),  # æ‰§è¡Œ
    data2: dict = Depends(expensive_operation),  # ä½¿ç”¨ç¼“å­˜
    data3: dict = Depends(expensive_operation),  # ä½¿ç”¨ç¼“å­˜
):
    # data1, data2, data3 æ˜¯åŒä¸€ä¸ªå¯¹è±¡
    return {"data": data1}

# ç¦ç”¨ç¼“å­˜ï¼šuse_cache=False
@app.get("/no-cache")
def use_no_cache(
    data1: dict = Depends(expensive_operation),
    data2: dict = Depends(expensive_operation, use_cache=False),  # é‡æ–°æ‰§è¡Œ
):
    return {"data1": data1, "data2": data2}
```

### å…¨å±€ä¾èµ–

```mermaid
flowchart LR
    subgraph App["åº”ç”¨çº§åˆ«"]
        GlobalDeps["å…¨å±€ä¾èµ–"] --> Router1["è·¯ç”±æ¨¡å—1"]
        GlobalDeps --> Router2["è·¯ç”±æ¨¡å—2"]
    end

    subgraph Request["è¯·æ±‚å¤„ç†"]
        Request1["è¯·æ±‚1"] --> GlobalDeps --> Handler1["å¤„ç†"]
        Request2["è¯·æ±‚2"] --> GlobalDeps --> Handler2["å¤„ç†"]
    end

    style GlobalDeps fill:#ffcdd2
```

```python
from fastapi import FastAPI, Depends, APIRouter

app = FastAPI(
    # åº”ç”¨çº§åˆ«å…¨å±€ä¾èµ–
    dependencies=[
        Depends(verify_token),
        Depends(verify_key)
    ]
)

# è·¯ç”±çº§åˆ«ä¾èµ–
router = APIRouter(
    prefix="/admin",
    dependencies=[Depends(require_admin)]
)

@router.get("/users")
def list_users():
    # è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä¾èµ–ï¼š
    # 1. verify_token (åº”ç”¨çº§)
    # 2. verify_key (åº”ç”¨çº§)
    # 3. require_admin (è·¯ç”±çº§)
    return {"users": []}
```

## ğŸ“Š ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

### é¡¹ç›®ç»“æ„

```mermaid
graph TB
    subgraph Project["é¡¹ç›®ç»“æ„"]
        Main["main.py<br/>åº”ç”¨å…¥å£"]
        Deps["dependencies/<br/>ä¾èµ–æ¨¡å—"]
        Routers["routers/<br/>è·¯ç”±æ¨¡å—"]
        Services["services/<br/>ä¸šåŠ¡æœåŠ¡"]
    end

    subgraph DepsModule["ä¾èµ–æ¨¡å—"]
        D1["database.py<br/>æ•°æ®åº“ä¾èµ–"]
        D2["auth.py<br/>è®¤è¯ä¾èµ–"]
        D3["pagination.py<br/>åˆ†é¡µä¾èµ–"]
    end

    Main --> Routers
    Routers --> Deps
    Deps --> Services

    style Project fill:#f5f5f5
    style DepsModule fill:#c8e6c9
```

### å®Œæ•´ç¤ºä¾‹ï¼šè®°è´¦ç³»ç»Ÿä¾èµ–

```python
# dependencies/database.py
from sqlalchemy.orm import Session
from database import SessionLocal

def get_db():
    """æ•°æ®åº“ä¼šè¯ä¾èµ–"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# dependencies/auth.py
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer
from jose import jwt

security = HTTPBearer()

def get_current_user(
    credentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç”¨æˆ·"""
    token = credentials.credentials
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id = payload.get("sub")
        user = db.query(User).get(user_id)
        if not user:
            raise HTTPException(401, "ç”¨æˆ·ä¸å­˜åœ¨")
        return user
    except JWTError:
        raise HTTPException(401, "æ— æ•ˆå‡­è¯")

# dependencies/pagination.py
from fastapi import Query
from pydantic import BaseModel

class PaginationParams(BaseModel):
    skip: int = 0
    limit: int = 10

def get_pagination(
    skip: int = Query(0, ge=0),
    limit: int = Query(10, ge=1, le=100)
) -> PaginationParams:
    """åˆ†é¡µå‚æ•°ä¾èµ–"""
    return PaginationParams(skip=skip, limit=limit)

# dependencies/services.py
from services import TransactionService, UserService

def get_transaction_service(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
) -> TransactionService:
    """äº¤æ˜“æœåŠ¡ä¾èµ–"""
    return TransactionService(db, current_user)

# routers/transactions.py
from fastapi import APIRouter, Depends
from dependencies.auth import get_current_user
from dependencies.database import get_db
from dependencies.pagination import get_pagination
from dependencies.services import get_transaction_service

router = APIRouter(prefix="/transactions", tags=["äº¤æ˜“"])

@router.get("")
def list_transactions(
    service: TransactionService = Depends(get_transaction_service),
    pagination: PaginationParams = Depends(get_pagination)
):
    """è·å–äº¤æ˜“åˆ—è¡¨"""
    return service.get_transactions(
        skip=pagination.skip,
        limit=pagination.limit
    )

@router.post("")
def create_transaction(
    data: TransactionCreate,
    service: TransactionService = Depends(get_transaction_service)
):
    """åˆ›å»ºäº¤æ˜“"""
    return service.create_transaction(data)
```

### ä¾èµ–æ³¨å…¥å†³ç­–å›¾

```mermaid
flowchart LR
    Start["éœ€è¦å…±äº«é€»è¾‘?"] --> Type{"ä»€ä¹ˆç±»å‹?"}

    Type -->|"æ•°æ®åº“"| DB["get_db() ä¾èµ–"]
    Type -->|"è®¤è¯"| Auth["get_current_user()"]
    Type -->|"éªŒè¯"| Validate["éªŒè¯ä¾èµ–"]
    Type -->|"ä¸šåŠ¡é€»è¾‘"| Service["æœåŠ¡ä¾èµ–"]

    DB --> Q1{"å¤šä¸ªç«¯ç‚¹ä½¿ç”¨?"}
    Auth --> Q1
    Validate --> Q1
    Service --> Q1

    Q1 --> |"æ˜¯"| DI["ä½¿ç”¨ä¾èµ–æ³¨å…¥"]
    Q1 --> |"å¦"| Direct["ç›´æ¥åœ¨å‡½æ•°ä¸­å¤„ç†"]

    DI --> Cache{"éœ€è¦ç¼“å­˜?"}
    Cache --> |"æ˜¯"| UseCache["use_cache=True"]
    Cache --> |"å¦"| NoCache["use_cache=False"]

    style DI fill:#c8e6c9
    style Direct fill:#fff3e0
```

## ğŸ“ ç»ƒä¹ ä»»åŠ¡

### åŸºç¡€ç»ƒä¹ 

1. **åˆ›å»ºåˆ†é¡µä¾èµ–**
   ```python
   # å®ç°ä¸€ä¸ªåˆ†é¡µä¾èµ–ï¼Œæ”¯æŒ page/size æˆ– skip/limit ä¸¤ç§æ¨¡å¼
   @app.get("/items")
   def list_items(pagination: Pagination = Depends(get_pagination)):
       pass
   ```

2. **åˆ›å»ºæ—¥å¿—ä¾èµ–**
   ```python
   # å®ç°è¯·æ±‚æ—¥å¿—ä¾èµ–ï¼Œè®°å½•æ¯ä¸ªè¯·æ±‚çš„åŸºæœ¬ä¿¡æ¯
   def log_request(request: Request = Depends()):
       logger.info(f"Request: {request.method} {request.url}")
   ```

### è¿›é˜¶ç»ƒä¹ 

3. **å®ç°å®Œæ•´è®¤è¯ç³»ç»Ÿ**
   - JWT ç”Ÿæˆä¸éªŒè¯
   - ç”¨æˆ·è§’è‰²æ£€æŸ¥
   - æƒé™éªŒè¯è£…é¥°å™¨

4. **æœåŠ¡å±‚ä¾èµ–**
   - åˆ›å»º TransactionService
   - å®ç°ä¾èµ–æ³¨å…¥
   - æ·»åŠ ç¼“å­˜æ”¯æŒ

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šä¾èµ–æ³¨å…¥çš„æ¦‚å¿µå’Œä¼˜åŠ¿
- [ ] ä½¿ç”¨ `Depends()` åˆ›å»ºå’Œä½¿ç”¨ä¾èµ–
- [ ] å®ç°æ•°æ®åº“ä¼šè¯ä¾èµ–
- [ ] å®ç°è®¤è¯å’Œæƒé™éªŒè¯ä¾èµ–
- [ ] ç†è§£ä¾èµ–ç¼“å­˜æœºåˆ¶
- [ ] ç»„ç»‡é¡¹ç›®ä¾èµ–ç»“æ„

## ğŸ¤” å¸¸è§é—®é¢˜

### Q1: ä¾èµ–æ³¨å…¥å’Œç›´æ¥è°ƒç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```python
# ç›´æ¥è°ƒç”¨
def get_user(user_id: int):
    db = SessionLocal()  # ç¡¬ç¼–ç ä¾èµ–
    user = db.query(User).get(user_id)
    db.close()
    return user

# ä¾èµ–æ³¨å…¥
def get_user(user_id: int, db = Depends(get_db)):
    # ä¾èµ–ç”±å¤–éƒ¨ç®¡ç†
    return db.query(User).get(user_id)
```

**A**: ä¾èµ–æ³¨å…¥çš„ä¼˜åŠ¿ï¼š
- âœ… **å¯æµ‹è¯•**ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ mock æ•°æ®åº“
- âœ… **å¯å¤ç”¨**ï¼šå¤šä¸ªç«¯ç‚¹å…±äº«åŒä¸€ä¸ªä¾èµ–
- âœ… **å…³æ³¨åˆ†ç¦»**ï¼šä¸šåŠ¡é€»è¾‘ä¸å…³å¿ƒä¾èµ–åˆ›å»º
- âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†èµ„æº

### Q2: ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ç”¨ä¾èµ–æ³¨å…¥ï¼Ÿ

**A**: ä»¥ä¸‹æƒ…å†µå¯ä»¥ä¸ç”¨ï¼š
- ç®€å•çš„ä¸€æ¬¡æ€§æ“ä½œ
- ä¸éœ€è¦å¤ç”¨çš„é€»è¾‘
- ä¸éœ€è¦æµ‹è¯•çš„åœºæ™¯

### Q3: å¦‚ä½•åœ¨æµ‹è¯•ä¸­æ›¿æ¢ä¾èµ–ï¼Ÿ

```python
from fastapi.testclient import TestClient

# æµ‹è¯•ç”¨æ•°æ®åº“ä¾èµ–
def override_get_db():
    db = TestSessionLocal()
    try:
        yield db
    finally:
        db.close()

# æ›¿æ¢ä¾èµ–
app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)
```

## ğŸ“š å»¶ä¼¸é˜…è¯»

- **FastAPI ä¾èµ–æ³¨å…¥**ï¼š[https://fastapi.tiangolo.com/tutorial/dependencies/](https://fastapi.tiangolo.com/tutorial/dependencies/)
- **ä¾èµ–æ³¨å…¥æ¨¡å¼**ï¼š[https://en.wikipedia.org/wiki/Dependency_injection](https://en.wikipedia.org/wiki/Dependency_injection)
- **æµ‹è¯•ä¸ä¾èµ–è¦†ç›–**ï¼š[https://fastapi.tiangolo.com/advanced/testing-dependencies/](https://fastapi.tiangolo.com/advanced/testing-dependencies/)

---

**ä¸‹ä¸€ç« **ï¼š[04-PydanticéªŒè¯.md](./04-PydanticéªŒè¯.md) - æ·±å…¥å­¦ä¹ æ•°æ®éªŒè¯å’Œæ¨¡å‹è®¾è®¡
