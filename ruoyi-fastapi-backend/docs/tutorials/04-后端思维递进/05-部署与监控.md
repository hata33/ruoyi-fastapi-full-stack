# éƒ¨ç½²ä¸ç›‘æ§

> è®©è®°è´¦ç³»ç»Ÿç¨³å®šè¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒ

## ğŸ“‹ æœ¬ç« ç›®æ ‡

- [ ] ç†è§£éƒ¨ç½²æµç¨‹
- [ ] æŒæ¡ Docker å®¹å™¨åŒ–
- [ ] é…ç½®æ—¥å¿—å’Œç›‘æ§
- [ ] å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

## ğŸ¯ éƒ¨ç½²æ¶æ„

```mermaid
flowchart TB
    subgraph Production["ç”Ÿäº§ç¯å¢ƒæ¶æ„"]
        LB["è´Ÿè½½å‡è¡¡å™¨<br/>Nginx"]

        subgraph Servers["åº”ç”¨æœåŠ¡å™¨"]
            App1["FastAPI å®ä¾‹ 1"]
            App2["FastAPI å®ä¾‹ 2"]
        end

        subgraph Data["æ•°æ®å±‚"]
            DB[(MySQL<br/>ä¸»ä»å¤åˆ¶)]
            Redis[(Redis<br/>ç¼“å­˜)]
        end
    end

    User["ç”¨æˆ·"] --> LB
    LB --> App1
    LB --> App2
    App1 --> DB
    App2 --> DB
    App1 --> Redis
    App2 --> Redis

    style Production fill:#f5f5f5
    style Data fill:#c8e6c9
```

## ğŸ³ Docker å®¹å™¨åŒ–

### Dockerfile

```dockerfile
# Dockerfile
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  # FastAPI åº”ç”¨
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+pymysql://root:password@db:3306/bookkeeping
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - db
      - redis
    volumes:
      - ./app:/app/app
    restart: unless-stopped

  # MySQL æ•°æ®åº“
  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=bookkeeping
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    restart: unless-stopped

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
```

### Nginx é…ç½®

```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:8000;
    }

    server {
        listen 80;
        server_name example.com;

        # é‡å®šå‘åˆ° HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl;
        server_name example.com;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        # å®‰å…¨é…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # API ä»£ç†
        location /api/ {
            proxy_pass http://api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # é™æ€æ–‡ä»¶
        location /static/ {
            alias /app/static/;
            expires 30d;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            proxy_pass http://api/health;
        }
    }
}
```

## ğŸ“Š æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—é…ç½®

```python
# core/logging.py
import logging
from logging.handlers import RotatingFileHandler
import sys

def setup_logging():
    """é…ç½®æ—¥å¿—"""

    # æ—¥å¿—æ ¼å¼
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)

    # æ–‡ä»¶å¤„ç†å™¨ï¼ˆè‡ªåŠ¨æ»šåŠ¨ï¼‰
    file_handler = RotatingFileHandler(
        'logs/app.log',
        maxBytes=10 * 1024 * 1024,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)

    # é…ç½®æ ¹æ—¥å¿—
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)

    # é…ç½®ç‰¹å®šæ¨¡å—æ—¥å¿—çº§åˆ«
    logging.getLogger("uvicorn").setLevel(logging.INFO)
    logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)

# main.py
from core.logging import setup_logging

setup_logging()
```

### ç»“æ„åŒ–æ—¥å¿—

```python
# core/structured_logging.py
import logging
import json
from datetime import datetime

class StructuredFormatter(logging.Formatter):
    """ç»“æ„åŒ–æ—¥å¿—æ ¼å¼å™¨"""

    def format(self, record):
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'module': record.module,
            'function': record.funcName,
            'line': record.lineno
        }

        # æ·»åŠ é¢å¤–å­—æ®µ
        if hasattr(record, 'user_id'):
            log_data['user_id'] = record.user_id
        if hasattr(record, 'request_id'):
            log_data['request_id'] = record.request_id

        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)

        return json.dumps(log_data)

# ä½¿ç”¨
logger = logging.getLogger(__name__)

def log_with_context(user_id: int, message: str):
    """å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—"""
    logger.info(
        message,
        extra={'user_id': user_id}
    )
```

## ğŸ“ˆ ç›‘æ§ç³»ç»Ÿ

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```python
# routers/health.py
from fastapi import APIRouter, Response
from datetime import datetime

router = APIRouter(tags=["å¥åº·æ£€æŸ¥"])

@router.get("/health")
def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat()
    }

@router.get("/health/detailed")
def detailed_health_check(db: Session = Depends(get_db)):
    """è¯¦ç»†å¥åº·æ£€æŸ¥"""
    checks = {
        "api": "healthy",
        "database": "unknown",
        "redis": "unknown"
    }

    # æ£€æŸ¥æ•°æ®åº“
    try:
        db.execute("SELECT 1")
        checks["database"] = "healthy"
    except Exception as e:
        checks["database"] = f"unhealthy: {str(e)}"

    # æ£€æŸ¥ Redis
    try:
        redis_client.ping()
        checks["redis"] = "healthy"
    except Exception as e:
        checks["redis"] = f"unhealthy: {str(e)}"

    # åˆ¤æ–­æ•´ä½“çŠ¶æ€
    all_healthy = all(v == "healthy" for v in checks.values())
    status_code = 200 if all_healthy else 503

    return Response(
        content=json.dumps({
            "status": "healthy" if all_healthy else "unhealthy",
            "checks": checks,
            "timestamp": datetime.utcnow().isoformat()
        }),
        status_code=status_code,
        media_type="application/json"
    )
```

### Prometheus æŒ‡æ ‡

```python
# core/metrics.py
from prometheus_client import Counter, Histogram, Gauge
from prometheus_fastapi_instrumentator import Instrumentator

# è‡ªå®šä¹‰æŒ‡æ ‡
REQUEST_COUNT = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

REQUEST_LATENCY = Histogram(
    'http_request_duration_seconds',
    'HTTP request latency',
    ['method', 'endpoint']
)

ACTIVE_USERS = Gauge(
    'active_users_total',
    'Number of active users'
)

# åœ¨ main.py ä¸­å¯ç”¨
from prometheus_fastapi_instrumentator import Instrumentator

app = FastAPI()

# å¯ç”¨ Prometheus æŒ‡æ ‡
Instrumentator().instrument(app).expose(app)
```

## ğŸš€ CI/CD è‡ªåŠ¨åŒ–

### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest --cov=app tests/

      - name: Upload coverage
        uses: codecov/codecov-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t bookkeeping-api:${{ github.sha }} .

      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push bookkeeping-api:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /app/bookkeeping
            docker-compose pull
            docker-compose up -d
            docker image prune -f
```

## ğŸ“ ç»ƒä¹ ä»»åŠ¡

1. **é…ç½®ç”Ÿäº§ç¯å¢ƒ** - æ­å»ºå®Œæ•´çš„ Docker éƒ¨ç½²ç¯å¢ƒ
2. **æ·»åŠ ç›‘æ§å‘Šè­¦** - é…ç½® Prometheus + Grafana
3. **å®ç°è“ç»¿éƒ¨ç½²** - é›¶åœæœºéƒ¨ç½²ç­–ç•¥

## âœ… æ£€æŸ¥ç‚¹

- [ ] ç†è§£éƒ¨ç½²æ¶æ„è®¾è®¡
- [ ] æŒæ¡ Docker å®¹å™¨åŒ–
- [ ] é…ç½®æ—¥å¿—ç³»ç»Ÿ
- [ ] å®ç°å¥åº·æ£€æŸ¥
- [ ] æ­å»º CI/CD æµæ°´çº¿

---

## ğŸ“ è¯¾ç¨‹æ€»ç»“

æ­å–œä½ å®Œæˆäº†æ•´ä¸ªåç«¯å¼€å‘å®æˆ˜æ•™ç¨‹ï¼é€šè¿‡è¿™ä¸ªæ•™ç¨‹ï¼Œä½ å·²ç»ï¼š

1. **æŒæ¡äº† Python åç«¯åŸºç¡€** - Python è¯­æ³•ã€å¼‚æ­¥ç¼–ç¨‹ã€ç±»å‹ç³»ç»Ÿ
2. **å­¦ä¼šäº† FastAPI æ¡†æ¶** - è·¯ç”±ã€ä¾èµ–æ³¨å…¥ã€Pydantic éªŒè¯ã€RESTful è®¾è®¡
3. **ç†è§£äº†æ•°æ®åº“æ“ä½œ** - SQL åŸºç¡€ã€SQLAlchemy ORMã€æ•°æ®æ¨¡å‹è®¾è®¡
4. **å®ç°äº†å®Œæ•´åŠŸèƒ½** - è®¤è¯æˆæƒã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨é˜²æŠ¤
5. **å­¦ä¼šäº†å·¥ç¨‹å®è·µ** - ä»£ç é‡æ„ã€éƒ¨ç½²ç›‘æ§

æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥ï¼š
- ç»§ç»­å®Œå–„è®°è´¦ç³»ç»Ÿçš„åŠŸèƒ½
- å­¦ä¹ æ›´å¤šåç«¯æŠ€æœ¯ï¼ˆå¾®æœåŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰
- è´¡çŒ®å¼€æºé¡¹ç›®ï¼Œç§¯ç´¯ç»éªŒ

ç¥ä½ æˆä¸ºä¼˜ç§€çš„åç«¯å·¥ç¨‹å¸ˆï¼ğŸš€
