# ä»£ç é‡æ„ä¸å¯ç»´æŠ¤æ€§

> ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç ï¼Œè®©é¡¹ç›®é•¿æœŸå¥åº·å‘å±•

## ğŸ“‹ æœ¬ç« ç›®æ ‡

- [ ] ç†è§£ä»£ç é‡æ„çš„åŸåˆ™
- [ ] æŒæ¡å¸¸è§é‡æ„æŠ€å·§
- [ ] ç¼–å†™å¯æµ‹è¯•çš„ä»£ç 
- [ ] å»ºç«‹ä»£ç è§„èŒƒ

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦é‡æ„

### ä»£ç è…çƒ‚

```mermaid
flowchart LR
    subgraph Clean["æ•´æ´ä»£ç "]
        C1["æ¸…æ™°çš„å‘½å"]
        C2["å•ä¸€èŒè´£"]
        C3["æ˜“äºç†è§£"]
    end

    subgraph Rotten["è…çƒ‚ä»£ç "]
        R1["é‡å¤ä»£ç "]
        R2["æ·±å±‚åµŒå¥—"]
        R3["éš¾ä»¥ç†è§£"]
    end

    Time["æ—¶é—´æ¨ç§»"] --> Clean
    Clean --> |"ä¸æ–­æ·»åŠ åŠŸèƒ½<br/>ä¸é‡æ„"| Rotten

    style Clean fill:#c8e6c9
    style Rotten fill:#ffcdd2
```

### é‡æ„ç›®æ ‡

```mermaid
mindmap
    root((é‡æ„ç›®æ ‡))
        å¯è¯»æ€§
            æ¸…æ™°å‘½å
            é€‚å½“æ³¨é‡Š
            åˆç†ç»“æ„
        å¯ç»´æŠ¤æ€§
            ä½è€¦åˆ
            é«˜å†…èš
            æ˜“äºä¿®æ”¹
        å¯æµ‹è¯•æ€§
            ä¾èµ–æ³¨å…¥
            çº¯å‡½æ•°
            æ˜“äº Mock
        æ€§èƒ½
            æ¶ˆé™¤å†—ä½™
            ä¼˜åŒ–ç®—æ³•
```

## ğŸ—ï¸ åˆ†å±‚æ¶æ„é‡æ„

### ä»æ··ä¹±åˆ°æœ‰åº

```mermaid
flowchart TB
    subgraph Before["âŒ é‡æ„å‰ï¼šæ··ä¹±ç»“æ„"]
        B1["æ‰€æœ‰ä»£ç åœ¨ main.py"]
        B2["æ•°æ®åº“æ“ä½œåˆ°å¤„æ•£è½"]
        B3["ä¸šåŠ¡é€»è¾‘å’Œ API æ··åˆ"]
    end

    subgraph After["âœ… é‡æ„åï¼šåˆ†å±‚æ¶æ„"]
        A1["API å±‚ - è·¯ç”±å¤„ç†"]
        A2["Service å±‚ - ä¸šåŠ¡é€»è¾‘"]
        A3["Repository å±‚ - æ•°æ®è®¿é—®"]
        A4["Model å±‚ - æ•°æ®æ¨¡å‹"]
    end

    Before --> After

    style Before fill:#ffcdd2
    style After fill:#c8e6c9
```

### æœåŠ¡å±‚é‡æ„

```python
# âŒ é‡æ„å‰ï¼šä¸šåŠ¡é€»è¾‘åœ¨è·¯ç”±ä¸­
@router.post("/transactions")
def create_transaction(
    transaction_in: TransactionCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # éªŒè¯è´¦æˆ·
    account = db.get(Account, transaction_in.account_id)
    if not account or account.user_id != current_user.id:
        raise HTTPException(400, "æ— æ•ˆçš„è´¦æˆ·")

    # éªŒè¯åˆ†ç±»
    category = db.get(Category, transaction_in.category_id)
    if not category or category.user_id != current_user.id:
        raise HTTPException(400, "æ— æ•ˆçš„åˆ†ç±»")

    # åˆ›å»ºäº¤æ˜“
    transaction = Transaction(
        user_id=current_user.id,
        **transaction_in.model_dump()
    )
    db.add(transaction)

    # æ›´æ–°ä½™é¢
    if transaction_in.type == TransactionType.INCOME:
        account.balance += transaction_in.amount
    else:
        account.balance -= transaction_in.amount

    db.commit()
    return transaction

# âœ… é‡æ„åï¼šä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡å±‚
# services/transaction.py
class TransactionService:
    """äº¤æ˜“æœåŠ¡"""

    def __init__(self, db: Session):
        self.db = db

    def create_transaction(
        self,
        user_id: int,
        transaction_data: TransactionCreate
    ) -> Transaction:
        """åˆ›å»ºäº¤æ˜“ï¼ˆåŒ…å«ä¸šåŠ¡é€»è¾‘ï¼‰"""
        self._validate_account(user_id, transaction_data.account_id)
        self._validate_category(user_id, transaction_data.category_id)

        transaction = Transaction(
            user_id=user_id,
            **transaction_data.model_dump()
        )
        self.db.add(transaction)
        self._update_account_balance(transaction)
        self.db.commit()

        return transaction

    def _validate_account(self, user_id: int, account_id: int):
        """éªŒè¯è´¦æˆ·"""
        account = self.db.get(Account, account_id)
        if not account or account.user_id != user_id:
            raise BusinessException("æ— æ•ˆçš„è´¦æˆ·")

    def _validate_category(self, user_id: int, category_id: int):
        """éªŒè¯åˆ†ç±»"""
        category = self.db.get(Category, category_id)
        if not category or category.user_id != user_id:
            raise BusinessException("æ— æ•ˆçš„åˆ†ç±»")

    def _update_account_balance(self, transaction: Transaction):
        """æ›´æ–°è´¦æˆ·ä½™é¢"""
        account = self.db.get(Account, transaction.account_id)
        if transaction.type == TransactionType.INCOME:
            account.balance += transaction.amount
        else:
            account.balance -= transaction.amount

# routers/transactions.py
@router.post("/transactions")
def create_transaction(
    transaction_in: TransactionCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """åˆ›å»ºäº¤æ˜“"""
    service = TransactionService(db)
    transaction = service.create_transaction(current_user.id, transaction_in)
    return TransactionResponse.model_validate(transaction)
```

## ğŸ”§ å¸¸è§é‡æ„æŠ€å·§

### æå–æ–¹æ³•

```python
# âŒ é‡æ„å‰ï¼šä¸€ä¸ªé•¿æ–¹æ³•
def process_monthly_report(db: Session, user_id: int, month: str):
    # è·å–ç”¨æˆ·
    user = db.get(User, user_id)
    if not user:
        raise ValueError("ç”¨æˆ·ä¸å­˜åœ¨")

    # è·å–äº¤æ˜“
    transactions = db.query(Transaction).filter(
        Transaction.user_id == user_id,
        Transaction.transaction_date.like(f"{month}%")
    ).all()

    # è®¡ç®—æ€»æ”¶å…¥
    total_income = sum(t.amount for t in transactions if t.type == 'income')

    # è®¡ç®—æ€»æ”¯å‡º
    total_expense = sum(t.amount for t in transactions if t.type == 'expense')

    # æŒ‰åˆ†ç±»ç»Ÿè®¡
    by_category = {}
    for t in transactions:
        if t.category_id not in by_category:
            by_category[t.category_id] = 0
        by_category[t.category_id] += t.amount

    # ç”ŸæˆæŠ¥å‘Š
    report = {
        'user': user.username,
        'month': month,
        'total_income': total_income,
        'total_expense': total_expense,
        'balance': total_income - total_expense,
        'by_category': by_category
    }

    return report

# âœ… é‡æ„åï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå°æ–¹æ³•
class ReportService:
    """æŠ¥å‘ŠæœåŠ¡"""

    def process_monthly_report(self, user_id: int, month: str) -> dict:
        """ç”Ÿæˆæœˆåº¦æŠ¥å‘Š"""
        user = self._get_user(user_id)
        transactions = self._get_month_transactions(user_id, month)

        return {
            'user': user.username,
            'month': month,
            **self._calculate_totals(transactions),
            'by_category': self._group_by_category(transactions)
        }

    def _get_user(self, user_id: int) -> User:
        """è·å–ç”¨æˆ·"""
        user = self.db.get(User, user_id)
        if not user:
            raise ValueError("ç”¨æˆ·ä¸å­˜åœ¨")
        return user

    def _get_month_transactions(self, user_id: int, month: str) -> list:
        """è·å–å½“æœˆäº¤æ˜“"""
        return self.db.query(Transaction).filter(
            Transaction.user_id == user_id,
            Transaction.transaction_date.like(f"{month}%")
        ).all()

    def _calculate_totals(self, transactions: list) -> dict:
        """è®¡ç®—æ€»é¢"""
        total_income = sum(t.amount for t in transactions if t.type == 'income')
        total_expense = sum(t.amount for t in transactions if t.type == 'expense')

        return {
            'total_income': total_income,
            'total_expense': total_expense,
            'balance': total_income - total_expense
        }

    def _group_by_category(self, transactions: list) -> dict:
        """æŒ‰åˆ†ç±»åˆ†ç»„"""
        by_category = {}
        for t in transactions:
            by_category.setdefault(t.category_id, 0)
            by_category[t.category_id] += t.amount
        return by_category
```

### æ¶ˆé™¤é‡å¤ä»£ç 

```python
# âŒ é‡æ„å‰ï¼šé‡å¤çš„éªŒè¯é€»è¾‘
def create_account(db: Session, user_id: int, name: str, type: str):
    if not name or len(name) > 50:
        raise ValueError("è´¦æˆ·åæ— æ•ˆ")
    if type not in ['cash', 'bank', 'credit']:
        raise ValueError("è´¦æˆ·ç±»å‹æ— æ•ˆ")
    # ...åˆ›å»ºè´¦æˆ·

def update_account(db: Session, account_id: int, name: str, type: str):
    if not name or len(name) > 50:
        raise ValueError("è´¦æˆ·åæ— æ•ˆ")
    if type not in ['cash', 'bank', 'credit']:
        raise ValueError("è´¦æˆ·ç±»å‹æ— æ•ˆ")
    # ...æ›´æ–°è´¦æˆ·

# âœ… é‡æ„åï¼šæå–å…¬å…±éªŒè¯
class AccountValidator:
    """è´¦æˆ·éªŒè¯å™¨"""

    VALID_TYPES = {'cash', 'bank', 'credit'}

    @classmethod
    def validate_name(cls, name: str) -> str:
        """éªŒè¯è´¦æˆ·å"""
        if not name or len(name) > 50:
            raise ValueError("è´¦æˆ·åæ— æ•ˆ")
        return name.strip()

    @classmethod
    def validate_type(cls, account_type: str) -> str:
        """éªŒè¯è´¦æˆ·ç±»å‹"""
        if account_type not in cls.VALID_TYPES:
            raise ValueError(f"è´¦æˆ·ç±»å‹æ— æ•ˆï¼Œå¿…é¡»æ˜¯: {cls.VALID_TYPES}")
        return account_type

def create_account(db: Session, user_id: int, name: str, type: str):
    name = AccountValidator.validate_name(name)
    type = AccountValidator.validate_type(type)
    # ...åˆ›å»ºè´¦æˆ·
```

## ğŸ§ª å¯æµ‹è¯•ä»£ç è®¾è®¡

### ä¾èµ–æ³¨å…¥

```mermaid
flowchart LR
    subgraph HardCoded["âŒ ç¡¬ç¼–ç ä¾èµ–"]
        Code1["ä»£ç "]
        DB1[(æ•°æ®åº“)]
        Code1 -->|"ç›´æ¥ä¾èµ–"| DB1
    end

    subgraph Injected["âœ… ä¾èµ–æ³¨å…¥"]
        Code2["ä»£ç "]
        DB2[(æ•°æ®åº“)]
        Interface["æ¥å£"]
        Code2 -->|"ä¾èµ–"| Interface
        Interface -->|"å®ç°"| DB2
        Mock["Mock"] -->|"æµ‹è¯•æ—¶"| Interface
    end

    style HardCoded fill:#ffcdd2
    style Injected fill:#c8e6c9
```

```python
# âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•
class TransactionService:
    """äº¤æ˜“æœåŠ¡"""

    def __init__(
        self,
        db: Session,
        cache: Optional[CacheService] = None
    ):
        self.db = db
        self.cache = cache or CacheService()

    def get_transaction(self, transaction_id: int) -> Optional[Transaction]:
        # å…ˆæŸ¥ç¼“å­˜
        cached = self.cache.get(f"transaction:{transaction_id}")
        if cached:
            return Transaction(**cached)

        # æŸ¥æ•°æ®åº“
        transaction = self.db.get(Transaction, transaction_id)
        if transaction:
            self.cache.set(f"transaction:{transaction_id}", transaction.model_dump())

        return transaction

# æµ‹è¯•æ—¶å¯ä»¥æ³¨å…¥ Mock
def test_get_transaction():
    mock_db = Mock()
    mock_cache = Mock()

    service = TransactionService(mock_db, mock_cache)

    # é…ç½® Mock è¡Œä¸º
    mock_cache.get.return_value = None
    mock_db.get.return_value = Transaction(id=1, amount=100)

    result = service.get_transaction(1)

    assert result.amount == 100
```

## ğŸ“ ä»£ç è§„èŒƒ

### é¡¹ç›®ç»“æ„è§„èŒƒ

```
app/
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ config.py               # é…ç½®
â”œâ”€â”€ database.py             # æ•°æ®åº“é…ç½®
â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ transaction.py
â”œâ”€â”€ schemas/                # Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ transaction.py
â”œâ”€â”€ crud/                   # æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py
â”‚   â””â”€â”€ transaction.py
â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ transaction.py
â”‚   â””â”€â”€ report.py
â”œâ”€â”€ routers/                # API è·¯ç”±
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py
â”‚   â””â”€â”€ transactions.py
â”œâ”€â”€ core/                   # æ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ security.py
â”‚   â””â”€â”€ cache.py
â”œâ”€â”€ dependencies/           # ä¾èµ–é¡¹
â”‚   â”œâ”€â”€ auth.py
â”‚   â””â”€â”€ database.py
â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
    â””â”€â”€ helpers.py
```

### å‘½åè§„èŒƒ

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| æ–‡ä»¶å | å°å†™ä¸‹åˆ’çº¿ | `transaction_service.py` |
| ç±»å | å¤§é©¼å³° | `TransactionService` |
| å‡½æ•°å | å°å†™ä¸‹åˆ’çº¿ | `get_transaction_by_id` |
| å¸¸é‡ | å…¨å¤§å†™ä¸‹åˆ’çº¿ | `MAX_PAGE_SIZE` |
| å˜é‡ | å°å†™ä¸‹åˆ’çº¿ | `transaction_count` |

## ğŸ“ ç»ƒä¹ ä»»åŠ¡

1. **é‡æ„æ—§ä»£ç ** - æ‰¾å‡ºé¡¹ç›®ä¸­çš„é•¿æ–¹æ³•ï¼Œæ‹†åˆ†é‡æ„
2. **æ·»åŠ å•å…ƒæµ‹è¯•** - ä¸ºæœåŠ¡å±‚ç¼–å†™æµ‹è¯•
3. **å»ºç«‹ CI æ£€æŸ¥** - æ·»åŠ ä»£ç é£æ ¼æ£€æŸ¥

## âœ… æ£€æŸ¥ç‚¹

- [ ] ç†è§£ä»£ç é‡æ„çš„ä»·å€¼
- [ ] æŒæ¡å¸¸è§çš„é‡æ„æŠ€å·§
- [ ] ç¼–å†™å¯æµ‹è¯•çš„ä»£ç 
- [ ] å»ºç«‹é¡¹ç›®ä»£ç è§„èŒƒ

---

**ä¸‹ä¸€ç« **ï¼š[05-éƒ¨ç½²ä¸ç›‘æ§.md](./05-éƒ¨ç½²ä¸ç›‘æ§.md)
