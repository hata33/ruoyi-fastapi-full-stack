# 接口设计思维

> 好的接口设计让 API 易用、易理解、易维护。

## 接口设计的核心原则

### 1. 简单直观

```
❌ 复杂的接口设计
POST /api/doSomething
{
  "action": "createUser",
  "data": {...},
  "options": {...}
}

✅ 清晰的接口设计
POST /api/users
{
  "userName": "zhangsan",
  "email": "zhangsan@example.com"
}
```

### 2. 一致性

```
❌ 不一致的命名
GET /getUserList
POST /createUser
PUT /modifyUser
DELETE /removeUser

✅ 一致的 REST 风格
GET    /api/users
POST   /api/users
PUT    /api/users/{id}
DELETE /api/users/{id}
```

### 3. 可预测

```
用户看到接口，应该能预测：
- 用什么方法
- 传什么参数
- 返回什么数据
- 会有什么状态码
```

---

## URI 设计

### 资源命名

```
✅ 使用名词，表示资源
GET /api/users
GET /api/roles
GET /api/departments

❌ 使用动词，表示动作
GET /api/getUsers
POST /api/createUser

✅ 使用复数形式
GET /api/users

❌ 使用单数形式
GET /api/user

✅ 使用小写和连字符
GET /api/user-roles

❌ 使用驼峰或大写
GET /api/userRoles
GET /api/UserRoles
```

### 层级结构

```
# 一级资源
/api/users
/api/roles

# 二级资源（子资源）
/api/users/1/roles     # 用户1的角色
/api/users/1/orders    # 用户1的订单
/api/depts/1/users     # 部门1的用户

# 避免超过3层
❌ /api/depts/1/users/1/orders/1/items
✅ /api/order-items?user=1&order=1
```

### 特殊操作

```
# 对于非CRUD操作，使用动词子资源
POST /api/users/1/password/reset    # 重置密码
POST /api/orders/1/cancel           # 取消订单
POST /api/orders/1/confirm          # 确认订单
PUT  /api/users/1/status            # 更新状态
```

---

## HTTP 方法使用

### 方法语义

| 方法 | 语义 | 幂等 | 示例 |
|------|------|------|------|
| GET | 获取资源 | ✅ | GET /api/users |
| POST | 创建资源 | ❌ | POST /api/users |
| PUT | 完整更新 | ✅ | PUT /api/users/1 |
| PATCH | 部分更新 | ❌ | PATCH /api/users/1 |
| DELETE | 删除资源 | ✅ | DELETE /api/users/1 |

### 使用场景

```python
# GET - 查询
@userController.get("/list")
async def get_users(page: int = 1, size: int = 10):
    """查询用户列表"""
    pass

@userController.get("/{user_id}")
async def get_user(user_id: int):
    """查询用户详情"""
    pass

# POST - 创建
@userController.post("/add")
async def add_user(user: UserModel):
    """创建用户"""
    pass

# PUT - 更新
@userController.put("/edit")
async def edit_user(user: UserModel):
    """更新用户（需要提供完整数据）"""
    pass

# PATCH - 部分更新
@userController.patch("/{user_id}")
async def patch_user(user_id: int, updates: dict):
    """部分更新用户"""
    pass

# DELETE - 删除
@userController.delete("/{user_id}")
async def delete_user(user_id: int):
    """删除用户"""
    pass
```

---

## 参数设计

### 路径参数

```python
# 用于标识资源
@userController.get("/{user_id}")
async def get_user(user_id: int):
    # URL: /api/users/123
    pass

# 多个路径参数
@userController.get("/{user_id}/roles/{role_id}")
async def get_user_role(user_id: int, role_id: int):
    # URL: /api/users/123/roles/456
    pass
```

### 查询参数

```python
# 用于过滤、排序、分页
@userController.get("/list")
async def get_users(
    page: int = Query(1, description="页码"),
    size: int = Query(10, description="每页数量"),
    user_name: Optional[str] = Query(None, description="用户名"),
    status: Optional[str] = Query(None, description="状态"),
    order_by: str = Query("create_time", description="排序字段"),
    is_asc: bool = Query(True, description="是否升序")
):
    # URL: /api/users?page=1&size=10&status=0
    pass
```

### 请求体

```python
# 用于创建或更新资源
class UserModel(BaseModel):
    user_name: str = Field(..., min_length=3, max_length=30)
    email: Optional[str] = Field(None, max_length=50)
    status: str = Field(default="0")

@userController.post("/add")
async def add_user(user: UserModel):
    # Body: {"userName": "zhangsan", "email": "..."}
    pass
```

---

## 响应设计

### 统一响应格式

```python
# 项目中的统一响应
{
  "code": 200,        # 业务状态码
  "msg": "操作成功",    # 提示信息
  "data": {...}       # 返回数据
}

# 列表响应
{
  "code": 200,
  "rows": [...],      # 数据列表
  "total": 100        # 总记录数
}

# 分页响应
{
  "code": 200,
  "data": {
    "items": [...],
    "total": 100,
    "page": 1,
    "size": 10
  }
}
```

### 字段命名

```python
# 响应字段使用驼峰命名（前端友好）
{
  "userId": 1,
  "userName": "admin",
  "deptName": "技术部",
  "createTime": "2024-01-01 12:00:00"
}

# 而不是下划线命名
{
  "user_id": 1,
  "user_name": "admin"
}
```

### 数据脱敏

```python
# 敏感信息脱敏
{
  "userId": 1,
  "userName": "zhangsan",
  "phone": "138****8000",    # 手机号脱敏
  "email": "zha***@example.com",  # 邮箱脱敏
  "idCard": "110***********1234"   # 身份证脱敏
}
```

---

## 错误处理

### 错误响应格式

```python
# 业务错误
{
  "code": 500,
  "msg": "用户名已存在",
  "data": null
}

# 参数校验错误
{
  "code": 400,
  "msg": "参数校验失败",
  "data": {
    "userName": "用户名不能为空",
    "email": "邮箱格式错误"
  }
}

# 认证错误
{
  "code": 401,
  "msg": "Token已失效，请重新登录",
  "data": null
}

# 权限错误
{
  "code": 403,
  "msg": "权限不足",
  "data": null
}
```

### 错误码设计

```python
# 错误码规范
200 - 成功
400 - 参数错误
401 - 未认证
403 - 无权限
404 - 资源不存在
409 - 资源冲突
422 - 参数校验失败
500 - 服务器错误

# 业务错误码（在响应体中）
1001 - 用户名已存在
1002 - 密码错误
1003 - 账号已锁定
2001 - 角色已存在
3001 - 部门不存在
```

---

## 版本管理

### URL 版本

```
/api/v1/users
/api/v2/users

# 版本升级时的兼容性
v1: POST /api/v1/users
    Body: { "name": "zhangsan" }

v2: POST /api/v2/users
    Body: { "userName": "zhangsan", "avatar": "..." }

# 两个版本同时运行，逐步迁移
```

### 版本变更原则

```
✅ 兼容性变更：不改版本
- 添加可选字段
- 添加新的接口
- 修改响应描述

❌ 不兼容变更：升级版本
- 删除字段
- 修改字段类型
- 修改必需字段
- 修改接口语义
```

---

## 项目中的接口设计示例

### 用户管理接口

```python
# module_admin/controller/user_controller.py

userController = APIRouter(prefix='/user', tags=['用户管理'])

# 1. 查询用户列表
@userController.get("/list", summary="查询用户列表")
async def get_user_list(
    query_user: UserModel,  # 查询参数模型
    page: int = Query(1, ge=1),
    size: int = Query(10, ge=1, le=100)
):
    """
    GET /api/user/list?page=1&size=10&userName=admin

    返回：
    {
      "code": 200,
      "rows": [...],
      "total": 100
    }
    """
    pass

# 2. 查询用户详情
@userController.get("/{user_id}", summary="查询用户详情")
async def get_user_info(user_id: int):
    """
    GET /api/user/123

    返回：
    {
      "code": 200,
      "data": {...}
    }
    """
    pass

# 3. 新增用户
@userController.post("/add", summary="新增用户")
async def add_user(
    user: UserModel,
    _: bool = Depends(CheckUserInterfaceAuth("system:user:add"))
):
    """
    POST /api/user/add
    Body: {"userName": "zhangsan", ...}

    返回：
    {
      "code": 200,
      "msg": "新增成功"
    }
    """
    pass

# 4. 修改用户
@userController.put("/edit", summary="修改用户")
async def edit_user(
    user: UserModel,
    _: bool = Depends(CheckUserInterfaceAuth("system:user:edit"))
):
    """PUT /api/user/edit"""
    pass

# 5. 删除用户
@userController.delete("/{user_ids}", summary="删除用户")
async def delete_user(
    user_ids: str,
    _: bool = Depends(CheckUserInterfaceAuth("system:user:remove"))
):
    """
    DELETE /api/user/1,2,3

    支持批量删除，ID 用逗号分隔
    """
    pass

# 6. 重置密码
@userController.put("/resetPwd", summary="重置密码")
async def reset_password(
    user: UserModel,
    _: bool = Depends(CheckUserInterfaceAuth("system:user:resetPwd"))
):
    """PUT /api/user/resetPwd"""
    pass

# 7. 修改状态
@userController.put("/changeStatus", summary="修改状态")
async def change_status(
    user: UserModel,
    _: bool = Depends(CheckUserInterfaceAuth("system:user:changeStatus"))
):
    """PUT /api/user/changeStatus"""
    pass
```

---

## 接口文档

### Swagger 自动生成

```python
# FastAPI 自动生成文档

@userController.get("/list", summary="查询用户列表")
async def get_user_list(
    page: int = Query(1, description="页码", ge=1),
    size: int = Query(10, description="每页数量", ge=1, le=100)
):
    """
    查询用户列表

    - **page**: 页码，从1开始
    - **size**: 每页数量，最大100

    返回用户列表和总数
    """
    pass

# 访问文档
# http://localhost:9099/docs
```

### 接口文档应包含

```
1. 接口名称和描述
2. 请求方法和 URL
3. 请求参数（类型、是否必需、示例）
4. 请求体（结构和示例）
5. 响应格式（成功和失败）
6. 错误码说明
7. 权限要求
8. 使用示例
```

---

## 接口设计检查清单

设计接口时，请检查：

### URI 设计
- [ ] 使用名词表示资源
- [ ] 使用复数形式
- [ ] 使用小写和连字符
- [ ] 层级不超过 3 层

### HTTP 方法
- [ ] GET 用于查询
- [ ] POST 用于创建
- [ ] PUT 用于完整更新
- [ ] DELETE 用于删除
- [ ] 正确使用幂等性

### 参数设计
- [ ] 路径参数用于资源标识
- [ ] 查询参数用于过滤、排序、分页
- [ ] 请求体用于创建和更新
- [ ] 参数有类型验证和默认值

### 响应设计
- [ ] 统一的响应格式
- [ ] 合适的 HTTP 状态码
- [ ] 友好的错误信息
- [ ] 敏感数据脱敏

### 文档
- [ ] 有清晰的接口描述
- [ ] 有参数说明
- [ ] 有响应示例
- [ ] 有错误码说明

**下一步**: 学习 [性能优化思维](./03-性能优化思维.md)
