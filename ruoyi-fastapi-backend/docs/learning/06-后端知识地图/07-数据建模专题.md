# æ•°æ®å»ºæ¨¡ä¸“é¢˜

> æœ¬æ–‡æ¡£æ·±å…¥æ¢è®¨æ•°æ®å»ºæ¨¡çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¸®åŠ©ä½ ç†è§£å¦‚ä½•è®¾è®¡åˆç†çš„æ•°æ®åº“ç»“æ„ã€‚

## ä¸‰å±‚å»ºæ¨¡æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': {
  'primaryColor': '#EFF6FF',
  'primaryTextColor': '#1e3a8a',
  'primaryBorderColor': '#3B82F6',
  'lineColor': '#6B7280'
}}}%%
flowchart TB
    Start([ä¸šåŠ¡éœ€æ±‚]) ==> Concept[ğŸ’¡ æ¦‚å¿µæ¨¡å‹<br/>Conceptual Model]

    Concept ==> C1[è¯†åˆ«æ ¸å¿ƒå®ä½“]
    Concept ==> C2[å®šä¹‰å®ä½“å…³ç³»]
    Concept ==> C3[ç¡®å®šä¸šåŠ¡è§„åˆ™]

    C1 --> Logical[ğŸ“ é€»è¾‘æ¨¡å‹<br/>Logical Model]
    C2 --> Logical
    C3 --> Logical

    Logical ==> L1[è®¾è®¡å±æ€§]
    Logical ==> L2[åº”ç”¨èŒƒå¼]
    Logical ==> L3[ç»†åŒ–çº¦æŸ]

    L1 --> Physical[ğŸ’¾ ç‰©ç†æ¨¡å‹<br/>Physical Model]
    L2 --> Physical
    L3 --> Physical

    Physical ==> P1[é€‰æ‹©æ•°æ®ç±»å‹]
    Physical ==> P2[è®¾è®¡ç´¢å¼•]
    Physical ==> P3[æ·»åŠ çº¦æŸ]

    P1 --> Database[(æ•°æ®åº“è¡¨ç»“æ„)]
    P2 --> Database
    P3 --> Database

    classDef startEnd fill:#3B82F6,stroke:#2563EB,color:#fff,stroke-width:2px
    classDef phase fill:#D1FAE5,stroke:#10B981,stroke-width:2px,color:#065f46
    classDef action fill:#fff,stroke:#60A5FA,stroke-width:1px,color:#1e3a8a
    classDef database fill:#FEF3C7,stroke:#F59E0B,stroke-width:2px,color:#92400e

    class Start startEnd
    class Concept,Logical,Physical phase
    class C1,C2,C3,L1,L2,L3,P1,P2,P3 action
    class Database database
```

## å®ä½“å…³ç³»å›¾

```mermaid
%%{init: {'theme': 'base', 'themeVariables': {
  'primaryColor': '#EFF6FF',
  'primaryTextColor': '#1e3a8a',
  'primaryBorderColor': '#3B82F6',
  'lineColor': '#6B7280'
}}}%%
graph TB
    subgraph æ ¸å¿ƒå®ä½“["ğŸ“¦ æ ¸å¿ƒå®ä½“"]
        User[ğŸ‘¤ User ç”¨æˆ·]
        Order[ğŸ›’ Order è®¢å•]
        Product[ğŸ“¦ Product å•†å“]
        Category[ğŸ“‚ Category åˆ†ç±»]
        Address[ğŸ“ Address åœ°å€]
    end

    User ==>|1:N ä¸‹å•| Order
    User ==>|1:N æ‹¥æœ‰| Address
    Order ==>|N:1 å±äº| User
    Order ==>|N:M åŒ…å«| Product
    Product ==>|N:1 å½’å±| Category
    Product ==>|N:M è¢«åŒ…å«| Order

    User -.->|è‡ªå…³è”| Manager[ğŸ‘” ä¸Šçº§ç®¡ç†å‘˜]

    classDef entityStyle fill:#DBEAFE,stroke:#3B82F6,stroke-width:2px,color:#1e3a8a
    classDef relationStyle fill:#FEF3C7,stroke:#F59E0B,stroke-width:2px,color:#92400e

    class User,Order,Product,Category,Address entityStyle
    class Manager relationStyle
```

### å…³ç³»ç±»å‹è¯´æ˜

| å…³ç³»ç±»å‹ | ç¬¦å· | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|------|
| ä¸€å¯¹ä¸€ | 1:1 | ä¸€ä¸ªå®ä½“å¯¹åº”å¦ä¸€ä¸ªå®ä½“ | ç”¨æˆ· â†” è¯¦ç»†èµ„æ–™ |
| ä¸€å¯¹å¤š | 1:N | ä¸€ä¸ªå®ä½“å¯¹åº”å¤šä¸ªå®ä½“ | ç”¨æˆ· â†’ è®¢å• |
| å¤šå¯¹å¤š | M:N | å¤šä¸ªå®ä½“å¯¹åº”å¤šä¸ªå®ä½“ | è®¢å• â†â†’ å•†å“ |
| è‡ªå…³è” | 1:N | å®ä½“å¼•ç”¨è‡ªèº« | å‘˜å·¥ â†’ ä¸Šçº§ |

## æ•°æ®çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> è‰ç¨¿: åˆ›å»º
    è‰ç¨¿ --> å¾…å®¡æ ¸: æäº¤å®¡æ ¸
    å¾…å®¡æ ¸ --> å·²å‘å¸ƒ: å®¡æ ¸é€šè¿‡
    å¾…å®¡æ ¸ --> è‰ç¨¿: å®¡æ ¸æ‹’ç»
    å·²å‘å¸ƒ --> å·²ä¸‹æ¶: ä¸‹æ¶
    å·²ä¸‹æ¶ --> å·²å‘å¸ƒ: é‡æ–°ä¸Šæ¶
    å·²å‘å¸ƒ --> [*]: ç‰©ç†åˆ é™¤
    è‰ç¨¿ --> [*]: åˆ é™¤
    å¾…å®¡æ ¸ --> [*]: åˆ é™¤

    note right of è‰ç¨¿
        åªæœ‰åˆ›å»ºè€…å¯è§
        å¯ä»¥ç¼–è¾‘
    end note

    note right of å·²å‘å¸ƒ
        æ‰€æœ‰äººå¯è§
        ä¸èƒ½ä¿®æ”¹
    end note
```

## å­—æ®µè®¾è®¡è§„èŒƒ

```mermaid
mindmap
  root((å­—æ®µè®¾è®¡))
    å‘½åè§„èŒƒ
      å°å†™å­—æ¯
      ä¸‹åˆ’çº¿åˆ†éš”
      è§åçŸ¥æ„
      é¿å…ä¿ç•™å­—
    ç±»å‹é€‰æ‹©
      ç²¾ç¡®ä¼˜å…ˆ
          æ•´æ•°: INT/BIGINT
          å°æ•°: DECIMAL
      æ€§èƒ½ä¼˜å…ˆ
          å­—ç¬¦ä¸²: VARCHAR
          æ–‡æœ¬: TEXT
          æ—¥æœŸ: DATETIME
    çº¦æŸè®¾è®¡
      NOT NULL
          ä¸šåŠ¡å¿…å¡«
      DEFAULT
          é»˜è®¤å€¼
      UNIQUE
          å”¯ä¸€æ ‡è¯†
      CHECK
          ä¸šåŠ¡è§„åˆ™
    å®¡è®¡å­—æ®µ
      id
          ä¸»é”®
      create_time
          åˆ›å»ºæ—¶é—´
      update_time
          æ›´æ–°æ—¶é—´
      create_by
          åˆ›å»ºäºº
      update_by
          æ›´æ–°äºº
      del_flag
          åˆ é™¤æ ‡è®°
```

## ç´¢å¼•è®¾è®¡ç­–ç•¥

```mermaid
flowchart TB
    Start([éœ€è¦ç´¢å¼•?]) --> Q1{é¢‘ç¹æŸ¥è¯¢?}

    Q1 -->|å¦| NoIndex[ä¸åˆ›å»ºç´¢å¼•]
    Q1 -->|æ˜¯| Q2{åŒºåˆ†åº¦é«˜?}

    Q2 -->|å¦| NoIndex
    Q2 -->|æ˜¯| Q3{å­—æ®µç±»å‹?}

    Q3 -->|å­—ç¬¦ä¸²| Prefix[å‰ç¼€ç´¢å¼•]
    Q3 -->|å¤šåˆ—| Composite[å¤åˆç´¢å¼•]
    Q3 -->|å•åˆ—| Single[å•åˆ—ç´¢å¼•]

    Composite --> C1[éµå¾ªæœ€å·¦å‰ç¼€]
    Composite --> C2[é«˜é¢‘åˆ—åœ¨å‰]

    Single --> S1{å”¯ä¸€æ€§?}
    S1 -->|æ˜¯| Unique[å”¯ä¸€ç´¢å¼•]
    S1 -->|å¦| Normal[æ™®é€šç´¢å¼•]

```

### ç´¢å¼•è®¾è®¡åŸåˆ™

| åœºæ™¯ | ç´¢å¼•ç­–ç•¥ | è¯´æ˜ |
|-----|---------|------|
| ä¸»é”® | å¿…é¡»ç´¢å¼• | ä¸»é”®è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼• |
| å”¯ä¸€æ ‡è¯† | å”¯ä¸€ç´¢å¼• | å¦‚ç”¨æˆ·åã€é‚®ç®± |
| å¤–é”® | å»ºè®®ç´¢å¼• | åŠ é€Ÿå…³è”æŸ¥è¯¢ |
| é¢‘ç¹æŸ¥è¯¢ WHERE | å•åˆ—ç´¢å¼• | åŠ é€Ÿæ¡ä»¶è¿‡æ»¤ |
| å¤šåˆ—ç»„åˆæŸ¥è¯¢ | å¤åˆç´¢å¼• | æ³¨æ„æœ€å·¦å‰ç¼€ |
| æ’åº ORDER BY | ç´¢å¼• | åˆ©ç”¨ç´¢å¼•æœ‰åºæ€§ |
| å¤§æ–‡æœ¬ | ä¸ç´¢å¼• | å…¨æ–‡ç´¢å¼•è€ƒè™‘å…¶ä»–æ–¹æ¡ˆ |

## èŒƒå¼ç†è®ºä¸å®è·µ

```mermaid
graph LR
    subgraph 1NF[ç¬¬ä¸€èŒƒå¼ 1NF]
        A1[æ¶ˆé™¤é‡å¤ç»„]
        A2[åŸå­æ€§]
    end

    subgraph 2NF[ç¬¬äºŒèŒƒå¼ 2NF]
        B1[æ»¡è¶³1NF]
        B2[æ¶ˆé™¤éƒ¨åˆ†ä¾èµ–]
    end

    subgraph 3NF[ç¬¬ä¸‰èŒƒå¼ 3NF]
        C1[æ»¡è¶³2NF]
        C2[æ¶ˆé™¤ä¼ é€’ä¾èµ–]
    end

    subgraph åèŒƒå¼[åèŒƒå¼åŒ–]
        D1[æœ‰æ„è¿åèŒƒå¼]
        D2[æå‡æŸ¥è¯¢æ€§èƒ½]
    end

    1NF --> 2NF
    2NF --> 3NF
    3NF -->|æƒè¡¡| åèŒƒå¼

```

### èŒƒå¼ä¸åèŒƒå¼çš„æƒè¡¡

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|-----|---------|------|
| OLTP äº‹åŠ¡ç³»ç»Ÿ | é«˜åº¦èŒƒå¼åŒ– | å‡å°‘æ•°æ®å†—ä½™ï¼Œä¿è¯ä¸€è‡´æ€§ |
| OLAP åˆ†æç³»ç»Ÿ | é€‚åº¦åèŒƒå¼ | å‡å°‘è¡¨è¿æ¥ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ |
| è¯»å¤šå†™å°‘ | åèŒƒå¼ | ä¼˜åŒ–è¯»å–æ€§èƒ½ |
| å†™å¤šè¯»å°‘ | èŒƒå¼åŒ– | ä¿è¯å†™å…¥æ•ˆç‡å’Œæ•°æ®ä¸€è‡´æ€§ |
| æŠ¥è¡¨ç»Ÿè®¡ | åèŒƒå¼ | é¢„è®¡ç®—ï¼Œé¿å…å¤æ‚æŸ¥è¯¢ |

## å¸¸è§å»ºæ¨¡æ¨¡å¼

### 1. å®¡è®¡æ¨¡å¼

```mermaid
graph TB
    MainTable[ä¸»è¡¨] --> AuditTable[å®¡è®¡è¡¨]

    MainTable -->|ä¸šåŠ¡æ•°æ®| MainData[ä¸šåŠ¡å­—æ®µ]
    MainTable -->|å®¡è®¡å­—æ®µ| AuditFields[å®¡è®¡å­—æ®µ]

    AuditFields --> AF1[create_time]
    AuditFields --> AF2[update_time]
    AuditFields --> AF3[create_by]
    AuditFields --> AF4[update_by]

```

### 2. è½¯åˆ é™¤æ¨¡å¼

```mermaid
stateDiagram-v2
    [*] --> Active: æ’å…¥è®°å½•
    Active --> Deleted: é€»è¾‘åˆ é™¤ del_flag=1
    Deleted --> Active: æ¢å¤ del_flag=0
    Active --> [*]: ç‰©ç†åˆ é™¤(ç®¡ç†å‘˜)

    note right of Active
        æ­£å¸¸ä½¿ç”¨çŠ¶æ€
        del_flag = 0
        å¯è¢«æŸ¥è¯¢
    end note

    note right of Deleted
        å·²åˆ é™¤çŠ¶æ€
        del_flag = 1
        ä¸è¢«æ™®é€šæŸ¥è¯¢
        å¯æ¢å¤
    end note
```

### 3. å¤šæ€å…³è”æ¨¡å¼ 

```mermaid
graph LR
    Comment[è¯„è®ºè¡¨] -->|target_type| Type[ç±»å‹æ ‡è¯†]
    Comment -->|target_id| ID[ç›®æ ‡ID]

    Type --> T1[Post]
    Type --> T2[Video]
    Type --> T3[Product]

    ID --> P1[Post.ID]
    ID --> V1[Video.ID]
    ID --> PR1[Product.ID]
```

## æ•°æ®å»ºæ¨¡æ£€æŸ¥æ¸…å•

### è®¾è®¡é˜¶æ®µ

- [ ] **æ¦‚å¿µæ¨¡å‹**
  - [ ] è¯†åˆ«æ‰€æœ‰æ ¸å¿ƒå®ä½“
  - [ ] å®šä¹‰å®ä½“é—´çš„å…³ç³»
  - [ ] æ˜ç¡®ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸ

- [ ] **é€»è¾‘æ¨¡å‹**
  - [ ] ä¸ºæ¯ä¸ªå®ä½“è®¾è®¡å±æ€§
  - [ ] ç¡®å®šä¸»é”®ç­–ç•¥
  - [ ] åº”ç”¨é€‚å½“èŒƒå¼ï¼ˆé€šå¸¸3NFï¼‰

- [ ] **ç‰©ç†æ¨¡å‹**
  - [ ] é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
  - [ ] è®¾è®¡å¿…è¦çš„ç´¢å¼•
  - [ ] æ·»åŠ çº¦æŸï¼ˆNOT NULL, DEFAULTç­‰ï¼‰
  - [ ] æ·»åŠ å®¡è®¡å­—æ®µ

### éªŒè¯é˜¶æ®µ

- [ ] **åŠŸèƒ½éªŒè¯**
  - [ ] èƒ½æ»¡è¶³æ‰€æœ‰ä¸šåŠ¡éœ€æ±‚
  - [ ] æ”¯æŒæ‰€æœ‰é¢„æœŸæŸ¥è¯¢
  - [ ] çº¦æŸèƒ½é˜²æ­¢éæ³•æ•°æ®

- [ ] **æ€§èƒ½éªŒè¯**
  - [ ] å…³é”®æŸ¥è¯¢æœ‰ç´¢å¼•æ”¯æŒ
  - [ ] è¡¨è¿æ¥æ•°é‡åˆç†
  - [ ] æ•°æ®å­—æ®µå¤§å°åˆé€‚

- [ ] **æ‰©å±•æ€§éªŒè¯**
  - [ ] é¢„ç•™æ‰©å±•å­—æ®µ
  - [ ] è€ƒè™‘æœªæ¥å¯èƒ½çš„å…³è”
  - [ ] æ”¯æŒæ•°æ®åˆ†åŒºæˆ–åˆ†è¡¨

## å¸¸è§é”™è¯¯ä¸é¿å…

### é”™è¯¯ 1ï¼šè¿‡åº¦èŒƒå¼åŒ–

```mermaid
graph TB
    Bad[è¿‡åº¦èŒƒå¼åŒ–] --> Problem1[å¤§é‡è¡¨è¿æ¥]
    Bad --> Problem2[æŸ¥è¯¢æ€§èƒ½å·®]
    Bad --> Problem3[ä»£ç å¤æ‚]

    Good[é€‚åº¦èŒƒå¼] --> Solution1[åˆç†å†—ä½™]
    Good --> Solution2[æ€§èƒ½ä¼˜åŒ–]
    Good --> Solution3[ä»£ç ç®€æ´]

```

## å¸¸è§é”™è¯¯ä¸é¿å…

| é”™è¯¯ç±»å‹ | é—®é¢˜ | å»ºè®® |
|---------|-----|------|
| è¿‡åº¦èŒƒå¼åŒ– | å¤§é‡è¡¨è¿æ¥ï¼ŒæŸ¥è¯¢æ€§èƒ½å·® | OLTP ç³»ç»Ÿ 3NF è¶³å¤Ÿ |
| å¿½ç•¥æŸ¥è¯¢æ¨¡å¼ | è®¾è®¡åæ‰è€ƒè™‘æŸ¥è¯¢ | å…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼å†è®¾è®¡ |
| ç¼ºå°‘å®¡è®¡å­—æ®µ | æ— æ³•è¿½è¸ªå˜æ›´ï¼Œæ— æ³•å®šä½è´£ä»»äºº | æ‰€æœ‰ä¸šåŠ¡è¡¨åŒ…å«å®¡è®¡å­—æ®µ |
| å¿½ç•¥è½¯åˆ é™¤ | æ•°æ®æ— æ³•æ¢å¤ï¼Œç ´åå®Œæ•´æ€§ | ä½¿ç”¨ `del_flag` å®ç°è½¯åˆ é™¤

## å®æˆ˜æ¡ˆä¾‹ï¼šè®¢å•ç³»ç»Ÿè®¾è®¡

### æ ¸å¿ƒå®ä½“

```mermaid
graph TB
    User[ç”¨æˆ·]
    Order[è®¢å•]
    OrderItem[è®¢å•æ˜ç»†]
    Product[å•†å“]
    Address[æ”¶è´§åœ°å€]

    User -->|ä¸‹å•| Order
    Order -->|åŒ…å«| OrderItem
    OrderItem -->|å¼•ç”¨| Product
    Order -->|é…é€åˆ°| Address
    User -->|æ‹¥æœ‰| Address

    
    class User,Order,OrderItem,Product,Address coreStyle
```

### è¡¨ç»“æ„è®¾è®¡

#### è®¢å•è¡¨ (sys_order)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|-------|------|------|------|
| id | BIGINT | ä¸»é”® | PK, AUTO |
| order_no | VARCHAR(32) | è®¢å•å· | UNIQUE, NOT NULL |
| user_id | BIGINT | ç”¨æˆ·ID | FK, NOT NULL |
| total_amount | DECIMAL(10,2) | æ€»é‡‘é¢ | NOT NULL |
| status | TINYINT | è®¢å•çŠ¶æ€ | NOT NULL, DEFAULT 0 |
| address_id | BIGINT | æ”¶è´§åœ°å€ | FK |
| create_time | DATETIME | åˆ›å»ºæ—¶é—´ | NOT NULL |
| update_time | DATETIME | æ›´æ–°æ—¶é—´ | |

#### è®¢å•æ˜ç»†è¡¨ (sys_order_item)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|-------|------|------|------|
| id | BIGINT | ä¸»é”® | PK, AUTO |
| order_id | BIGINT | è®¢å•ID | FK, NOT NULL |
| product_id | BIGINT | å•†å“ID | FK, NOT NULL |
| quantity | INT | æ•°é‡ | NOT NULL |
| price | DECIMAL(10,2) | å•ä»· | NOT NULL |
| subtotal | DECIMAL(10,2) | å°è®¡ | NOT NULL |

### ç´¢å¼•è®¾è®¡

```sql
-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_user_id ON sys_order(user_id);
CREATE INDEX idx_create_time ON sys_order(create_time);
CREATE INDEX idx_status ON sys_order(status);

-- è®¢å•æ˜ç»†è¡¨ç´¢å¼•
CREATE INDEX idx_order_id ON sys_order_item(order_id);
CREATE INDEX idx_product_id ON sys_order_item(product_id);

-- å¤åˆç´¢å¼•ï¼ˆç”¨æˆ·è®¢å•æŸ¥è¯¢ï¼‰
CREATE INDEX idx_user_status ON sys_order(user_id, status, create_time);
```

## ç›¸å…³æ–‡æ¡£

- [03-åç«¯æ€ç»´åŸ¹å…»/01-æ•°æ®å»ºæ¨¡æ€ç»´.md](../03-åç«¯æ€ç»´åŸ¹å…»/01-æ•°æ®å»ºæ¨¡æ€ç»´.md) - æ•°æ®å»ºæ¨¡æ€ç»´è¯¦ç»†è®²è§£
- [05-å‰ç«¯å¼€å‘è€…çš„åç«¯å…¥é—¨/02-æ•°æ®å¤„ç†-æ¨¡å‹å³ä»£ç .md](../05-å‰ç«¯å¼€å‘è€…çš„åç«¯å…¥é—¨/02-æ•°æ®å¤„ç†-æ¨¡å‹å³ä»£ç .md) - ä¸‰ç§æ¨¡å‹ (DO/VO/Query)
- [12-æ•°æ®æŒä¹…åŒ–ä¸“é¢˜.md](./12-æ•°æ®æŒä¹…åŒ–ä¸“é¢˜.md) - æ•°æ®åº“æ“ä½œå’Œäº‹åŠ¡ç®¡ç†
