# 路由与请求方法

## 学习目标

- 理解路由的概念和作用
- 掌握 APIRouter 的使用
- 学习不同的 HTTP 请求方法
- 理解路径参数和查询参数
- 掌握路由分组和模块化

## 1. 路由基础

### 1.1 什么是路由？

路由（Routing）决定了应用如何响应客户端请求。在 FastAPI 中，路由定义了：
- **URL 路径**：请求的地址
- **HTTP 方法**：GET、POST、PUT、DELETE 等
- **处理函数**：处理请求的代码

### 1.2 APIRouter

**文件：** `module_admin/controller/user_controller.py:74-76`

```python
from fastapi import APIRouter, Depends

# 创建路由器
userController = APIRouter(
    prefix='/system/user',  # 路由前缀
    dependencies=[Depends(LoginService.get_current_user)]  # 全局依赖
)
```

**APIRouter 参数说明：**

| 参数 | 说明 | 示例 |
|------|------|------|
| `prefix` | 路由前缀，所有子路由都会添加此前缀 | `/system/user` |
| `tags` | API 文档分组标签 | `['用户管理']` |
| `dependencies` | 全局依赖，所有路由都执行 | `[Depends(auth)]` |
| `responses` | 额外的响应状态码 | `{404: {"description": "Not found"}}` |

**为什么使用 APIRouter？**

1. **模块化**：将相关路由组织在一起
2. **复用性**：可以挂载到多个应用
3. **维护性**：便于代码管理和团队协作

## 2. HTTP 请求方法

### 2.1 常用 HTTP 方法

```python
# 文件：module_admin/controller/user_controller.py

# GET - 获取资源
@userController.get('/list')
async def get_user_list():
    """获取用户列表"""
    pass

# POST - 创建资源
@userController.post('')
async def add_user(add_user: AddUserModel):
    """添加用户"""
    pass

# PUT - 更新资源
@userController.put('')
async def edit_user(edit_user: EditUserModel):
    """修改用户"""
    pass

# DELETE - 删除资源
@userController.delete('/{user_ids}')
async def delete_user(user_ids: str):
    """删除用户"""
    pass
```

### 2.2 完整示例：用户列表接口

**文件：** `module_admin/controller/user_controller.py:105-135`

```python
@userController.get(
    '/list',  # 路由路径（不包含 prefix）
    response_model=PageResponseModel,  # 响应模型
    dependencies=[Depends(CheckUserInterfaceAuth('system:user:list'))]  # 额外依赖
)
async def get_system_user_list(
    request: Request,
    user_page_query: UserPageQueryModel = Depends(UserPageQueryModel.as_query),
    query_db: AsyncSession = Depends(get_db),
    data_scope_sql: str = Depends(GetDataScope('SysUser')),
):
    """
    获取用户列表（分页）

    权限: system:user:list
    """
    # 调用服务层
    user_page_query_result = await UserService.get_user_list_services(
        query_db, user_page_query, data_scope_sql, is_page=True
    )

    return ResponseUtil.success(model_content=user_page_query_result)
```

**装饰器参数详解：**

```python
@userController.get(
    path='/list',                    # URL 路径
    response_model=PageResponseModel, # 响应模型（用于文档和验证）
    dependencies=[...],              # 路由级依赖
    summary='获取用户列表',            # API 文档标题
    description='详细描述...',        # API 文档描述
    tags=['用户管理'],                # API 文档分组
    status_code=200,                  # 成功状态码
    responses={404: {"model": ErrorResponse}}  # 其他状态码响应
)
```

## 3. 路径参数

### 3.1 基本路径参数

路径参数是 URL 路径的一部分，用于标识特定资源。

```python
# 文件：module_admin/controller/user_controller.py

@userController.get('/{user_id}')
async def get_user_detail(user_id: int):
    """
    获取用户详情

    参数:
        user_id: 用户 ID（从路径中获取）

    URL 示例: /system/user/123
    """
    pass
```

**类型转换：**

```python
@userController.get('/{user_id}')
async def get_user(user_id: int):
    # FastAPI 自动将字符串转换为 int
    # 如果转换失败，返回 422 错误
    return {'user_id': user_id}

# 支持的类型
@userController.get('/item/{item_id}')
async def get_item(
    item_id: int,           # 整数
    name: str,              # 字符串
    price: float,           # 浮点数
    is_active: bool         # 布尔值
):
    pass
```

### 3.2 路径参数验证

```python
from fastapi import Path

@userController.get('/{user_id}')
async def get_user(
    user_id: int = Path(
        ...,                    # 必填参数
        gt=0,                   # 大于 0
        le=10000,               # 小于等于 10000
        description='用户 ID'
    )
):
    """
    带验证的路径参数

    验证规则：
    - gt (greater than): 大于
    - ge (greater equal): 大于等于
    - lt (less than): 小于
    - le (less equal): 小于等于
    """
    return user_id
```

## 4. 查询参数

### 4.1 基本查询参数

查询参数是 URL 中 `?` 后面的参数。

```python
# URL: /system/user/list?page=1&size=10

@userController.get('/list')
async def get_user_list(
    page: int = 1,           # 默认值
    size: int = 10
):
    """
    查询参数自动从 URL 查询字符串解析

    可选参数：提供默认值
    必填参数：不提供默认值（如: page: int）
    """
    return {'page': page, 'size': size}
```

### 4.2 使用 Query 验证

```python
from fastapi import Query

@userController.get('/list')
async def get_user_list(
    page: int = Query(
        ...,                    # 必填
        gt=0,                   # 大于 0
        description='页码'
    ),
    size: int = Query(
        default=10,
        ge=1,                   # 大于等于 1
        le=100,                 # 小于等于 100
        description='每页数量'
    ),
    keyword: Optional[str] = Query(
        default=None,
        max_length=50,          # 最大长度
        description='搜索关键词'
    )
):
    """
    带验证的查询参数
    """
    pass
```

**项目中的实际应用：**

**文件：** `module_admin/controller/user_controller.py:110`

```python
# 使用 Pydantic 模型作为查询参数
user_page_query: UserPageQueryModel = Depends(UserPageQueryModel.as_query)
```

**文件：** `module_admin/entity/vo/user_vo.py`

```python
class UserPageQueryModel(BaseModel):
    """用户分页查询模型"""

    page: Optional[int] = Field(default=1, ge=1)
    page_size: Optional[int] = Field(default=10, ge=1, le=100)
    user_name: Optional[str] = Field(default=None)
    status: Optional[str] = Field(default=None)
    dept_id: Optional[int] = Field(default=None)

    @classmethod
    def as_query(cls):
        """作为查询参数使用"""
        return Depends(cls)
```

## 5. 请求体参数

### 5.1 JSON 请求体

```python
from pydantic import BaseModel

class AddUserModel(BaseModel):
    """添加用户模型"""
    user_name: str
    password: str
    email: Optional[str] = None
    role_ids: list[int]

@userController.post('')
async def add_user(add_user: AddUserModel):
    """
    POST 请求体（JSON 格式）

    FastAPI 自动：
    1. 验证 JSON 结构
    2. 转换数据类型
    3. 验证数据规则
    """
    return add_user
```

**请求示例：**

```bash
POST /system/user
Content-Type: application/json

{
  "user_name": "zhangsan",
  "password": "123456",
  "email": "zhangsan@example.com",
  "role_ids": [1, 2]
}
```

### 5.2 Form 表单数据

```python
from fastapi import Form

@userController.post('/login')
async def login(
    username: str = Form(...),
    password: str = Form(...),
    captcha: str = Form(...)
):
    """
    表单数据（application/x-www-form-urlencoded）

    适用场景：
    - 前端表单提交
    - 文件上传混合数据
    """
    pass
```

### 5.3 文件上传

```python
from fastapi import UploadFile, File

@userController.post('/upload')
async def upload_avatar(
    file: UploadFile = File(...),
    user_id: int = Form(...)
):
    """
    文件上传（multipart/form-data）

    UploadFile 属性：
    - filename: 文件名
    - content_type: MIME 类型
    - file: 文件对象
    """
    contents = await file.read()
    return {
        'filename': file.filename,
        'size': len(contents)
    }
```

## 6. 请求头和 Cookie

### 6.1 请求头参数

```python
from fastapi import Header

@userController.get('/info')
async def get_info(
    authorization: str = Header(...),  # 必填
    user_agent: Optional[str] = Header(None)
):
    """
    请求头参数

    FastAPI 自动将：
    - User-Agent → user_agent（下划线）
    - Authorization → authorization
    """
    return {
        'authorization': authorization,
        'user_agent': user_agent
    }
```

### 6.2 Cookie 参数

```python
from fastapi import Cookie

@userController.get('/preferences')
async def get_preferences(
    session_id: Optional[str] = Cookie(None),
    theme: Optional[str] = Cookie(None)
):
    """
    Cookie 参数
    """
    return {
        'session_id': session_id,
        'theme': theme
    }
```

## 7. 响应模型

### 7.1 定义响应模型

```python
from pydantic import BaseModel

class UserModel(BaseModel):
    """用户响应模型"""
    user_id: int
    user_name: str
    email: Optional[str]
    status: str

    class Config:
        from_attributes = True  # 从 ORM 模型创建

@userController.get('/{user_id}', response_model=UserModel)
async def get_user(user_id: int):
    """
    response_model 参数：
    1. 自动过滤未声明的字段
    2. 用于 API 文档生成
    3. 数据验证和转换
    """
    user = await get_user_from_db(user_id)
    return user  # 自动转换为 UserModel
```

### 7.2 响应状态码

```python
@userController.post('/', response_model=UserModel, status_code=201)
async def create_user(user: AddUserModel):
    """
    status_code=201：创建成功

    常用状态码：
    - 200: 成功
    - 201: 创建成功
    - 204: 无内容
    - 400: 请求错误
    - 404: 未找到
    - 422: 验证失败
    """
    pass
```

## 8. 依赖注入

### 8.1 Depends 基础

```python
from fastapi import Depends

async def get_db():
    """数据库会话依赖"""
    session = AsyncSessionLocal()
    try:
        yield session
    finally:
        await session.close()

@userController.get('/users')
async def get_users(db: AsyncSession = Depends(get_db)):
    """
    依赖注入自动解析

    FastAPI 会：
    1. 调用 get_db() 函数
    2. 获取返回的 session
    3. 传递给 get_users 函数
    """
    users = await db.execute(select(User))
    return users
```

### 8.2 类作为依赖

```python
class UserService:
    def __init__(self, db: AsyncSession = Depends(get_db)):
        self.db = db

    async def get_users(self):
        pass

@userController.get('/users')
async def get_users(
    service: UserService = Depends(UserService)
):
    """
    UserService 类会被实例化
    构造函数中的依赖也会被解析
    """
    return await service.get_users()
```

## 9. 路由分组与挂载

### 9.1 在主应用中挂载路由

**文件：** `server.py:154-181`

```python
from fastapi import FastAPI
from module_admin.controller.user_controller import userController
from module_admin.controller.role_controller import roleController

# 创建应用
app = FastAPI()

# 定义控制器列表
controller_list = [
    {'router': userController, 'tags': ['用户管理']},
    {'router': roleController, 'tags': ['角色管理']},
    # ... 更多控制器
]

# 循环注册路由
for controller in controller_list:
    app.include_router(
        controller['router'],
        tags=controller['tags'],
        prefix='/api'  # 可以再添加前缀
    )
```

**实际路径：**

- `userController` 的 prefix 是 `/system/user`
- 主应用添加的 prefix 是 `/api`
- 最终路径：`/api/system/user/list`

### 9.2 路由顺序

路由按照定义顺序匹配：

```python
@userController.get('/users/me')  # 特定路由放前面
async def get_current_user():
    pass

@userController.get('/users/{user_id}')  # 通用路由放后面
async def get_user(user_id: int):
    pass
```

## 10. 综合示例：完整的 CRUD

```python
from fastapi import APIRouter, Depends, Query
from typing import Optional

router = APIRouter(prefix='/api/users', tags=['用户管理'])

# 查询列表
@router.get('/')
async def list_users(
    page: int = Query(1, ge=1),
    size: int = Query(10, ge=1, le=100),
    keyword: Optional[str] = None
):
    pass

# 查询详情
@router.get('/{user_id}')
async def get_user(user_id: int):
    pass

# 创建
@router.post('/')
async def create_user(user: AddUserModel):
    pass

# 更新
@router.put('/{user_id}')
async def update_user(user_id: int, user: EditUserModel):
    pass

# 删除
@router.delete('/{user_id}')
async def delete_user(user_id: int):
    pass
```

## 11. 总结

### 11.1 路由定义要素

| 要素 | 说明 | 示例 |
|------|------|------|
| **路径** | URL 地址 | `/users/{user_id}` |
| **方法** | HTTP 动词 | `@router.get()` |
| **参数** | 请求参数 | `user_id: int` |
| **响应** | 返回数据 | `response_model=UserModel` |
| **依赖** | 注入的依赖 | `Depends(get_db)` |

### 11.2 参数类型总结

| 参数类型 | 位置 | 示例 |
|---------|------|------|
| **路径参数** | URL 路径中 | `/users/123` |
| **查询参数** | URL `?` 后 | `?page=1&size=10` |
| **请求体** | JSON 请求体 | `{"name": "张三"}` |
| **Form 表单** | 表单数据 | `application/x-www-form-urlencoded` |
| **文件** | multipart/form-data | 文件上传 |
| **Header** | 请求头 | `Authorization: Bearer xxx` |
| **Cookie** | Cookie | `session_id=xxx` |

### 11.3 最佳实践

1. **路由前缀**
   ```python
   router = APIRouter(prefix='/api/users')
   ```

2. **API 文档分组**
   ```python
   tags=['用户管理']
   ```

3. **响应模型**
   ```python
   response_model=UserModel
   ```

4. **依赖注入**
   ```python
   db: AsyncSession = Depends(get_db)
   ```

5. **参数验证**
   ```python
   user_id: int = Path(..., gt=0)
   ```

## 12. 练习

1. 创建一个简单的 CRUD API
2. 定义路径参数和查询参数
3. 使用 Pydantic 模型验证请求体
4. 定义响应模型
5. 使用依赖注入获取数据库会话

## 13. 下一步

完成本节学习后，继续学习：
- **[03-请求参数与验证](./03-请求参数与验证.md)** - 深入学习参数验证
