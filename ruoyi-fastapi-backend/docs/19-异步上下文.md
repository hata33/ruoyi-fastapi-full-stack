## What（是什么）

### 异步上下文（Async Context）是什么？

异步上下文是 Python 中基于 `contextvars` 模块实现的一种机制，用于在异步环境中管理变量的作用域和生命周期。

```python
# ctx.py 中的核心定义
CTX_REQUEST_ID: contextvars.ContextVar[str] = contextvars.ContextVar('request-id', default='')
```

### `yield Span(scope)` 的作用：

这个语法**不是直接清理异步上下文**，而是：
1. **进入时**：创建并返回 Span 对象
2. **退出时**：自动执行清理逻辑（如果有的话）

```python
@asynccontextmanager
async def get_current_span(scope: Scope):
    yield Span(scope)  # 进入上下文时返回 Span 对象
    # 当 with 语句结束时，这里会自动执行清理代码（如果有）
```

## Why（为什么需要）

### 解决异步环境中的变量隔离问题：

```python
# 问题场景：多个并发请求
async def handle_request_1():
    TraceCtx.set_id()  # 设置ID为 "req-1"
    await some_async_operation()
    print(TraceCtx.get_id())  # 应该是 "req-1"

async def handle_request_2():
    TraceCtx.set_id()  # 设置ID为 "req-2"
    await some_async_operation()
    print(TraceCtx.get_id())  # 应该是 "req-2"

# 如果没有上下文隔离，两个请求可能互相影响
```

### contextvars 的作用：

```python
# 每个异步任务都有自己独立的上下文变量副本
CTX_REQUEST_ID.set("req-1")  # 在任务1中设置
CTX_REQUEST_ID.set("req-2")  # 在任务2中设置，不影响任务1
```

## How（如何工作）

### 完整的生命周期管理：

```
请求1开始 → 创建上下文 → 设置ID=req-1 → 处理业务 → 获取ID=req-1 → 请求结束 → 上下文自动清理
请求2开始 → 创建上下文 → 设置ID=req-2 → 处理业务 → 获取ID=req-2 → 请求结束 → 上下文自动清理
```

### 代码执行流程：

```python
# 1. 请求进入中间件
async def __call__(self, scope, receive, send):
    # 2. 进入异步上下文管理器
    async with get_current_span(scope) as span:  # ← 创建新的上下文
        # 3. 在这个上下文中处理请求
        await span.request_before()  # ← 在此上下文中设置ID
        # ... 处理逻辑 ...
        await span.response(message)  # ← 在此上下文中获取ID
        
    # 4. 退出 with 语句时，上下文自动清理
    #    CTX_REQUEST_ID 的值会恢复到进入前的状态
```

### 上下文变量的生命周期：

```python
# contextvars 的工作原理
import contextvars

var = contextvars.ContextVar('test', default='default')

async def task1():
    var.set('value1')  # 只影响当前任务的上下文
    print(var.get())   # 输出: value1

async def task2():
    var.set('value2')  # 只影响当前任务的上下文
    print(var.get())   # 输出: value2
    # 当任务结束时，这个设置会自动"消失"
```

### 实际清理机制：

当异步上下文结束时：
1. **上下文变量不会被删除**，而是恢复到进入上下文之前的状态
2. **如果之前没有设置值**，则恢复为默认值（这里是空字符串）

```python
# ctx.py 中的 CTX_REQUEST_ID 定义
CTX_REQUEST_ID: contextvars.ContextVar[str] = contextvars.ContextVar('request-id', default='')

# 请求结束后，CTX_REQUEST_ID.get() 会返回空字符串（默认值）
```

所以，异步上下文提供的是**变量作用域隔离**，而不是真正的"清理"，它确保了每个请求都有自己独立的变量空间，互不干扰。