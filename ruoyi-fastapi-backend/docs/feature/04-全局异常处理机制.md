## 全局异常处理机制

本文总结项目后端的全局异常处理机制，涵盖注册入口、异常类型与返回结构、日志策略以及扩展方式。

### 1. 注册入口

- 入口函数：`exceptions/handle.py` 中的 `handle_exception(app: FastAPI)`。
- 调用时机：应用启动时注册，将项目内常见业务异常与 HTTP 标准异常统一拦截并返回规范化 JSON 响应。

### 2. 统一返回结构

所有异常最终收敛为统一结构，便于前端/调用方稳定解析：

```json
{"code": number, "msg": string, "data": any}
```

- 对于 `HTTPException`：保持原始 `status_code`，并将 `detail` 映射为 `msg`。
- 对于业务异常：通常为 200 HTTP 状态，配合业务码表达失败语义（由 `ResponseUtil` 统一封装）。

### 3. 异常类型与处理策略

- `AuthException`（鉴权/Token 问题）
  - 响应：未授权（401 语义）
  - 返回：`ResponseUtil.unauthorized(data, msg)`

- `LoginException`（登录流程问题）
  - 响应：业务失败语义
  - 返回：`ResponseUtil.failure(data, msg)`

- `ModelValidatorException`（模型/状态不合法）
  - 日志：warning
  - 返回：`ResponseUtil.failure(data, msg)`

- `FieldValidationError`（字段级参数校验失败，pydantic_validation_decorator）
  - 日志：warning
  - 返回：`ResponseUtil.failure(msg)`（不透传 data）

- `PermissionException`（权限不足，RBAC/ABAC）
  - 响应：禁止访问（403 语义）
  - 返回：`ResponseUtil.forbidden(data, msg)`

- `ServiceException`（服务执行错误，可预期但需关注）
  - 日志：error
  - 返回：`ResponseUtil.error(data, msg)`

- `ServiceWarning`（非致命性警告）
  - 日志：warning
  - 返回：`ResponseUtil.failure(data, msg)`

- `HTTPException`（FastAPI/Starlette 标准 HTTP 错误）
  - 行为：保持 `status_code`，返回 `{code: status_code, msg: detail}`

- 兜底 `Exception`（未预期异常）
  - 日志：exception（含堆栈）
  - 返回：`ResponseUtil.error(msg=str(exc))`（隐藏实现细节）

### 4. 日志策略

- 校验/权限类问题：warning（`PermissionException`、`FieldValidationError`、`ModelValidatorException`）。
- 服务错误：error（`ServiceException`）。
- 未预期异常：exception（带堆栈，便于快速定位）。

### 5. 与切面/注解的协作

- 切面（Aspect）或注解增强过程中抛出的业务异常，将由此机制统一捕获并转换为标准响应。
- 参数校验失败（字段级/模型级）同样统一为业务失败语义，前端可用同一套提示逻辑处理。

### 6. 扩展方式（如何新增自定义异常）

1) 在业务层定义新的异常类型（可继承项目已有基类异常）。
2) 在 `handle_exception(app)` 内新增对应的 `@app.exception_handler(YourException)` 处理器：

```python
@app.exception_handler(YourException)
async def your_exception_handler(request: Request, exc: YourException):
    # 视严重性选择 logger.warning / logger.error
    return ResponseUtil.failure(data=exc.data, msg=exc.message)
```

3) 按需选择 `ResponseUtil.unauthorized / forbidden / failure / error` 等封装，统一返回结构与语义。

### 7. 小结

通过集中注册的全局异常处理机制：
- 保证后端返回结构一致、可观测性更强（分级日志）。
- 解耦业务代码中的 try/except，简化控制器与服务层逻辑。
- 与切面、注解、参数校验协同工作，形成稳定、可扩展的错误处理闭环。


